@model IFMIS.Areas.IFMISTZ.Models.FundDistributionSummaryVM

@{
    ViewBag.Title = "FundCompDistribution";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    .search-btn {
        border: 1px dashed #ccc;
        border-radius: 4px;
        padding: 5px;
        padding-right: 10px;
    }

    .submit-btn {
        background-color: white;
        color: black;
        border: 1px solid #538AC5;
        border-radius: 12px;
        padding: 3px;
        padding-right: 10px;
    }

    .searchContainer {
        display: inline-flex;
        flex: 1 1 300px;
        position: relative;
        border: 1px solid #ccc;
        border-radius: 5px;
        overflow: hidden;
    }

    .searchIcon {
        padding: 0.5rem;
    }

    .searchBox {
        border: 0;
        /*padding: 0.5rem 0.5rem 0.5rem 0;*/
        padding: 8px;
        flex: 1;
    }

    .searchButton {
        background: #538AC5;
        border: 0;
        color: white;
        /*padding: 0.5rem;*/
        padding: 8px;
        border-radius: 0;
    }

    input[type=text] {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        resize: vertical;
    }

    input[type=search] {
        padding: 4px;
        border: hidden;
        border-radius: 4px;
    }

    .action-btn {
        width: 100px;
        border-radius: 10px;
    }

    .info-box {
        padding: 10px;
        background-color: #ECF3F8;
        text-align: center;
        border: 1px solid #ccc;
        border-radius: 5px;
    }


    .modal-header {
        padding: 9px 15px;
        border-bottom: 1px solid #eee;
        background-color: #0480be;
        -webkit-border-top-left-radius: 5px;
        -webkit-border-top-right-radius: 5px;
        -moz-border-radius-topleft: 5px;
        -moz-border-radius-topright: 5px;
        border-top-left-radius: 5px;
        border-top-right-radius: 5px;
    }

    .alert-secondary {
        background-color: lightgrey;
        color: black;
    }
</style>
<!-- MAIN CONTENT -->
<div id="content">
    <div id="divLoader"></div>
    <div class="row">
        <!-- widget grid -->
        <!-- NEW WIDGET START -->
        <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12" style="margin-left:-13px">

            <section id="widget-grid" class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="row">
                    <div class="jarviswidget" id="wid-id-0" data-widget-colorbutton="false" data-widget-editbutton="false" data-widget-custombutton="false" data-widget-deletebutton="false" data-widget-togglebutton="false">

                        <header>
                            <span class="widget-icon"> <i class="fa fa-table"></i> </span>
                            <h2>Fund Allocation </h2>
                        </header>

                        <div>
                            <div class="widget-body " style="padding-top:10px">


                                <form action="@Url.Action("DepartmentAllocation", "FundAllocations")" method="post" id="create-bill-form" class="form-horizontal">
                                    @Html.AntiForgeryToken()
                                    <fieldset>
                                        <div class="form-group">
                                            <label class="col-md-2 control-label">
                                                Distribution Reference
                                                <i class="fa fa-asterisk" style="color:white" id="errorReference"></i>
                                            </label>
                                            <div class="col-md-3">
                                                @Html.TextBoxFor(model => model.FundingRefNo, new { @class = "form-control", @placeholder = "Search Distribution Reference No." })
                                            </div>

                                            <label class="col-md-2 control-label">
                                                Fund Reference
                                                <i class="fa fa-asterisk" style="color:white" id="errorFundReference"></i>
                                            </label>
                                            <div class="col-md-5">
                                                <input type="text" id="fundRef" readonly="readonly" class="form-control" name="fundRef" />
                                                <input type="text" id="distributionfinancialYear" readonly="readonly" class="form-control" name="distributionfinancialYear" />
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="col-md-2 control-label">
                                                Fund Type
                                                <i class="fa fa-asterisk" style="color:white" id="errorFundType"></i>
                                            </label>
                                            <div class="col-md-3">
                                                <input type="text" id="fundType" readonly="readonly" class="form-control" name="fundType" />
                                            </div>
                                            <label class="col-md-2 control-label">
                                                Budget Class
                                                <i class="fa fa-asterisk" style="color:white" id="errorBudget"></i>
                                            </label>
                                            <div class="col-md-5">
                                                <input type="text" id="budgetClass" readonly="readonly" class="form-control" name="budgetClass" />
                                                <input type="text" id="subBudgetClass" readonly="readonly" class="form-control" name="subBudgetClass" />
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="col-md-2 control-label">
                                                Distributed Amount
                                                <i class="fa fa-asterisk" style="color:white" id="errorIssuedAmount"></i>
                                            </label>
                                            <div class="col-md-3">
                                                <input type="text" required="required" id="distributedAmount" readonly="readonly" class="form-control" name="distributedAmount" />
                                            </div>
                                            <label class="col-md-2 control-label">
                                                Department
                                                <i class="fa fa-asterisk" style="color:white" id="errorDepartment"></i>
                                            </label>
                                            <div class="col-md-5">
                                                <input type="text" id="department" readonly="readonly" class="form-control" name="department" />
                                                <input type="hidden" id="departmentCode" readonly="readonly" class="form-control" name="departmentCode" />
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="col-md-2 control-label">
                                                Distribution Description
                                                <i class="fa fa-asterisk" style="color:white" id="errorDescription"></i>
                                            </label>
                                            <div class="col-md-3">
                                                <textarea class="form-control" readonly="readonly" id="Description" name="Description"></textarea>
                                            </div>

                                            <label class="col-md-2 control-label">
                                                Componet
                                                <i class="fa fa-asterisk" style="color:white" id="errorComponet"></i>
                                            </label>
                                            <div class="col-md-5">
                                                <textarea class="form-control" id="Component" readonly="readonly" name="Component"></textarea>
                                            </div>
                                        </div>
                                        @*<div class="form-group">
                                            <label class="col-md-2 control-label">
                                                Apply Date
                                                <i class="fa fa-asterisk" style="color:white" id="errorApplyDate"></i>
                                            </label>
                                            <div class="col-md-3">
                                                <div class="flatpickr date-group">
                                                    <input type="text" name="ApplyDate" placeholder="Select Date.." class="form-control"
                                                           data-input
                                                           style="width:290px;padding-left:10px;border:1px solid #ECF3F8"
                                                           autocomplete="off" id="ApplyDate" />
                                                </div>
                                            </div>
                                            <label class="col-md-2 control-label">

                                                <i class="fa fa-asterisk" style="color:white" id="errorDepartment"></i>
                                            </label>
                                            <div class="col-md-5">
                                            </div>
                                        </div>*@
                                        <div class="form-group">
                                            <label class="col-md-2 control-label"> GL Items</label>
                                            <div class="col-md-3">
                                                <a class="search-btn" onclick="SearchGl()" href="#" style="display:block;width:309px">
                                                    <i class="fa fa-search searchIcon"></i>
                                                    Search...
                                                </a>
                                            </div>
                                            <input type="hidden" id="overdraftTotalAmount" readonly="readonly" name="OverDraftTotalAmount" />

                                            @if (ViewBag.embassy == 1)
                                            {
                                                <label class="col-md-2 control-label"> Embassy Allocation </label>
                                                <div class="col-md-3">
                                                    <input type="checkbox" id="embassy" style="float:left;width:20px;height:20px" readonly="readonly" class="checkEmbassy" name="EmbassyAllocation" />

                                                </div>
                                                <input type="hidden" id="journalTypeCode" readonly="readonly" name="JournalTypeCode" />
                                            }
                                            else
                                            {
                                                if (ViewBag.institutionlevel == 1)
                                                {
                                                    <label class="col-md-2 control-label"> ST Allocation </label>
                                                    <div class="col-md-3">
                                                        <input type="checkbox" id="ilevel" style="float:left;width:20px;height:20px" readonly="readonly" class="checkST" name="STAllocation" />

                                                    </div>
                                                    <input type="hidden" id="ilevel2" value="@ViewBag.institutionlevel" readonly="readonly" name="departmentCode" />
                                                }
                                            }

                                            @if (ViewBag.balozi == 1)
                                            {
                                                <input type="hidden" id="balozi" value="embassy" readonly="readonly" name="balozi" />
                                                <input type="hidden" id="balozidraft" value="@ViewBag.alloweddraft" readonly="readonly" name="balozidraft" />
                                            }
                                            else
                                            {
                                                <input type="hidden" id="balozi" value="notembassy" readonly="readonly" name="balozi" />
                                                <input type="hidden" id="balozidraft" value="0.00" readonly="readonly" name="balozidraft" />
                                            }
                                        </div>

                                        <div class="form-group" id="stzAllocation" style="display:none">
                                            <label class="col-md-2 control-label"> Institution </label>
                                            <div class="col-md-3">
                                                <select id="STInstitutionCode" class="form-control">
                                                    <option> Select Institution </option>
                                                    @foreach (var item in ViewBag.institutionz)
                                                    {
                                                        <option value="@item.Value"> @item.Value -  @item.Text </option>
                                                    }
                                                </select>
                                            </div>


                                            <label class="col-md-2 control-label"> Sub Warrant </label>
                                            <div class="col-md-5">
                                                <select id="Subwarrantz" class="form-control">
                                                    <option> </option>
                                                </select>
                                            </div>
                                        </div>



                                        <table id="dt_voucher_detail" class="table table-striped table-bordered table-hover table-condensed" width="100%"></table>



                                        @*<div style="padding-top:5px">
                                                <table id="dt_voucher_detail" class="table table-striped table-bordered
                                                       table-hover table-condensed" width="100%"></table>
                                                <div style="padding-bottom:10px" id="infoPanel">
                                                    <div class="info-box">No GL Items Selected</div>
                                                </div>
                                            </div>
                                            <!-- end widget content -->
                                            <div style="float:right;padding-bottom:10px">
                                                <strong>TOTAL AMOUNT (<strong id="currency2">TZS</strong>): </strong>
                                                <strong id="total_amount">0.00</strong>
                                            </div>
                                        *@

                                    </fieldset>
                                    <div class="form-actions">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="col-md-2">
                                                </div>
                                                <div class="col-md-10">
                                                    <a href="@Request.UrlReferrer" style="margin-right:5px" type="submit" class="btn btn-info pull-left"><i class="glyphicon glyphicon-arrow-left"></i> Back  </a>
                                                    &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                                                    <button class="btn btn-info" id="form_submision" type="button" style="float: left">
                                                        <i class="fa fa-save"></i>
                                                        Save
                                                    </button>
                                                </div>
                                            </div>


                                        </div>
                                    </div>
                                </form>
                            </div>
                            <!-- end widget content -->

                        </div>
                        <!-- end widget div -->

                    </div>
                </div>
            </section>

        </article>
        <!-- WIDGET END -->


    </div>

</div>

<!----------- Search GL Items ----------------->
<div class="modal fade" id="glItemsModal" style="left:4%">

    <div class="modal-dialog" style="width:80%;">
        <div class="modal-content panel-info">
            <div class="modal-header panel-heading">
                <a href="#" class="close" data-dismiss="modal">&times;</a>
                <h3 class="modal-title"> Search Gl Item</h3>
            </div>
            <div class="modal-body">
                <table>
                    <tr>
                        <td style="white-space:nowrap">Fund Reference</td>
                        <td style="padding:5px">Fund Balance</td>
                        <td style="padding:5px">Total Line Amount</td>
                        <td style="padding:5px">Difference</td>
                        <td>Total Over Draft</td>
                    </tr>
                    <tr>
                        <td style="white-space:nowrap;">
                            <input type="text" disabled id="reference">
                        </td>

                        <td style="padding:5px">
                            <input type="text" disabled id="total_voucher_amount">
                        </td>


                        <td style="padding:5px">
                            <input value="0" type="text" disabled id="total_line_amount">
                        </td>


                        <td style="padding:5px">
                            <input value="0" type="text" disabled id="difference" style="width:250px">
                        </td>

                        <td style="padding:5px">
                            <input value="0" type="text" disabled id="total_line_overdraft">
                        </td>

                    </tr>
                </table>
                <div>
                    <div class="row" style="padding-top:1%;padding-bottom:1%">
                        <div class="col-md-6">
                        </div>
                        <div class="col-md-6">
                            <div class="search-container submit-btn" style="float:right">
                                <i class="fa fa-search search-icon"></i>
                                <input type="search" name="search" placeholder="Search..." id="searchbox2">
                            </div>
                        </div>
                    </div>
                    <table id="dt_search_gl_item" class="table table-striped table-bordered table-hover table-condensed" width="100%">
                        <thead>
                            <tr>
                                <th>
                                    #
                                </th>
                                <th>Expenditure Line Item</th>
                                <th>
                                    Description.
                                </th>

                                <th>
                                    Budget Balance
                                </th>

                                <th>

                                </th>
                            </tr>
                        </thead>
                    </table>

                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-info" id="btn_save_gl_items">
                        <i class="fa fa-save"></i>Save
                    </button>
                    <button class="btn btn-info" data-dismiss="modal">
                        <i class="fa  fa-times"></i>Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="responseModal" tabindex="-1" role="dialog" aria-labelledby="lblmodal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header alert alert-info" style="font:bold 16px Trebuchet MS, Lucida Sans Unicode, Lucida Grande, Lucida Sans, Arial, sans-serif">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>

                <h4 class="modal-title" id="lblmodal">Message</h4>
            </div>
            <div class="modal-body">
                <p class="success-message">Successfully Allocated </p>
            </div>
            <div class="modal-footer">
                @*<button class="btn btn-info delete-confirm">Ok</button>*@
                <button class="btn btn-info delete-cancel" data-dismiss="modal">Ok</button>
            </div>
        </div>
    </div>
</div>


@section pagespecific{
    <script>

        $(document).ready(function () {

            $(document).ready(function () {
                $("#dt_search_gl_item_wrapper .dt-toolbar").remove();

                $("#dt_voucher_detail_wrapper .dt-toolbar").remove();
                $("#dt_voucher_detail_wrapper .dt-toolbar-footer").remove();
            });
            var url = "GetDistributionReference";

            $("#FundingRefNo").select2({
                minimumInputLength: 2,  // minimumInputLength for sending ajax request to server
                width: 'resolve',   // to adjust proper width of select2 wrapped elements
                ajax: {
                    url: url, // Controller - Select2Demo and Action -AccessRemoteData
                    type: "POST",
                    dataType: 'json',
                    data: function (referenceNo) {
                        return {
                            referenceNo: referenceNo
                        };
                    },
                    results: function (data, page) {
                        return { results: data.references }; // data.CountryList returning json data from Controlle
                    }
                }
            });
        });

        $("#FundingRefNo").change(function () {
            debugger;
            var distributionReferenceNo = $(this).val();
            // var budgetclass = $(this).val();
            var url = "GetDistribution/?distributionRef=" + distributionReferenceNo;

            $.ajax({
                type: "POST",
                url: url,
                contentType: "html",
                success: function (response) {
                    if (response[0] == "Success") {
                        $("#fundRef").val(response[1]);
                        $("#fundType").val(response[2]);
                        $("#budgetClass").val(response[3]);
                        $("#Component").val(response[9]);
                        $("#distributedAmount").val(response[11]);
                        $("#Description").val(response[4]);
                        $("#department").val(response[5]);
                        $("#departmentCode").val(response[10]);
                        $("#fundSource").val(response[7]);
                        $("#subBudgetClass").val(response[8]);
                        $("#distributionfinancialYear").val(response[12]);
                    }
                    else if (response[0] == "DbException") {
                        alert("An error has occured, contact system support" + response[1]);
                        $("#divLoader").hide();
                    }
                    $("#distributedAmount").autoNumeric({ aNeg: "-" }).trigger("change");
                },
            });
            ///updateSearchGITable($("subBudgetClass").val());
        });


        // =========== START VOUCHER DETAILS ===============
        var dt_voucher_detail = $('#dt_voucher_detail').dataTable({
            "data": [],
            "columns": [
                { title: "Expenditure Line Item" },
                { title: "Item Description" },
                { title: "Budget Balance" },
                { title: "Allocated Amount" }
            ]
        });

        // =========== END VOUCHER DETAILS ====================


        ///========== SEARCH GL =====
        var responsiveHelper_dt_search_gl_item = undefined;
        var dt_search_gl_item = $('#dt_search_gl_item').dataTable({
            "language": {
                "emptyTable": '<strong id="loader" style="color:green">No matching records found</strong>',
                "zeroRecords": "No matching records found"
            },
        });

        $("#searchbox2").on("keyup search input paste cut", function () {
            dt_search_gl_item.DataTable().search(this.value).draw();
        });
        var SubBudgetClassOld = $("#SubBudgetClass").val();



        function updateSearchGITable(subBudgetClass) {
            $("#loader").text("Loading Please Wait...")
            debugger;
            var subvote = $("#departmentCode").val();
            var distributionfinancialYear = $("#distributionfinancialYear").val();
            //if (applydate == "" || applydate == null) {
            //    swal("Please Select Apply Date", { icon: "warning" });
            //}
            //else {
          
            var url = '@Url.Action("GetBudgetBalance", "FundAllocations")';
            var fundBalanceParams = { "subBudgetClass": subBudgetClass, "subVote": subvote, "applyFinancialYear": distributionfinancialYear };

            //$("#currency").text(subBudgetClassList[1].trim());
            //$("#currency2").text(subBudgetClassList[1].trim());
            $.ajax({
                type: "get",
                url: url,
                data: fundBalanceParams,
                contenttype: "application/json; charset=utf-8",
                datatype: "json",
                success: function (response) {

                    data = response.data;
                    dt_search_gl_item.fnClearTable();
                    for (var i = 0; i < data.length; i++) {
                        var emb = data[i]["FundingRefNo"];
                        //var embassy = emb.substring(0, 7);
                        dt_search_gl_item.fnAddData([i,
                            data[i]["GlAccount"].split("|").join("-"),
                            data[i]["GlAccountDesc"],
                            toLabel(data[i]["BudgetBalance"]),
                            '<amount-input type="text" placeholder="Amount" id="Id-' + i + '" onkeyup="amountChanged(' + i + ')"/>'
                        ]);
                    }

                },
                failure: function (error) {
                    swal(error);
                }

            });
        //}
            
        }

        var TotalAmountOld = $("#total_voucher_amount").val();
        function clearVochaDetailsTable() {
            var _data = dt_voucher_detail.DataTable().rows().data();

            if (_data.length > 0) {
                confirmTotalAmountChange(TotalAmountOld, $("#total_voucher_amount").val());
            }
            TotalAmountOld = $("#total_voucher_amount").val();
        }


        function resetVochaDetailsTable() {
            $("#total_amount").text("0.00");
            dt_voucher_detail.fnClearTable();
        }

        function SearchGl() {
            debugger;
            var subBudgetClass = $("#subBudgetClass").val();
            //var applydate = $("#ApplyDate").val();
            //if (applydate == null || applydate == "") {
            //    swal("Please Select Apply Date", { icon: "warning" });
            //}
            //else {
                updateSearchGITable(subBudgetClass);
                $('#glItemsModal').modal('show');
                $('#total_voucher_amount').val($('#distributedAmount').val());
                $('#reference').val($('#fundRef').val());
                computeTotalAmount();
            //}

        }
        /////// ==== END OF SEARCH GL ==============

        //==== START OF ADD GL Items to Voucher Details ======
        function remove(array, val) {
            var found = array.indexOf(val);
            while (found !== -1) {
                array.splice(found, 1);
                found = array.indexOf(val);
            }
        }

        var form_data_status = [];
        var all_amounts = {};
        var all_overdraft = {};
        function amountChanged(i) {
            debugger;
            var data = dt_search_gl_item.DataTable().rows().data();
            var row = data.rows(i).data()[0]
            var original_amount = toNumber(row[3]);
            var entered_amount = toNumber($("#_Id-" + i).val());
            all_amounts["Id-" + i] = toNumber($("#_Id-" + i).val());
            var balance = original_amount - entered_amount;

            var embassyItem = $("#balozi").val();
            var allowedoverdraft = $("#balozidraft").val();

            if (embassyItem == "notembassy") {
                if (balance < 0) {
                    form_data_status.push(i);
                    $("#_Id-" + i).css({ 'color': 'red' });
                    $("#btn_save_gl_items").attr("disabled", true);
                } else {
                    $("#_Id-" + i).css({ 'color': 'black' });
                    $("#btn_save_gl_items").attr("disabled", false);
                    remove(form_data_status, i);
                    computeTotalAmount();
                }
            }


            if (embassyItem == "embassy") {
                if (original_amount < entered_amount) {
                    form_data_status.push(i);
                    var overamount = entered_amount - original_amount;
                    all_overdraft["Id-" + i] = toNumber(overamount);
                }
                else {
                    all_overdraft["Id-" + i] = toNumber(0);
                }
            }


            if (embassyItem == "embassy") {
                    if (balance < 0 && allowedoverdraft == 0) {
                        form_data_status.push(i);
                        $("#_Id-" + i).css({ 'color': 'red' });
                        $("#btn_save_gl_items").attr("disabled", true);
                    } else {
                        $("#_Id-" + i).css({ 'color': 'black' });
                        $("#btn_save_gl_items").attr("disabled", false);
                        remove(form_data_status, i);
                        computeTotalAmount();
                    }
                    //$("#_Id-" + i).css({ 'color': 'black' });
                    //$("#btn_save_gl_items").attr("disabled", false);
                    //remove(form_data_status, i);
                    //computeTotalAmount();
            }
        }

        function computeTotalAmount() {
            debugger;
            var total_amount = 0;
            var total_overdraft = 0;
            var difference = 0;
            var amount = "";
            var overdraftamount = "";
            var data = dt_search_gl_item.DataTable().rows().data();
            var obj = [];

            for (var i = 0; i < data.length; i++) {
                var amount = all_amounts["Id-" + i];
                var overdraftamount = all_overdraft["Id-" + i];

                if (amount == undefined) {
                    amount = "";
                }
                if (overdraftamount == undefined) {
                    overdraftamount = "";
                }
                if (amount) {
                    total_amount = toNumber(total_amount) + toNumber(amount);
                }

                if (overdraftamount) {
                    total_overdraft = toNumber(total_overdraft) + toNumber(overdraftamount);
                }
            }
            try {
                difference = toNumber($('#total_voucher_amount').val()) - toNumber(total_amount);
                $('#difference').val(difference.toLocaleString());
                if (difference < 0) {
                    $("#difference").css({ 'color': 'red' });

                } else {
                    $("#difference").css({ 'color': 'black' });
                }
            } catch (e) { }
            $("#total_line_amount").val(toLabel(total_amount));
            $("#total_line_overdraft").val(toLabel(total_overdraft));
            $("#overdraftTotalAmount").val(toLabel(total_overdraft));
        }

        $("#btn_save_gl_items").click(function () {
            var total_amount = 0;
            var difference = 0;
            var data = dt_search_gl_item.DataTable().rows().data();
            if (form_data_status.length == 0) {
                var obj = [];
                dt_voucher_detail.fnClearTable();
                $("#total_amount").text("0.00");
                for (var i = 0; i < data.length; i++) {

                    var amount = all_amounts["Id-" + i];
                    if (amount == undefined) {
                        amount = "";
                    }
                    if (amount.toString().trim()) {
                        var row = data.rows(i).data()[0];
                        console.log(row);
                        if (parseFloat(amount) > 0) {
                            dt_voucher_detail.fnAddData([row[1], row[2], toLabel(row[3]), toLabel(amount)]);
                        }
                        total_amount = parseFloat(total_amount) + parseFloat(amount);
                        $("#total_amount").text(toLabel(total_amount));
                    }
                }

                difference = toNumber($('#total_voucher_amount').val()) - toNumber(total_amount);
                if (difference < 0) {
                    swal("Total Allocation Amount Exceed Distribution Amount");
                    dt_voucher_detail.fnClearTable();
                } else {
                    $('#glItemsModal').modal('hide');

                }
            } else {
                swal("Please Fix Form Errors....");
            }
            toggleTableInfo();
        });

        toggleTableInfo();
        function toggleTableInfo() {
            var data = dt_voucher_detail.DataTable().rows().data();
            if (data.length > 0) {
                $("#dt_voucher_detail").toggle(true);
                $("#infoPanel").toggle(false);
            } else {
                $("#dt_voucher_detail").toggle(false);
                $("#infoPanel").toggle(true);
            }
        }
        //==== END OF ADD GL Items to Voucher Details ======

        $("#form_submision").click(function () {
            $("#form_submision").prop('disabled', true);
            $("#divLoader").show();
            debugger
            if (formValidation()) {
                var AllocationDetails = []
                var allocationDetailsData = dt_voucher_detail.DataTable().rows().data();

                for (var i = 0; i < allocationDetailsData.length; i++) {

                    var _row = allocationDetailsData.rows(i).data()[0];
                    //var baseAmountDetail = parseFloat(_row[3]) * exchangeRate;
                    AllocationDetails.push({
                        "DrCoa": _row[0],
                        "DrCoaDesc": _row[1],
                        "DrGfsCode": _row[2],
                        "BaseAmount": _row[3],
                        //"baseAmountDetail": baseAmountDetail,
                    })
                }

                console.log(AllocationDetails);

                var data = {

                    "BudgetClass": $("#budgetClass").val(),
                    "FundingRefNo": $("#fundRef").val(),
                    "FundingDistributionNum": $("#FundingRefNo").val(),
                    "FundType": $("#fundType").val(),
                    "SubVoteCode":$("#departmentCode").val(),
                    "SubVoteDesc": $("#department").val(),
                    "Description": $("#Description").val(),
                    "STAllocation": $("#ilevel").val(),
                    "STInstitutionCode": $("#STInstitutionCode").val(),
                    "SubWarrantHolderCode": $("#Subwarrantz").val(),
                    "JournalTypeCode": $("#journalTypeCode").val(),
                    "SubmittedOverdraftAmount": $("#overdraftTotalAmount").val(),
                    "AllocationDetails": AllocationDetails,
                    "FinancialYear": $("#distributionfinancialYear").val()

                }
                console.log(allocationDetailsData);


                if (AllocationDetails.length == 0) {
                    swal("No Item(s) Details Provided")
                }
                else {
                    console.log(JSON.stringify(data));
                    var urlList = '@Url.Action("AllocatedFunds", "FundAllocations")';
                    var url = '@Url.Action("CreateAllocation", "FundAllocations")';
                    $("#form_submision").prop('disabled', true);
                    //debugger
                    $.ajax({
                        url: url,
                        type: "POST",
                        data: JSON.stringify(data),
                        dataType: "JSON",
                        contentType: "application/json",
                        success: function (response) {
                            $("#form_submision").prop('disabled', false);
                            //check if successfully save to database
                            if (response == "Success") {
                                
                                $("#divLoader").hide();
                                swal("Allocation Saved Successfully!", { icon: "success" })
                                             .then((value) => {
                                                 window.location.href = urlList;
                                             });
                            }
                            else {
                                $("#divLoader").hide();
                                swal(response, { icon: "warning" });
                            }
                        },
                        error: function () {

                            $("#divLoader").hide();
                            alert('Error. Please try again.');
                            $('#btnSave').val('Save');
                        }
                    });
                }
            }
            else {
                swal("Incomplete Allocation Details");
            }
        });


        function formValidation() {
            debugger;

            var ilevel = $("#ilevel").val();

            $("#errorReference").attr("style", "color: white;");
            $("#errorFundReference").attr("style", "color: white;");
            $("#errorFundType").attr("style", "color: white;");
            $("#errorBudget").attr("style", "color: white;");
            $("#errorIssuedAmount").attr("style", "color: white;");
            $("#errorDepartment").attr("style", "color: white;");
            $("#errorDescription").attr("style", "color: white;");
            $("#errorComponet").attr("style", "color: white;");
            $("#Subwarrantz").attr("style", "color: white;");

            if (ilevel == 1) {
                if ($("#Subwarrantz").val().trim() == "") {
                    $("#errorReference").attr("style", "color: red;");
                    return false
                }
            }

            if ($("#FundingRefNo").val().trim() == "") {
                $("#errorReference").attr("style", "color: red;");
                return false
            }

            if ($("#fundRef").val().trim() == "") {
                $("#errorFundReference").attr("style", "color: red;");
                return false
            }

            if ($("#fundType").val().trim() == "") {
                $("#errorFundType").attr("style", "color: red;");
                return false
            }

            if ($("#budgetClass").val().trim() == "") {
                $("#errorBudget").attr("style", "color: red;");
                return false
            }


            if ($("#Component").val().trim() == "") {
                $("#errorComponet").attr("style", "color: red;");
                return false
            }

            if ($("#distributedAmount").val().trim() == "") {
                $("#errorIssuedAmount").attr("style", "color: red;");
                return false
            }


            if ($("#department").val().trim() == "") {
                $("#errorDepartment").attr("style", "color: red;");
                return false
            }

            if ($("#Description").val().trim() == "") {
                $("#errorDescription").attr("style", "color: red;");
                return false
            }

            //if ($("#ApplyDate").val().trim() == "") {
            //    $("#errorApplyDate").attr("style", "color: red;");
            //    return false
            //}


            return true

        };
        $("#total_line_amount").autoNumeric('init');


        $("#STInstitutionCode").change(function () {
            debugger
            var institutioncode = $(this).val();
            var url = "GetInstitutionSubWarrant/?institutionCode=" + institutioncode;
            $.ajax({
                type: "POST",
                url: url,
                contentType: "html",
                success: function (response) {
                    console.log(response);
                    $("#Subwarrantz").empty();
                    $("#Subwarrantz").append(response);
                }
            })
        });


        $("input:checkbox.checkST").click(function () {
            if ($(this).prop("checked")) {
                //swal("Checked");
                $("input:checkbox.checkST").val("1");
                $("#stzAllocation").show();

            }
            else {
               $("#stzAllocation").hide();
                $("input:checkbox.checkST").val("0");
            }
        });


         $("input:checkbox.checkEmbassy").click(function () {
            if ($(this).prop("checked")) {
                //swal("Checked");
                $("input:checkbox.checkEmbassy").val("1");
                $("#journalTypeCode").val("FAE");

            }
            else {
                $("input:checkbox.checkEmbassy").val("0");
                 $("#journalTypeCode").val("FA");
            }
        });




    </script>
}
