@model IFMIS.Areas.IFMISTZ.Models.OwnSourceVM
@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- MAIN CONTENT -->
<div id="content">

    <div class="row">


        <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
            <!-- Button trigger modal -->
            <!--<a data-toggle="modal" href="#myModal" class="btn btn-success btn-lg pull-right header-btn hidden-mobile"><i class="fa fa-circle-arrow-up fa-lg"></i> Launch form modal</a>-->
        </div>
    </div>


    <!-- widget grid -->
    <section id="widget-grid" class="">


        <!-- START ROW -->

        <div class="row">

            <!-- NEW COL START -->
            <article class="col-sm-12 col-md-12 col-lg-12">

                <!-- Widget ID (each widget will need unique ID)-->
                <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false" data-widget-custombutton="false" data-widget-colorbutton="false" data-widget-deletebutton="false" data-widget-togglebutton="false">

                    <header>
                        <span class="widget-icon"> <i class="fa fa-edit"></i> </span>
                        <h2> Own Source Transfer </h2>

                    </header>

                    <!-- widget div-->
                    <div>
                        <div class="widget-body">
                            <div id="divLoader"></div>
                            <form action="" method="post" id="create-bill-form" class="form-horizontal">
                                @Html.AntiForgeryToken()
                                <fieldset>

                                    <div class="form-group">

                                        <label class="col-md-2 control-label">
                                            @*Fund Type*@
                                            <i class="fa fa-asterisk" style="color:white" id="errorFundType"></i>
                                        </label>
                                        <div class="col-md-3">
                                            <input class="form-control" type="hidden" readonly="readonly" value="@ViewBag.fundType" name="fundingType" id="fundingType">
                                        </div>
                                        <label class="col-md-2 control-label">

                                            <i class="fa fa-asterisk" style="color:white" id="errorBudget"></i>
                                        </label>
                                        <div class="col-md-4">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-md-2 control-label">
                                            Institution From
                                            <i class="fa fa-asterisk" style="color:white" id="errorinstitutionfrom"></i>
                                        </label>
                                        <div class="col-md-3">
                                            <select id="institutionFrom" class="form-control select2" required="required">
                                                <option> </option>
                                            </select>
                                        </div>

                                        <label class="col-md-2 control-label">
                                            Institution To
                                            <i class="fa fa-asterisk" style="color:white" id="errorbankto"></i>
                                        </label>
                                        <div class="col-md-4">
                                            <input class="form-control" value="@ViewBag.institution" type="text" readonly="readonly" name="InstitutionToDisplay" id="InstitutionToDisplay" disabled autocomplete="off">
                                            <input class="form-control" value="@ViewBag.instCode" type="hidden" readonly="readonly" name="InstitutionTo" id="InstitutionTo" disabled autocomplete="off">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-md-2 control-label">
                                            Bank Account From
                                            <i class="fa fa-asterisk" style="color:white" id="errorbankfrom"></i>
                                        </label>
                                        <div class="col-md-3">
                                            <select id="bankAccountFrom" name="bankAccountFrom" class="form-control select2" required="required">
                                                <option> </option>
                                            </select>
                                            @*<input type="text" name="SBCFrom" id="sbcfrom" />*@
                                        </div>

                                        <label class="col-md-2 control-label">
                                            Bank Account To
                                            <i class="fa fa-asterisk" style="color:white" id="errorbankto"></i>
                                        </label>
                                        <div class="col-md-4">
                                            <select id="bankAccountTo" class="form-control select2" required="required">
                                                <option value="" required="required" selected="selected">Please choose Bank To </option>
                                                @*@foreach (var banks in ViewBag.banks)
                                                    {
                                                        <option value='@banks.AccountNumber'>
                                                            @banks.AccountNumber - @banks.AccountName
                                                        </option>
                                                    }*@
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="col-md-2 control-label">
                                            SubBudget Class From
                                            <i class="fa fa-asterisk" style="color:white" id="errorbankfrom"></i>
                                        </label>
                                        <div class="col-md-3">
                                            <input class="form-control" type="hidden" readonly="readonly" name="subBudgetClassFrom" id="subBudgetClassFrom">
                                            @*<input class="form-control" type="text" value="" readonly="readonly" name="subBudgetClassFromDesc" id="subBudgetClassFromDesc">*@

                                            <select id="subBudgetClassFromDesc" class="form-control select2" required="required">
                                                <option></option>
                                            </select>

                                        </div>

                                        <label class="col-md-2 control-label">
                                            Sub Budget Class To
                                            <i class="fa fa-asterisk" style="color:white" id="errorbankto"></i>
                                        </label>
                                        <div class="col-md-4">
                                            <select id="SubBudgetClass" class="form-control select2" required="required">
                                                @*<option value="" required="required" selected="selected">Please choose sub budget class</option>
                                                    @foreach (var subBudgetClass in ViewBag.subBudgetClassList)
                                                    {
                                                        <option value='@subBudgetClass.SubBudgetClass'>
                                                            @subBudgetClass.SubBudgetClass - @subBudgetClass.SubBudgetClassDesc
                                                        </option>
                                                    }*@
                                                <option></option>
                                            </select>

                                        </div>
                                    </div>

                                    <div class="form-group">

                                        <label class="col-md-2 control-label">
                                            CashBook Balance
                                            <i class="fa fa-asterisk" style="color:white" id="errortotalamount"></i>
                                        </label>
                                        <div class="col-md-3">
                                            <input onkeyup="" class="form-control" type="text" value="" readonly="readonly" name="totalAmount" id="totalAmount">
                                        </div>
                                        <label class="col-md-2 control-label">
                                            Amount
                                            <i class="fa fa-asterisk" style="color:white" id="erroramount"></i>
                                        </label>
                                        <div class="col-md-4">
                                            <input onkeyup="ValidateEntry()" class="form-control" type="text" name="Amount" id="Amount" autocomplete="off">
                                            <a href="#" id="exceedMsg" style="display:none;color:red">Amount Exceed Available Balance </a>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-md-2 control-label">
                                            Transfer Category
                                            <i class="fa fa-asterisk" style="color:white" id="errordescription"></i>
                                        </label>
                                        <div class="col-md-3">
                                            <select id="ownsourceType" class="form-control" required="required">
                                                <option value="notselected" selected="selected">Choose Type</option>
                                                <option value="Physical"> Physical </option>
                                                @*<option value="NonPhysical"> Non Physical </option>*@

                                            </select>
                                        </div>
                                        <label class="col-md-2 control-label"> Apply Date </label>
                                        <div class="col-md-4">
                                            <table>
                                                <tr>
                                                    <td>
                                                        <div class="flatpickr date-group">
                                                            <input type="text" placeholder="Select Date.."
                                                                   data-input
                                                                   style="width:400px;padding-left:10px;height:30px;border:none"
                                                                   autocomplete="off" id="ApplyDate">
                                                            <a class="input-button" title="open" data-toggle href="#">
                                                                <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </table>



                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="col-md-2 control-label">
                                            Description
                                            <i class="fa fa-asterisk" style="color:white" id="errordescription"></i>
                                        </label>
                                        <div class="col-md-3">
                                            <textarea class="form-control" name="Description" id="Description"></textarea>
                                        </div>
                                        <label class="col-md-2 control-label"> </label>
                                        <div class="col-md-4">

                                        </div>
                                    </div>

                                </fieldset>

                                <div class="form-actions">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="col-md-2">
                                            </div>
                                            <div class="col-md-10">
                                                <a href='@Url.Action("confirmownsourcetransfer", "OwnSources")' style="margin-right:5px" type="submit" class="btn btn-info pull-left"><i class="glyphicon glyphicon-arrow-left"></i> Back  </a>
                                                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                                                <button class="btn btn-info" id="savebtn" type="button" style="float: left">
                                                    <i class="fa fa-save"></i>
                                                    Save
                                                    <img src="~/Content/img/loading.gif" id="saveLoader" />
                                                </button>
                                            </div>
                                        </div>


                                    </div>
                                </div>
                            </form>
                        </div>
                        <!-- end widget content -->
                    </div>
                    <!-- end widget div -->

                </div>
                <!-- end widget -->

            </article>
            <!-- END COL -->

        </div>

        <!-- END ROW -->

    </section>
    <!-- end widget grid -->

</div>
<!-- END MAIN CONTENT -->

@section pagespecific {
    <script type="text/javascript">

        function getUrlVars() {
            var vars = {};
            var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
                vars[key] = value;
            });
            return vars;
        }



        $("#institutionFrom").change(function () {
            debugger
            var institutioncodeFrom = $(this).val();
            // var institutioncodeFrom = $("#institutionFrom").val();
                var url = "GetBankAccountByInstitution/?institutioncode=" + institutioncodeFrom;
                $.ajax({
                    type: "POST",
                    url: url,
                    contentType: "html",
                    success: function (response) {
                        $("#bankAccountFrom").empty();
                        $("#bankAccountFrom").append(response);
                    },
             });

        });


        $("#bankAccountFrom").change(function () {
            debugger
           // $("#divLoader").show();
            $("#bankAccountTo").empty();
            $("#SubBudgetClass").empty();
            var accountNo = $(this).val();
            var institutioncodeFrom = $("#institutionFrom").val();
            var subbudgetClassfrom = $("#subBudgetClassFrom").val();
            var url = "GetSubBudgetClass/?accountNo=" + accountNo + "&institutioncode=" + institutioncodeFrom;
            $.ajax({
                type: "POST",
                url: url,
                contentType: "html",
                success: function (response) {
                    console.log(response);
                    $("#subBudgetClassFromDesc").empty();
                    $("#subBudgetClassFromDesc").append(response);

                    //$("#divLoader").hide();
                    //var desc = response[0] + " - " + response[1]
                    //$("#subBudgetClassFrom").val(response[0]);
                    //$("#subBudgetClassFromDesc").val(desc);
                    //$("#totalAmount").val(response[2]);
                   // $("#totalAmount").autoNumeric({ aNeg: "-" }).trigger("change");
                    //if (response[0] != null) {
                    //    getBankTo();
                    //}
                },
            });
        });

        //$("#subBudgetClassFromDesc").change(function () {
        //    debugger;
        //    var subfrm = $(this).val();
        //    $("#subBudgetClassFrom").val(subfrm);
        //});

        $("#subBudgetClassFromDesc").change(function () {
            debugger;
            var sbcfrom = $(this).val();
            $("#subBudgetClassFrom").val(sbcfrom);

           // var sbcfrom = $("#subBudgetClassFrom").val(subfrm);
            var accfrom = $("#bankAccountFrom").val();
            var institutioncode = $("#institutionFrom").val();
            if (sbcfrom != null || sbcfrom != "" || sbcfrom != undefined) {
                getBankTo();
                getCashAccountBalance(sbcfrom, accfrom, institutioncode);
            }

        });

        function getCashAccountBalance(sbcfrom,accfrom,institutioncode) {
            debugger
            $("#divLoader").toggle(true);
            var subbudgetClassfrom = $("#subBudgetClassFrom").val();
            var url2 = "GetCashAccountBalance/?accountNo=" + accfrom + "&institutioncode=" + institutioncode + "&subbudgetclass=" + sbcfrom ;
            $.ajax({
                type: "POST",
                url: url2,
                contentType: "html",
                success: function (response) {
                    $("#divLoader").toggle(false);
                    $("#totalAmount").val(response);
                    $("#totalAmount").autoNumeric({ aNeg: "-" }).trigger("change");
                },
            });

        };

        function getBankTo() {
            debugger
            var subbudgetClassfrom = $("#subBudgetClassFrom").val();
            var url2 = "GetSubBudgetBankAccount/?subbudgetClass=" + subbudgetClassfrom;
            $.ajax({
                type: "POST",
                url: url2,
                contentType: "html",
                success: function (response) {
                    $("#bankAccountTo").empty();
                    $("#bankAccountTo").append(response);
                },
            });

        };



        $("#bankAccountTo").change(function () {
            debugger
            var accountNo = $(this).val();
            var institutioncodeFrom = $("#InstitutionTo").val();
            var url = "GetSubBudgetClass2/?accountNo=" + accountNo + "&institutioncode=" + institutioncodeFrom;
            $.ajax({
                type: "POST",
                url: url,
                contentType: "html",
                success: function (response) {
                    console.log(response);
                    var desc = response[0] + " - " + response[1]
                    $("#SubBudgetClass").empty();
                    $("#SubBudgetClass").append(response);
                    //$("#totalAmount").val(response[2]);
                   // $("#totalAmount").autoNumeric({ aNeg: "-" }).trigger("change");
                },
            });

        });




        //$("#bankAccountFrom").change(function () {
        //    debugger
        //    var accountNo = $(this).val();
        //    var institutioncodeFrom = $("#institutionFrom").val();
        //    var sbcfrom = $("#subBudgetClassFrom").val();
        //    console.log(sbcfrom);
        //        var url = "GetMemorandumBalance/?accountNo=" + accountNo+"&&institutionCode="+institutioncodeFrom+"&&subbudgetclass="+sbcfrom;
        //        $.ajax({
        //            type: "POST",
        //            url: url,
        //            contentType: "html",
        //            success: function (response) {
        //                $("#totalAmount").val(response[1]);
        //                //$('#totalAmount').val(numeral(response[1]).format("0,0.00"));
        //                $("#totalAmount").autoNumeric({ aNeg: "-" }).trigger("change");
        //            },
        //     });

        //});




        function ValidateEntry() {
            debugger;
            var amount = parseFloat($("#Amount").val().toString().split(",").join(""));
            var total = parseFloat($("#totalAmount").val().toString().split(",").join(""));
            if (amount > total) {
                $("#Amount").css({ 'color': 'red' });
                $("#savebtn").attr("disabled", true);
                $("#exceedMsg").show();
            }
            else {
                $("#Amount").css({ 'color': 'black' });
                $("#savebtn").attr("disabled", false);
                $("#exceedMsg").hide();
            }
        };















        $("#saveLoader").toggle(false);
        $("#divLoader").toggle(false);
        $("#savebtn").click(function () {
            debugger;

            if (formValidation()) {

                var otype = $("#ownsourceType").val();
                var transferType = "Own Source";
                var category = null;
                if (otype == "Physical") {
                    category = "Bank"
                }
                else {
                    category = "Internal"
                }
                var data = {
                    "BankAccountFrom": $("#bankAccountFrom").val(),
                    "BankAccountTo": $("#bankAccountTo").val(),
                    "TotalBaseAmount": $("#totalAmount").val(),
                    "FundType": $("#fundSource").val(),
                    "SubBudgetClassTo": $("#SubBudgetClass").val(),
                    "SubBudgetClassFrom": $("#subBudgetClassFrom").val(),
                    "InstitutionCodeTo": $("#InstitutionTo").val(),
                    "InstitutionCodeFrom": $("#institutionFrom").val(),
                    "TransferDescription": $("#Description").val(),
                    "OwnSourceType": $("#ownsourceType").val(),
                    "TransferType": transferType,
                    "TransferCategory": category,
                    "BaseAmount": $("#Amount").val(),
                    "JournalTypeId": $("#summaryId").val(),
                    "TransferRefNum": $("#reference").val(),
                    "ApplyDate": $("#ApplyDate").val(),
                }
                console.log(data);
                var url = '@Url.Action("CreateTransfer", "OwnSources")';
                var urlList = '@Url.Action("ConfirmOwnSourceTransfer", "OwnSources")';
                $("#savebtn").prop('disabled', true);
                $("#saveLoader").toggle(true);
                $.ajax({
                    type: "post",
                    url: url,
                    data: data,
                    contenttype: "application/json; charset=utf-8",
                    datatype: "json",
                    success: function (response) {
                        $("#savebtn").prop('disabled', false);
                        $("#saveLoader").toggle(false);
                        $("#divLoader").toggle(false);
                        if (response == "Success") {
                            swal("Transfer Saved Successfully!", { icon: "success" })
                                                .then((value) => {
                                                    window.location.href = urlList;
                                                });
                        }
                        else {
                            swal(response);
                        }
                    },
                    failure: function (error) {
                        $("#savebtn").prop('disabled', false);
                        $("#saveLoader").toggle(false);
                        $("#divLoader").toggle(false);
                        swal(error);
                    }
                });

            }
            else {
                swal("Please Fill all the Transfer Details");
            }

        });



        function formValidation() {
            debugger;

            $("#errorFundType").attr("style", "color: white;");
            $("#errorBudget").attr("style", "color: white;");
            $("#errorbankfrom").attr("style", "color: white;");
            $("#errorbankto").attr("style", "color: white;");
            $("#errortotalamount").attr("style", "color: white;");
            $("#erroramount").attr("style", "color: white;");
            $("#errordescription").attr("style", "color: white;");


            if ($("#fundingType").val().trim() == "") {
                $("#errorFundType").attr("style", "color: red;");
                return false
            }

            if ($("#SubBudgetClass").val().trim() == "") {
                $("#errorBudget").attr("style", "color: red;");
                return false
            }

            if ($("#bankAccountFrom").val().trim() == "") {
                $("#errorbankfrom").attr("style", "color: red;");
                return false
            }

            if ($("#bankAccountTo").val().trim() == "") {
                $("#errorbankto").attr("style", "color: red;");
                return false
            }

            if ($("#totalAmount").val().trim() == "") {
                $("#errortotalamount").attr("style", "color: red;");
                return false
            }


            if ($("#Amount").val().trim() == "") {
                $("#erroramount").attr("style", "color: red;");
                return false
            }

            if ($("#Description").val().trim() == "") {
                $("#errordescription").attr("style", "color: red;");
                return false
            }



            return true

        };


         $(document).ready(function () {
            debugger;
            $('#Amount').autoNumeric('init');
            $('#totalAmount').autoNumeric('init');


            var institutioncode = $("#InstitutionTo").val();
                var url = "GetWithinInstitutions/?institutioncode=" + institutioncode;
                $.ajax({
                    type: "POST",
                    url: url,
                    contentType: "html",
                    success: function (response) {
                        $("#institutionFrom").empty();
                        $("#institutionFrom").append(response);
                    },
                });

        });



    </script>
}