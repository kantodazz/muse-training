<style>
    .search-container {
        background-color: white;
        color: black;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 3px;
        padding-right: 10px;
        padding-left: 10px;
    }

    .info-box {
        padding: 8px;
        background-color: #ECF3F8;
        text-align: center;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .search-btn {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 5px;
        padding-right: 10px;
    }

    input[type=search] {
        padding: 4px;
        border: hidden;
        border-radius: 4px;
    }

    select {
        padding: 8px;
        border: 1px solid #ccc;
        resize: vertical;
        width: 200px;
    }

    input[type=text] {
        padding: 5px;
        border: 1px solid #ccc;
    }

    .name-input-container {
        display: inline-flex;
        flex: 1 1 300px;
        position: relative;
        overflow: hidden;
    }
</style>
<div id="content" style="margin: 5px; padding-top: 30px">

    <div class="row">

    </div>
    <section id="widget-grid" class="">
        <div class="row">
            <article class="col-sm-12 col-md-12 col-lg-12">
                <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false" data-widget-custombutton="false" data-widget-colorbutton="false" data-widget-deletebutton="false" data-widget-togglebutton="false">
                    <header>
                        <span class="widget-icon"> <i class="fa fa-edit"></i> </span>
                        <h2>Unpaid WithHolding Tax</h2>

                    </header>
                    <div>
                        <div class="jarviswidget-editbox">
                        </div>
                        <div class="widget-body">
                            <div class="row">
                                <div class="col-md-1">
                                    <button class="btn btn-info" id="confirm" onclick="confirmVoucher()">
                                        <span class="glyphicon glyphicon-ok" aria-hidden="true"></span>Confirm
                                        <img src="~/Content/img/loading.gif" id="saveLoader" />
                                    </button>
                                </div>
                                <div class="col-md-2">
                                    <select id="SubBudgetClass">
                                        <option value="Please choose sub budget class" selected="selected">Please choose sub budget class</option>
                                        @foreach (var subBudgetClass in ViewBag.subBudgetClassList)
                                        {
                                            <option value='@subBudgetClass.SubBudgetClass'>
                                                @subBudgetClass.SubBudgetClassSubBudgetClassDesc
                                            </option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <div class="name-input-container submit-btn" style="float:left;padding-left:20px">
                                        <a class="search-btn" onclick="SearchPayee()"
                                           href="#" style="float:left">
                                            <i class="fa fa-search search-icon"></i>
                                        </a>
                                        <input type="text" readonly id="PayeeName" placeholder="No Payee Selected" style="width:200px" />
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div id="infoPanel">
                                        <div class="info-box"><strong id="selectedItems">No Item(s) Selected</strong></div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="search-container" style="float:right">
                                        <i class="fa fa-search searchIcon"></i>
                                        <input type="search" name="search" placeholder="Search..." id="searchbox1" style="width:200px">
                                    </div>
                                </div>
                            </div>
                            <table id="dt_withholding" class="table table-striped table-bordered table-hover table-condensed" width="100%">
                                <thead>
                                    <tr style="background-color: #f5f5f5; color:black">
                                        <th>#</th>
                                        <th><input type="checkbox" onchange="checkAll()" id="checkall" /></th>
                                        <th>Payee Code </th>
                                        <th>Payee Name </th>
                                        <th>Withholding Amount</th>
                                        <th>PVNo</th>
                                        <th>SubWarrantCode</th>
                                        <th>Voucher Description </th>
                                        <th>Voucher Amount</th>
                                        <th>Voucher Date</th>
                                        <th>OverallStatus</th>
                                    </tr>
                                </thead>

                            </table>
                        </div>
                    </div>
                </div>
            </article>
        </div>
    </section>
</div>

<div class="modal fade" id="responseModal" tabindex="-1" role="dialog" aria-labelledby="lblmodal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header alert alert-danger" style="font:bold 16px Trebuchet MS, Lucida Sans Unicode, Lucida Grande, Lucida Sans, Arial, sans-serif">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>

                <h4 class="modal-title" id="lblmodal">Confirm With Holding Tax</h4>
            </div>
            <div class="modal-body">
                <p class="success-message">Are you sure you want to Confirm? </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-info confirm-confirm">Ok</button>
                <button class="btn btn-info confirm-cancel" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="payeeModal" style="left:4%">

    <div class="modal-dialog" style="width:80%;">
        <div class="modal-content panel-info">


            <div class="modal-header panel-heading">
                <a href="#" class="close" data-dismiss="modal">&times;</a>
                <h3 class="modal-title"> Search Payee</h3>

            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                    </div>
                    <div class="col-md-6">
                        <div class="search-container " style="float:right">
                            <i class="fa fa-search search-icon"></i>
                            <input type="search" name="search" placeholder="Search..." id="searchbox">
                        </div>
                    </div>
                </div>
                <table class="table" id="dt_search_payee">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>PaymentId</th>
                            <th>BIC</th>
                            <th>Payee Name</th>
                            <th>Payee Code</th>
                            <th>Bank Name</th>
                            <th>Bank Account No</th>
                            <th>Payee Type</th>
                            <th>Address</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

            </div>
            <div class="modal-footer">
                <button class="btn btn-info" data-dismiss="modal">
                    <i class="fa  fa-times"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>
<!--- HIDDEN SECTION -->
<section id="widget-grid" style="visibility:hidden">
    <table id="dt_selected_payee"></table>
</section>
@section pagespecific{
    <script>

        // ============= SHOW PAYEE===============
        var dt_selected_payee = $('#dt_selected_payee').dataTable({
            "data": [],
            "columnDefs": [{
                "targets": [0, 1],
                "visible": false
            }],
            "columns": [
                { title: "Payee DetailId" },
                { title: "Payee BIC" },
                { title: "Payee Name" },
                { title: "Payee Code" },
                { title: "Bank Name" },
                { title: "Payee Type" },
                { title: "Bank Account No" },
                { title: "Address" }
            ]
        });

        var dt_withholding = $('#dt_withholding').dataTable({
            "language": {
                "emptyTable": '<strong id="loader">Loading...</strong>',
                "zeroRecords": "No matching records found"
            }
        });
        $("#dt_withholding_wrapper .dt-toolbar").remove();
        $("#loader").text("Please choose subbudget class")
        var w_data = []
        var v_data = []
        function getWithHoldingDetails(sub) {
            $("#loader").text("Loading...")
            var url = '@Url.Action("GetWithHoldingDetails", "WithHolding")';
            $.ajax({
                type: "GET",
                url: url,
                data: { subBudgetClass: sub },
                contenttype: "application/json; charset=utf-8",
                datatype: "json",
                success: function (response) {
                    w_data = response.data.map(a => a.wh);
                    v_data = response.data.map(a => a.pv);
                    dt_withholding.fnClearTable();
                    for (var i = 0; i < w_data.length; i++) {
                        var Id = w_data[i]["WithHoldingDetailId"]
                        dt_withholding.fnAddData([i + 1,
                          '<input type="checkbox" id="row-' + Id + '" onchange="rowChecked(' + Id + ')" value=' + w_data[i]["WithHoldingDetailId"] + ' />',
                           w_data[i]["PayeeCode"],
                           w_data[i]["Payeename"],
                           toLabel(w_data[i]["OperationalWithHoldingAmount"]),
                           w_data[i]["PVNo"],
                           v_data[i].SubWarrantCode || '-',
                           w_data[i]["Narration"],
                           toLabel(w_data[i]["VoucherOperationalAmount"]),
                           w_data[i]["CreatedAtFormatted"],
                           w_data[i]["OverallStatus"],
                        ]);
                    }
                    if (w_data.length == 0) {
                        $("#loader").text("No matching records found")
                    }
                },
                failure: function (error) {
                    swal(error);
                }
            });
        }

        $("#SubBudgetClass").change(function () {
            getWithHoldingDetails(this.value)
        })

        var dt_search_payee = $('#dt_search_payee').dataTable({
            "aoColumnDefs": [{ "bVisible": false, "aTargets": [1, 2] }],
        });

        $("#dt_search_payee_wrapper .dt-toolbar").remove();

        $("#searchbox").on("keyup search input paste cut", function () {
            if (!this.value) {
                dt_search_payee.fnClearTable();
            } else {
                searchPayeeTableUpdate(this.value);
            }
        });

        function SearchPayee() {
            $('#payeeModal').modal('show');
        }

        function searchPayeeTableUpdate(search) {
            var url = '@Url.Action("GetPayee", "PaymentVoucher")';
            $.ajax({
                type: "get",
                url: url + "/?search=" + search + "",
                contenttype: "application/json; charset=utf-8",
                datatype: "json",
                success: function (response) {
                    _data = response.data;
                    console.log(_data)
                    dt_search_payee.fnClearTable();
                    for (var i = 0; i < _data.length; i++) {
                        dt_search_payee.fnAddData([i + 1,
                           _data[i]["PayeeDetailId"],
                           _data[i]["BIC"],
                           _data[i]["AccountName"],
                           _data[i]["PayeeCode"],
                           _data[i]["BankName"],
                           _data[i]["Accountnumber"],
                           _data[i]["PayeeType"],
                           _data[i]["Address1"],
                           '<a href="#" onclick="payeeClicked(' + i + ')"><i class="glyphicon glyphicon-plus-sign"></i></a>'
                        ]);
                    }
                },
                failure: function (error) {
                    swal(error);
                }
            });
        }

        function payeeClicked(rowId) {
            var data1 = dt_search_payee.DataTable().rows().data();
            var row = data1[rowId];
            dt_selected_payee.fnClearTable();
            $("#PayeeName").val(row[3]);
            dt_selected_payee.fnAddData([
                row[1],
                row[2],
                row[3],
                row[4],
                row[5],
                row[6],
                row[7],
                row[8]
            ]);
            $("#payeeModal").modal("hide");
        }
        // =========== END SEARCH PAYEE ====================
        var dt_voucher_listing = $('#dt_voucher_listing').dataTable();
        $("#confirm").attr('disabled', true);

        $("#dt_voucher_listing_wrapper .dt-toolbar").remove();

        $("#searchbox1").on("keyup search input paste cut", function () {
            dt_voucher_listing.DataTable().search(this.value).draw();
        });

        var data = dt_voucher_listing.DataTable().rows().data();
        var checkedRows = [];

        function rowChecked(rowId) {
            console.log(rowId)
            if ($("#row-" + rowId).is(":checked")) {
                checkedRows.push(rowId);
                // disableOther(rowId);
            } else {
                remove(checkedRows, rowId);
                // enableOther();
            }
            toggleConfirmButton();

        }

        function checkAll() {
            checkedRows = [];
            if ($("#checkall").is(":checked")) {
                for (var i = 0; i < w_data.length; i++) {
                    var Id = w_data[i]["WithHoldingDetailId"]
                    checkedRows.push(Id);
                    $("#row-" + Id).prop('checked', true);
                }
            } else {
                for (var i = 0; i < w_data.length; i++) {
                    var Id = w_data[i]["WithHoldingDetailId"]
                    $("#row-" + Id).prop('checked', false);
                }
            }
            toggleConfirmButton();
        }

        function disableOther(j) {
            for (var i = 0; i < w_data.length; i++) {
                if (i != j) {
                     $("#row-" + i).prop('disabled', true);
                }
               }
        }

       function enableOther() {
            for (var i = 0; i < w_data.length; i++) {
                $("#row-" + i).prop('disabled', false);
            }
       }

        $("#confirm").attr('disabled', true);

        function toggleConfirmButton() {
            var TotalAmount = 0;
            if (checkedRows.length > 0) {
                checkedRows.forEach(rowId=> {
                    var row = w_data.filter(a=>a.WithHoldingDetailId == rowId)[0];
                    TotalAmount = TotalAmount + toNumber(row["OperationalWithHoldingAmount"]);
                });
                $("#confirm").attr('disabled', false);
                $("#selectedItems").text(checkedRows.length + " Item(s) Selected ~ Total: " + toLabel(TotalAmount));
            } else {
                $("#confirm").attr('disabled', true);
                $("#selectedItems").text("No Item(s) Selected");
            }
        }

        function remove(array, val) {
            var found = array.indexOf(val);
            while (found !== -1) {
                array.splice(found, 1);
                found = array.indexOf(val);
            }
        }

        function confirmVoucher() {
            swal({
                text: "Confirm Selected Item(s)?",
                buttons: ["NO", "YES"],
            }).then((willGenerate) => {
                if (willGenerate) {
                    postGeneratedVoucher();
                } else {
                    swal("Cancelled");
                }
            });
        }
        $("#confirm").prop('disabled', false);
        $("#saveLoader").toggle(false);
        function postGeneratedVoucher() {
            //paymentVoucherIds = [];

            //checkedRows.forEach(rowId => {
            //    paymentVoucherIds.push($("#row-" + rowId).val());
            //});
            $("#confirm").prop('disabled', true);
            $("#saveLoader").toggle(true);
            let _data = dt_selected_payee.DataTable().rows().data();
            let _row = _data.rows(0).data()[0];
            if (_row != undefined) {
                var url = '@Url.Action("Create", "WithHolding")';
                $.ajax({
                    type: "post",
                    url: url,
                    data: {
                        WithHoldingDetailIdList: checkedRows,
                        paymentVoucher: {
                            "PayeeDetailId": _row[0],
                            "PayeeName": _row[2],
                            "PayeeCode": _row[3],
                            "PayeeBIC": _row[1],
                            "BankName": _row[4],
                            "BankAccountNo": _row[5],
                            "PayeeType": _row[6],
                            "Address": _row[7],
                        }
                    },
                    contenttype: "application/json; charset=utf-8",
                    datatype: "json",
                    success: function (response) {
                        if (response == 'Success') {
                            swal("Confirmed successfully!", { icon: "success" })
                            .then((e) => {
                                window.location.href = '@Url.Action("Create", "WithHolding")';
                            });
                        } else {
                            swal(response);
                        }
                    },
                    failure: function (error) {
                        swal(error);
                    }
                });
            } else {
                swal("No Payee Selected..!!")
            }
        }

    </script>
}
