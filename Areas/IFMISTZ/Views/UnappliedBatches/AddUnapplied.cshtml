@model IFMIS.Areas.IFMISTZ.Models.BulkPaymentVM
@{
ViewBag.Title = "Create";
Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
.searchContainer {
    background-color: white;
    color: black;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 3px;
    padding-right: 10px;
}

input[type=search] {
    padding: 4px;
    border: hidden;
    border-radius: 4px;
}

.info-box {
    padding: 8px;
    background-color: #ECF3F8;
    /*padding-top:10px;*/
    /*text-align: center;*/
    border: 1px solid #ccc;
    border-radius: 5px;
}

.payee-entry {
    border: 1px solid #ccc;
    border-radius: 10px;
    padding-bottom: 10px;
}

.entry-label {
    position: relative;
    top: -12px;
    background-color: white;
    width: 200px;
    left: 15px;
    padding-left: 5px;
    padding-right: 5px;
    padding-bottom: 5px;
    text-align: center;
    font-weight: bold;
    color: #2196F3;
}


    .search-btn {
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 5px;
    padding-right: 10px;
}

.search-container {
    display: inline-flex;
    flex: 1 1 300px;
    position: relative;
    border: 1px solid #ccc;
    border-radius: 5px;
    overflow: hidden;
    padding-left: 10px;
}

.name-input-container {
    display: inline-flex;
    flex: 1 1 300px;
    position: relative;
    overflow: hidden;
}

.search-icon {
    padding: 0.5rem;
}

.search-button {
    background: #538AC5;
    border: 0;
    color: white;
    padding: 8px;
    border-radius: 0;
}

input[type=number] {
    padding: 8px;
    border: 1px solid #ccc;
    width: 205px;
}

input[type=text] {
    padding: 5px;
    border: 1px solid #ccc;
}

input[type=search] {
    padding: 4px;
    border: hidden;
    border-radius: 4px;
}

textarea {
    border: 1px solid #ccc;
}

select {
    padding: 8px;
    border: 1px solid #ccc;
    resize: vertical;
    width: 230px;
}

.action-btn {
    width: 100px;
    color: white;
}

.form-label {
    text-align: right;
}

td {
    padding: 5px;
}

th {
    font-size:small;
    /*//font-weight: bold;*/
}

.info-box {
    padding: 10px;
    background-color: #ECF3F8;
    text-align: center;
    border: 1px solid #ccc;
    border-radius: 5px;
}
</style>
<div style="padding:1em;padding-top:4em">
<section id="widget-grid">
    <div class="row">
        <article class="col-sm-12 col-md-12 col-lg-12">
            <div class="jarviswidget " id="wid-id-0" data-widget-editbutton="false" data-widget-custombutton="false" data-widget-colorbutton="false" data-widget-deletebutton="false" data-widget-togglebutton="false">
                <header>
                    <span class="widget-icon"> <i class="fa fa-table"></i> </span>
                    <h2>Unapplied Details List </h2>
                </header>
                <div>
                    <div class="table-responsive">
                        <hr class="simple" />
                        <div class="col-md-12">
                            <section id="widget-grid">
                                <div class="row">
                                    <article class="col-sm-12 col-md-12 col-lg-12">

                                        <div class="widget-body" style="padding-top:10px">
                                            <div class="row">
                                                <div class="col-md-12" style="padding-bottom:4em">
                                                    <div class="payee-entry">
                                                        <div class="entry-label">Unapplied Batch Summary</div>
                                                        <div style="padding-left:20px;padding-right:20px">
                                                            <div class="row">
                                                                <div class="col-md-12">
                                                                    <input type="hidden" name="PaymentBatchID" id="PaymentBatchID" value="@Model.PaymentBatchID" />
                                                                    <input type="hidden" name="BatchNo" id="BatchNo" value="@Model.BatchNo" />
                                                                    <table>
                                                                        <tr>
                                                                            <th>Batch Number: </th>
                                                                            <td>
                                                                                <a href="@Url.Action("paymentconfirmationdetails","paymentbatches",new { Area = "IFMISTZ"})\?id=@ViewBag.id">
                                                                                    @Model.BatchNo
                                                                                </a>
                                                                            </td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>Batch Description:</th>
                                                                            <td>@Model.BatchDesc</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>No of Transactions:</th>
                                                                            <td>
                                                                                <a href="@Url.Action("paymentconfirmationdetails","paymentbatches",new { Area = "IFMISTZ"})\?id=@ViewBag.id">
                                                                                 @String.Format("{0:#,0}", Model.NoTrx)
                                                                                </a>
                                                                            </td>
                                                                        </tr>

                                                                        <tr>
                                                                            <th>Total Amount:</th>
                                                                            <td>@String.Format("{0:#,0.00}", Model.TotalAmount)</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>Overallstatus:</th>
                                                                            <td>@Model.OverallStatus</td>
                                                                        </tr>
                                                                        @*@if (Model.OverallStatusDescription == "" || Model.OverallStatusDescription == null)
                                                                        {
                                                                        <tr class="hidden"></tr> }
                                                                        else
                                                                        {
                                                                        <tr>
                                                                            <th>OverallStatus Description:</th>
                                                                            <td>@Model.OverallStatusDescription</td>
                                                                        </tr>
                                                                        }*@

                                                                        @if (Model.RejectedReason == "" || Model.RejectedReason == null)
                                                                        {
                                                                        <tr class="hidden"></tr> }
                                                                        else
                                                                        {
                                                                        <tr>
                                                                            <th>Reason:</th>
                                                                            <td>@Model.RejectedReason</td>
                                                                        </tr>
                                                                        }

                                                                    </table>

                                                                    <div style="padding-top:5px">
                                                                        <table id="dt_voucher_detail" class="table table-striped table-bordered table-hover table-condensed" width="100%"></table>
                                                                        <div style="padding-bottom:10px" id="infoPanel">
                                                                            <div class="info-box">No GL Items Selected</div>
                                                                        </div>
                                                                    </div>
                                                                    <div style="float:right;padding-bottom:10px;padding-right:60px">
                                                                        <strong>TOTAL AMOUNT (<strong id="currency2">TZS</strong>): </strong>
                                                                        <strong id="total_amount">0.00</strong>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <br/>
                                                <br/>
                                                <hr class="simple" />
                                                <div class="col-md-6">
                                                    <fieldset class="scheduler-border">
                                                        <legend class="scheduler-border">Unapplied Information</legend>
                                                        <table>
                                                            <tr>
                                                                <th>Beneficiary Name</th>
                                                                <td><input type="text" id="BeneficiaryName" style="width:300px;" class="form-control"/></td>
                                                            </tr>
                                                            <tr>
                                                                <th>Beneficiary Code</th>
                                                                <td><input type="text" id="BeneficiaryCode" style="width:300px;" readonly /></td>
                                                            </tr>
                                                            <tr>
                                                                <th>EndtoEndID</th>
                                                                <td><input type="text" id="EndtoEndID" style="width:300px;" readonly /></td>
                                                            </tr>
                                                            <tr>
                                                                <th>Bank Name</th>
                                                                <td><input type="text" id="BankName" style="width:300px;" readonly /></td>
                                                            </tr>
                                                            <tr>
                                                                <th>Bank Bic</th>
                                                                <td><input type="text" id="BankBic" style="width:300px;" readonly/></td>
                                                            </tr>
                                                            <tr>
                                                                <th>Account Number</th>
                                                                <td><input type="text" id="BeneficiaryAccountNo"  style="width:300px;" readonly /></td>
                                                            </tr>
                                                            <tr>
                                                                <th>Amount</th>
                                                                <td><input type="text" id="Amount" style="width:300px;" readonly/></td>
                                                            </tr>
                                                            <tr>
                                                                <th>OverallStatus</th>
                                                                <td><input type="text" id="OverallStatus" style="width:300px;" readonly /></td>
                                                            </tr>

                                                            <tr>
                                                                <th>Unapplied Description</th>
                                                                <td><input type="text" id="SettledDescription" style="width:300px;" readonly /></td>
                                                            </tr>

                                                            <tr>
                                                                <th>Payment Description</th>
                                                                <td><input type="text" id="PaymentDescription" style="width:300px;" readonly /></td>
                                                            </tr>
                                                        </table>
                                                    </fieldset>
                                                </div>
                                                <div class="col-md-6">
                                                    <fieldset class="scheduler-border">
                                                        <legend class="scheduler-border">Change Information</legend>
                                                        <table>
                                                            <tr>
                                                                <td class="form-label">
                                                                    Beneficiary Name:
                                                                    <i class="fa fa-times" style="color:white" id="NewBeneficiaryName1"></i>
                                                                </td>
                                                                <td>
                                                                    <input id="NewBeneficiaryName" style="width:300px;" type="text">
                                                                </td>
                                                            </tr>

                                                            <tr>
                                                                <td class="form-label">
                                                                    Beneficiary Code:
                                                                    <i class="fa fa-times" style="color:white" id="NewBeneficiaryCode1"></i>
                                                                </td>
                                                                <td>
                                                                    <input id="NewBeneficiaryCode" style="width:300px;" type="text">
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td class="form-label">
                                                                    Bank Name:
                                                                    <i class="fa fa-times" style="color:white" id="NewBankName1"></i>
                                                                </td>
                                                                <td>
                                                                    <select id="NewBankName" style="width:300px">
                                                                        <option value="" selected="selected"></option>
                                                                        @foreach (var bankname in ViewBag.BankName)
                                                                        {<option value='@bankname.BankName'>@bankname.BankName</option>}
                                                                    </select>
                                                                </td>
                                                            </tr>

                                                            <tr>
                                                                <td class="form-label">
                                                                    Account Number:
                                                                    <i class="fa fa-times" style="color:white" id="NewBeneficiaryAccountNo1"></i>
                                                                </td>
                                                                <td>
                                                                    <input id="NewBeneficiaryAccountNo" style="width:300px;" type="text">
                                                                </td>
                                                            </tr>

                                                            <tr>
                                                                <td class="form-label">
                                                                    Payment Description
                                                                    <i class="fa fa-times" style="color:white" id="NewPaymentDescription1"></i>
                                                                </td>
                                                                <td>
                                                                    <div class="input-group">
                                                                        <input type="text" name="NewPaymentDescription" id="NewPaymentDescription" class="input" style="width:300px" />
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        </table>
                                                        <br />
                                                        <div class="row">
                                                            <div class="col-md-4"></div>
                                                            <div class="col-md-10">
                                                                <a class="btn btn-info" href='@Url.Action("UnappliedBatchList","UnappliedBatches")' style="margin-right:5px">
                                                                    <i class="glyphicon glyphicon-arrow-left"></i>Back
                                                                </a>
                                                                <button type="submit" class="btn btn-info" id="btnSave">
                                                                    <i class="fa fa-save"></i>Save
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </fieldset>
                                                </div>

                                            </div>
                                        </div>
                                    </article>
                                </div>
                            </section>
                        </div>

                        </div>
                    </div>
                </div>
            </article>
        </div>
    </section>
</div>
@section Scripts{
<script>

$(document).ready(function () {

var url = '@Url.Action("GetUnappliedPerInstitution", "UnappliedBatches")';

$("#BeneficiaryName").select2({
    minimumInputLength: 2,  // minimumInputLength for sending ajax request to server
    width: 'resolve',   // to adjust proper width of select2 wrapped elements
    ajax: {
        url: url,
        type: "POST",
        dataType: 'json',
        data: function (searchQuery) {
            return {
                searchQuery: searchQuery,
            };
        },
        results: function (data, page) {
            return { results: data.beneficiaries }; // data.beneficiaries returning json data from Controller
        }
    }
});

$("#BeneficiaryName").change(function () {
    debugger
    var url = '@Url.Action("PopulateUnappliedFields", "UnappliedBatches")';
    var EndtoEndid = $("#BeneficiaryName").val();
    $.ajax({
        type: "POST",
        url: url,
        data: { 'paymentId': EndtoEndid },
        success: function (data, status, jqXHR) {
            console.log(data);
            if (data.success) {
                $('#BeneficiaryID').val(data.beneficiaryId);
                $('#EndtoEndID').val(data.EndToEndId);
                $('#NewBeneficiaryName').val(data.BeneficiaryName);
                $('#BeneficiaryCode').val(data.BeneficiaryCode);
                $('#NewBeneficiaryCode').val(data.BeneficiaryCode);
                $('#BankID').val(data.BankID);
                $('#BankBic').val(data.BankBic);
                $('#BankName').val(data.BankName);
                $('#NewBankName').val(data.BankName);
                $('#BeneficiaryAccountNo').val(data.BeneficiaryAccountNo);
                $('#NewBeneficiaryAccountNo').val(data.BeneficiaryAccountNo);
                $('#Amount').val(data.Amount);
                $('#OverallStatus').val(data.OverallStatus);
                $('#SettledDescription').val(data.SettledDescription);
                $('#PaymentDescription').val(data.PaymentDescription);
                $('#NewPaymentDescription').val(data.PaymentDescription);
                
            } else {
                swal('This beneficiary does not exist!');
                $('#BeneficiaryID').val("");
                $('#BeneficiaryCode').val("");
                $('#BankID').val("");
                $('#BankBic').val("");
                $('#BankName').val("");
                $('#BeneficiaryAccountNo').val("");
                $('#Amount').val("");
                $('#OverallStatus').val("");
                $('#SettledDescription').val("");
                $('#PaymentDescription').val("");
            }
        }
    })
});
});

 $("#btnSave").click(function () {
        var beneficiaryName = $("#NewBeneficiaryName").val();
        var beneficiaryCode = $("#NewBeneficiaryCode").val();
        var bankName = $("#NewBankName").val();
        var accountNumber=$('#NewBeneficiaryAccountNo').val();

        if (beneficiaryName == '') {
            swal("Beneficiary Name is Required")
                .then((j) => {
                    $("#NewBeneficiaryName").focus();
                    $("#NewBeneficiaryName").css({ 'border-color': 'red' });
                });
        } else if (beneficiaryCode == '') {
            swal("Beneficiary Code is Required")
                .then((j) => {
                    $("#NewBeneficiaryCode").focus();
                    $("#NewBeneficiaryCode").css({ 'border-color': 'red' });
                });
        } else if (bankName == '') {
            swal("Bank Name is Required")
                .then((j) => {
                    $("#NewBankName").focus();
                    $("#NewBankName").css({ 'border-color': 'red' });
                });
        } else if (accountNumber=='') {
            swal("Account Number is Required")
            .then((j) => {
                $("#NewBeneficiaryAccountNo").focus();
                $("#NewBeneficiaryAccountNo").css({ 'border-color': 'red' });

            });
        
        }
        else {

            $("#NewBeneficiaryName").css({ 'border-color': '' });
            $("#NewBeneficiaryCode").css({ 'border-color': '' });
            $("#NewBankName").css({ 'border-color': '' });
            $("#NewBeneficiaryAccountNo").css({ 'border-color': '' });

            var form_data = {
                "PaymentBatchID":'@ViewBag.id',
                "EndtoEndID": $('#EndtoEndID').val(),
                "BeneficiaryID": $('#BeneficiaryID').val(),
                "NewBeneficiaryName": $('#NewBeneficiaryName').val(),
                "BeneficiaryCode":$('#BeneficiaryCode').val(),
                "NewBeneficiaryCode":$('#NewBeneficiaryCode').val(),
                "BankID":$('#BankID').val(),
                "BankBic":$('#BankBic').val(),
                "BankName": $('#BankName').val(),
                "NewBankName":$('#NewBankName').val(),
                "BeneficiaryAccountNo": $('#BeneficiaryAccountNo').val(),
                "NewBeneficiaryAccountNo":$('#NewBeneficiaryAccountNo').val(),
                "Amount":$('#Amount').val(),
                "OverallStatus": $('#OverallStatus').val(),
                "SettledDescription":  $('#SettledDescription').val(),
                "PaymentDescription": $('#PaymentDescription').val(),
            }

            var url = '@Url.Action("AddUnapplied", "UnappliedBatches")';
            var urlList = '@Url.Action("AddUnapplied", "UnappliedBatches")' + "/?id=" + '@ViewBag.id';

            $.ajax({
                type: "post",
                url: url,
                data: form_data,
                data: { vm: form_data},
                contenttype: "application/json; charset=utf-8",
                datatype: "json",
                success: function (response) {

                    if (response == "Success") {
                        swal("Payment Saved successfully!", { icon: "success" })
                            .then((value) => {
                                window.location.href = urlList;
                            });
                    } else if (response == "Duplicate") {
                        swal("Beneficiary Already exist in this payment batch!", { icon: "warning" })
                            .then((value) => {
                                window.location.href = urlList;
                            });
                    }
                    else {
                        swal(response);
                    }
                },
                failure: function (error) {

                    swal(error);
                }
            });
        }

    });

</script>
}


