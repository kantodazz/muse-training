@model IFMIS.Areas.IFMISTZ.Models.LoanRecoveryVM
@{
    ViewBag.Title = "Preview Loan Recovery";
    decimal? amount, amountt = 0;
    decimal? amount2, amountt2 = 0;
    decimal? total, total2 = 0;
}
<style type="text/css">
    .loadingImg {
        display: none;
    }
</style>
<!-- MAIN CONTENT -->

<div id="content" style="margin: 5px; padding-top: 30px">

    <div class="row">


    </div>



    <!-- widget grid -->
    <section id="widget-grid" class="">


        <!-- START ROW -->

        <div class="row">

            <!-- NEW COL START -->
            <article class="col-sm-12 col-md-12 col-lg-12">

                <!-- Widget ID (each widget will need unique ID)-->
                <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false" data-widget-custombutton="false" data-widget-colorbutton="false" data-widget-deletebutton="false" data-widget-togglebutton="false">

                    <header>
                        <span class="widget-icon"> <i class="fa fa-edit"></i> </span>
                        <h2> Loan Recovery Information</h2>

                    </header>
                    <div class="jarviswidget" id="wid-id-12" data-widget-colorbutton="false" data-widget-colorbutton="false" data-widget-editbutton="false" data-widget-togglebutton="false" data-widget-deletebutton="false" data-widget-fullscreenbutton="false" data-widget-custombutton="false">
                        @*<div align="center">
                                <img src="~/Media/Images/ajax_loader.gif" class="loadingImg" />
                            </div>*@
                        <table class="table  table-hover table-condensed">

                            <tbody>
                                <tr>
                                    <td style="width:20%">
                                        Loan Number
                                    </td>
                                    <td>
                                        <strong>@Html.DisplayFor(model => model.LoanCode)</strong>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="width:20%">
                                        Description
                                    </td>
                                    <td>
                                        @Html.DisplayFor(model => model.LoanDescription)
                                    </td>
                                </tr>
                                <tr>
                                    <td style="width:20%">
                                        Payee Name
                                    </td>
                                    <td>
                                        @Html.DisplayFor(model => model.CustomerName)
                                    </td>
                                </tr>
                                <tr>
                                    <td style="width:20%">
                                        Payee Code
                                    </td>
                                    <td>
                                        @Html.DisplayFor(model => model.CustomerCode)
                                    </td>
                                </tr>

                                <tr>
                                    <td style="width:20%">
                                        Recovery Status
                                    </td>
                                    <td>
                                        @if (Model.RecoveryStatus == null)
                                        {
                                            <p>Partial</p>
                                        }
                                        else
                                        {
                                            @Html.DisplayFor(model => model.RecoveryStatus)
                                        }


                                    </td>
                                </tr>
                                <tr>
                                    <td style="width:20%">
                                        Financial Year
                                    </td>
                                    <td>
                                        @Html.DisplayFor(model => model.FinancialYear)
                                    </td>
                                </tr>

                                <tr>
                                    <td style="width:20%">
                                        Loan Amount
                                    </td>
                                    <td>
                                        @Html.DisplayFor(model => model.AmountDue)
                                    </td>
                                </tr>
                                <tr>
                                    <td style="width:20%">
                                        Monthly Deducted Amount
                                    </td>
                                    <td>
                                        @Html.DisplayFor(model => model.MonthlyDeduction)
                                    </td>
                                </tr>

                                <tr>
                                    <td style="width:20%">
                                        Recovery Amount
                                    </td>
                                    <td>
                                        @Html.DisplayFor(model => model.TotalDeductedAmount)
                                    </td>
                                </tr>
                                <tr>
                                    <td style="width:20%">
                                        Remaining Amount
                                    </td>
                                    <td>
                                        @{
                                            amountt = Model.AmountDue;
                                            amountt2 = Model.TotalDeductedAmount;
                                            total2 = amountt - amountt2;
                                        }
                                        @total2
                                    </td>
                                </tr>

                                <tr>
                                    <td style="width:20%">
                                        Interest rate
                                    </td>
                                    <td>
                                        @Html.DisplayFor(model => model.InterestRate)
                                    </td>
                                </tr>

                                <tr>
                                    <td style="width:20%">
                                        Recovery Period in Months
                                    </td>
                                    <td>
                                        @Html.DisplayFor(model => model.RecoveryPeriod)
                                    </td>
                                </tr>
                                <tr>
                                    <td style="width:20%">
                                        Payee Type
                                    </td>
                                    <td>
                                        @Html.DisplayFor(model => model.PayeeType)
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <table class="table  table-bordered table-hover table-condensed" id="dt_lpo">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Recovery date</th>
                                    <th>Principal Amount</th>
                                    <th>Interest Amount</th>
                                    <th>Received Amount</th>
                                    <th>Status</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (ViewBag.summary != null)
                                {
                                    int i = 0;
                                    foreach (var item in ViewBag.summary)
                                    {
                                        i++;
                                        <tr>
                                            <td>@i</td>
                                            <td>@item.RecoveryDate.ToString("MM/dd/yyyy")</td>
                                            <td>@item.MonthlyRecoveryAmtPrincipal</td>
                                            <td>@item.MonthlyRecoveryAmtInterest</td>
                                            <td>
                                                @{
                                                    amount = item.MonthlyRecoveryAmtPrincipal;
                                                    amount2 = item.MonthlyRecoveryAmtInterest;
                                                    total = amount + amount2;
                                                }
                                                @total
                                            </td>
                                            <td>@item.OverAllStatus</td>
                                            <td style="text-align:center">
                                                @if (item.OverAllStatus.ToUpper() == "CONFIRMED" || item.OverAllStatus.ToUpper() == "EXAMINED")
                                                {
                                                    <div class="btn-group">
                                                        <button type="button" class="btn btn-info btn-xs dropdown-toggle" data-toggle="dropdown" style="width:40px;border-radius:1px;" aria-haspopup="true" aria-expanded="false">
                                                            <span class="caret"></span>
                                                            <span class="sr-only">Toggle Dropdown</span>
                                                        </button>
                                                        <ul class="dropdown-menu">
                                                            @if (item.OverAllStatus.ToUpper() == "CONFIRMED")
                                                            {
                                                                <li><a href="#" data-toggle="modal" data-id=@item.LoanRecoverySummaryId data-lpo='@item.LoanCode' class="loanConfirmationExamine  btn-xs edit">Examine</a></li>
                                                                <li><a href="#" data-toggle="modal" data-target="#rejectLoans" data-id=@item.LoanRecoverySummaryId data-lpo='@item.LoanCode' class="reject_loans  btn-xs edit">Reject</a></li>
                                                            }

                                                            @if (item.OverAllStatus.ToUpper() == "EXAMINED")
                                                            {

                                                                <li><a href="#" data-toggle="modal" data-id=@item.LoanRecoverySummaryId data-lpo='@item.LoanCode' class="loanConfirmationApproval  btn-xs edit">Approve</a></li>

                                                                <li><a href="#" data-toggle="modal" data-target="#rejectLoans" data-id=@item.LoanRecoverySummaryId data-lpo='@item.LoanCode' class="reject_loans  btn-xs edit">Reject</a></li>

                                                            }

                                                        </ul>
                                                    </div>
                                                }
                                                else
                                                {
                                                    @item.Remarks
                                                }

                                            </td>
                                        </tr>
                                                        }
                                                    }

                            </tbody>
                        </table>

                        @if (User.IsInRole("Loan Recovery Examine"))
                        {
                            <a class="btn btn-info" href='@Url.Action("RExamineLoan", "LoanRecoveries", new { area = "IFMISTZ" })' style="margin-right:5px">
                                <i class="glyphicon glyphicon-arrow-left"></i>Back
                            </a>
                        }
                        else if (User.IsInRole("Loan Recovery Approval"))
                        {
                            <a class="btn btn-info" href='@Url.Action("RApproveLoan", "LoanRecoveries", new { area = "IFMISTZ" })' style="margin-right:5px">
                                <i class="glyphicon glyphicon-arrow-left"></i>Back
                            </a>
                        }

                    </div>

                </div>
            </article>

        </div>
    </section>

</div>

<div class="modal fade" id="rejectLoans">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <a href="#" class="close" data-dismiss="modal">&times;</a>
                <h4 align="center">Loan Number <span id="lpo_number"></span></h4>
            </div>
            @using (Html.BeginForm(null, null, FormMethod.Post, new { id = "RejectReason" }))
            {
                <div class="modal-body form-horizontal">

                    <br />

                    <input type="hidden" name="Id" id="Id" value="">
                    <div class="form-group">
                        <label class="control-label col-md-3" for="Remark">Reason</label>
                        <div class="col-md-7">
                            <textarea name="Reason" id="Reason" required rows="4" class="form-control"></textarea>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <a href="#" class="btn btn-info" data-dismiss="modal">Cancel</a>
                    @*<input class="btn btn-info" type="submit" id="btnSubmit" value="Submit" />*@

                    <button type="submit" class="btn btn-info" style="margin-right:2px">
                        <i class="glyphicon glyphicon-floppy-disk"></i> Save
                    </button>
                    @*<input type="submit" value="Submit" class="btn btn-success" id="btnSubmit" />*@

                </div>

            }
        </div>
    </div>
</div>

@section pagespecific {
    <!-- PAGE RELATED PLUGIN(S) -->

    <script type="text/javascript">
                        //SHOW LOADER ICON
                        $(document).ajaxStart(function () {
                            $(".loadingImg").show();

                        });
                        //HIDE LOADER ICON
                        $(document).ajaxStop(function () {
                            $(".loadingImg").hide();
                        });

                        /* BASIC ;*/
                        var responsiveHelper_dt_lpo = undefined;
                        var responsiveHelper_datatable_fixed_column = undefined;
                        var responsiveHelper_datatable_col_reorder = undefined;
                        var responsiveHelper_datatable_tabletools = undefined;

                        var breakpointDefinition = {
                            tablet: 1024,
                            phone: 480
                        };

                        $('#dt_lpo').dataTable({
                            "sDom": "<'dt-toolbar'<'col-xs-12 col-sm-6'f><'col-sm-6 col-xs-12 hidden-xs'l>r>" +
                                "t" +
                                "<'dt-toolbar-footer'<'col-sm-6 col-xs-12 hidden-xs'i><'col-xs-12 col-sm-6'p>>",
                            "autoWidth": true,
                            "preDrawCallback": function () {
                                // Initialize the responsive datatables helper once.
                                if (!responsiveHelper_dt_lpo) {
                                    responsiveHelper_dt_lpo = new ResponsiveDatatablesHelper($('#dt_lpo'), breakpointDefinition);
                                }
                            },
                            "rowCallback": function (nRow) {
                                responsiveHelper_dt_lpo.createExpandIcon(nRow);
                            },
                            "drawCallback": function (oSettings) {
                                responsiveHelper_dt_lpo.respond();
                            }
                        });

        /* END BASIC */
                        $(document).ready(function () {

                        $(".loanConfirmationExamine").on('click', function () {
                            // alert('am heree');
                            var id = $(this).data('id');
                            var lpo = $(this).data('lpo');
                            swal({
                                title: 'Examine Loan',
                                text: "Do you what to Examine Recovered Loan   " + lpo + " ?",
                                buttons: [
                                  'No',
                                  'Yes'
                                ],
                            }).then(function (isConfirm) {
                                if (isConfirm) {
                                    var url = '@Url.Action("ExamineLoanRecord", "LoanRecoveries")';
                                    var urlList = '@Url.Action("RExamineLoan", "LoanRecoveries")';
                                    $.ajax(
                        {
                            type: "POST",
                            url: url,
                            data: { id: id },
                            success: function (response) {
                                if (response == "Success") {

                                    swal("Examined Successfully!", { icon: "success" })
                                       .then((value) => {
                                           window.location.href = urlList;
                                       });

                                }
                                else {

                                    swal("Failed to Examine Loan" + response);
                                }
                            },
                            error: function (xhr) {
                                swal(error);
                                $("#divLoader").hide();
                            },

                        });
                                } else {
                                    swal("Cancelled", "No change was made");
                                }
                            });

                        });

                            $(".loanConfirmationApproval").on('click', function () {
                                // alert('am heree');
                                var id = $(this).data('id');
                                var lpo = $(this).data('lpo');
                                swal({
                                    title: 'Approve Loan',
                                    text: "Do you what to Approve Recovered Loan   " + lpo + " ?",
                                    buttons: [
                                      'No',
                                      'Yes'
                                    ],
                                }).then(function (isConfirm) {
                                    if (isConfirm) {
                                        var url = '@Url.Action("ApproveLoanRecord", "LoanRecoveries")';
                                        var urlList = '@Url.Action("RApproveLoan", "LoanRecoveries")';
                                        $.ajax(
                            {
                                type: "POST",
                                url: url,
                                data: { id: id },
                                success: function (response) {
                                    if (response == "Success") {

                                        swal("Approved Successfully!", { icon: "success" })
                                       .then((value) => {
                                           window.location.href = urlList;
                                       });

                                    }
                                    else {

                                        swal("Failed to confirm ,DbException" + response);
                                    }
                                },
                                error: function (xhr) {
                                    swal(error);
                                    $("#divLoader").hide();
                                },

                            });
                                    } else {
                                        swal("Cancelled", "No change was made");
                                    }
                                });

                            });


                        $(".reject_loans").on('click', function () {
                            var id = $(this).data('id');
                            var lpo = $(this).data('lpo');
                            $("#lpo_number").text(lpo);
                            $(".modal-body #Id").val(id);

                        });

                        $("#RejectReason").on('submit', function (e) {
                            e.preventDefault();
                            var reason = $("#Reason").val();
                            if (!reason) {
                                //alert("Please enter reason of rejection !");
                                swal("Please enter reason for rejection", { icon: "danger" })
                                                                        .then((value) => { });
                                return
                            }
                            var url = '@Url.Action("RejectLoanRecord", "LoanRecoveries")';
                            var formData = $(this).serialize();
                            $('#rejectLoans').modal('hide');
                            $.ajax(
                        {
                            type: "POST",
                            url: url,
                            data: formData,
                            success: function (response) {
                                if (response == "Success") {
                                    // alert("Pre Payment Rejected  successfully");
                                    swal("Recovered Loan Rejected Successfully", { icon: "success" })
                                                                        .then((value) => { });
                                    location.reload();
                                }
                                else {
                                    // alert("Failed to reject Pre Payment,DbException");
                                    swal("Failed to Reject Recovered Loan" + response, { icon: "danger" })
                                                                        .then((value) => { });
                                }
                            },
                            error: function (xhr) {
                                //console.log(xhr.responseText);
                                // alert("An error has occured, contact system support");

                                swal("An error has occured, contact system support" + response, { icon: "danger" })
                                                                        .then((value) => { });
                                $("#divLoader").hide();
                            },

                        });

                        });
                        });



    </script>
}


