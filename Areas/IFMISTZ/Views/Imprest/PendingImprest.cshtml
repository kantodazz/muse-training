@{
    ViewBag.Title = "Pending Imprest";
}
<link href="~/Content/css/custom.css" rel="stylesheet" />
<div style="padding:1em;padding-top:4em">
    <section id="widget-grid">
        <div class="row">
            <article class="col-sm-12 col-md-12 col-lg-12">
                <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false" data-widget-custombutton="false" data-widget-colorbutton="false" data-widget-deletebutton="false" data-widget-togglebutton="false">
                    <header>
                        <span class="widget-icon"> <i class="fa fa-table"></i> </span>
                        <h2>@ViewBag.Title</h2>
                    </header>
                    <div>
                        <div class="widget-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <a class="btn btn-info" href='@Url.Action("CreateImprest", "Imprest")'>
                                        <i class="glyphicon glyphicon-plus"></i> Add New
                                    </a>
                                </div>
                                <div class="col-md-6">
                                    <div class="search-container" style="float:right">
                                        <i class="fa fa-search searchIcon"></i>
                                        <input type="search" name="search" placeholder="Search..." id="searchbox">
                                    </div>
                                </div>
                            </div>
                            <table id="dt_imprest_listing" class="table table-bordered table-condensed table-amount">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Imprest No</th>
                                        <th>Payee Code</th>
                                        <th>Payee Name</th>
                                        <th>Impres Type</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </article>
        </div>
    </section>
</div>


@{ Html.RenderPartial("_VoucherListDialogs"); }

@section pagespecific{

    <script>

        var dt_imprest_listing = $('#dt_imprest_listing').dataTable({
            "fnDrawCallback": function (oSettings) {
                $(".loading-gif").toggle(false)
            }
        });

        $("#dt_imprest_listing_wrapper .dt-toolbar").remove();

        $("#searchbox").on("keyup search input paste cut", function () {
            dt_imprest_listing.DataTable().search(this.value).draw();
        });

        var dt_payee_details = $('#dt_payee_details').dataTable({
            "sDom": 't',
            "autoWidth": false,
            "searching": false,
            "bPaginate": false,
            "info": false,
            "columns": [
                { title: "Payee Name" },
                { title: "Payee code" },
                { title: "Bank Name" },
                { title: "Bank Account No" },
                { title: "Address" }]
        });

        var dt_voucher_detail = $('#dt_voucher_detail').dataTable({
            "sDom": 't',
            "autoWidth": true,
            "searching": false,
            "bPaginate": false,
            "info": false,
            "data": [],
            "columns": [
                { title: "Expenditure Line Item" },
                { title: "Item Description" },
                { title: "Funding Reference" },
                { title: "Issued Amount" }
            ]
        });

        var dt_imprest_item = $('#dt_imprest_item').dataTable({
            'sDom': 't',
            "autoWidth": true,
            "searching": false,
            "bPaginate": false,
            "info": false,
            "data": []
        });


        var data = [];
        var globalPayeeId = null;
        $.ajax({
            type: "get",
            url: '@Url.Action("GetPendingImprest", "Imprest")',
            contenttype: "application/json; charset=utf-8",
            datatype: "json",
            success: function (response) {
                data = response.data;
                dt_imprest_listing.fnClearTable();
                for (var i = 0; i < data.length; i++) {
                    dt_imprest_listing.fnAddData([i + 1,
                       data[i]["ImprestNo"],
                       data[i]["PayeeCode"],
                       data[i]["PayeeName"],
                       data[i]["ImprestTypeDesc"],
                       `${data[i].TransactionAmount?.toLocaleString()|| data[i].OperationalAmount.toLocaleString()} ${data[i]["TransactionCurrency"]}`,
                       data[i]["OverallStatus"],
                       `<div class="btn-group" id="drop-${i}">\
                              <button type="button" class="btn btn-info btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\
                                 <span class="caret"></span\
                                     <span class="sr-only"></span>\
                             </button>\
                            <ul class="dropdown-menu">\
                                <li><a href="#" onclick= "openViewDialog(${i})">View</a></li>\
                                <li><a href="@Url.Action("ImprestDetails","Imprest")/${data[i].ImprestId}">View Page</a></li>\
                                 <li><a href="@Url.Action("AdvancedImprestEdit","Imprest")/?imprestId=${data[i].ImprestId}">Edit</a></li>\
                                 <li><a href="#" onclick="attach(${i})">Attach</a></li>\
                                 <li><a href="#" onclick="viewAttachment(${i})">View Attachment</a></li>\
                                <li><a href="#" onclick="confirmImprest(${i})">Confirm</a></li>\
                                ${rejectCancelOption(i)}\
                            </ul>\
                        </div>\
                       <img src="/Content/img/loading.gif" id="saveLoader-${i}" class="loading-gif"/>`
                    ]);
                    $("#saveLoader-" + i + "").toggle(false)
                }
            },
            failure: function (error) {
                swal(error);
            }
        });

        function rejectCancelOption(i) {
            return (data[i].Sender || "").toUpperCase() === 'MUSE' ? '<li><a href="#" onclick="cancelDialog('+i+')">Cancel</a></li>' :
                '<li><a href="#" onclick="rejectDialog('+i+')">Reject</a></li>'
        }


        $(".force-acc-details").toggle(false);
        var ForceAccountPaymentRegistrationId = null

        function viewForceAccDetails() {
            window.location.href = `@Url.Action("details", "ForceAccountPayment")/${ForceAccountPaymentRegistrationId}`
        }


        function edit(i) {
            if (i == 'x') i = globalPayeeId;
            $("#ApplyDate").val('');
            $("#RetirementDate").val('');
            $("#ImprestId").val(data[i]["ImprestId"]);
            $("#RetirementDateOld").text(data[i]["RetirementDateFormatted"]);
            $("#ApplyDateOld").text(data[i]["ApplyDateFormatted"]);
            $("#Description").val(data[i]["Description"]);
            $("#ImprestType :selected").text(data[i]["ImprestTypeDesc"]);
            $('#confirmModal').modal('hide');
            $('#editModal').modal('show');
        }



        function postEditFormData() {
            var url = '@Url.Action("EditImprest", "Imprest")';
            var form_data = {}

            form_data['ImprestId'] = $("#ImprestId").val();
            form_data['Description'] = $("#Description").val();
            form_data['ApplyDate'] = $("#ApplyDate").val() != "" ? $("#ApplyDate").val() : $("#ApplyDateOld").text();
            form_data['RetirementDate'] = $("#RetirementDate").val() != "" ? $("#RetirementDate").val() : $("#RetirementDateOld").text();
            form_data['ImprestTypeId'] = $("#ImprestType").val();
            form_data['ImprestTypeDesc'] = $("#ImprestType :selected").text();

            $.ajax({
                type: "post",
                url: url,
                data: form_data,
                contenttype: "application/json; charset=utf-8",
                datatype: "json",
                success: function (response) {
                    if (response == "Success") {
                        swal("Saved Successfully!", { icon: "success" })
                             .then((value) => {
                                 window.location.reload();
                             });
                    }
                    else {
                        swal(response);
                    }

                },
                failure: function (error) {
                    swal(error);
                }
            });
            $('#editModal').modal('hide');
        }


        function Delete(i) {
            if (i == 'x') i = globalPayeeId;
            swal({
                title: "Are you sure?",
                text: "Once deleted, you will not be able to recover this Imprest!",
                buttons: [
                  'No',
                  'Yes'
                ],
            }).then(function (isConfirm) {
                if (isConfirm) {
                    $("#saveLoader-" + i + "").toggle(true)
                    $("#drop-" + i + "").toggle(false)
                    deleteItemConfirmed(data[i]["ImprestId"])
                } else {
                    swal("Cancelled", "No change was made");
                }
            });
            $('#confirmModal').modal('hide');
        }

        function deleteItemConfirmed(ImprestId) {
            var url = '@Url.Action("DeleteImprest", "Imprest")';
            $.ajax({
                type: "post",
                url: url,
                data: { "ImprestId": ImprestId },
                contenttype: "application/json; charset=utf-8",
                datatype: "json",
                success: function (response) {
                    if (response == "Success") {
                        swal("Deleted Successfully!", { icon: "success" })
                            .then((value) => {
                                window.location.reload();
                            });
                    }
                    else {
                        swal(response);
                    }

                },
                failure: function (error) {
                    swal(error);
                }
            });
        }

        function confirmImprest(i) {
            var imprestType = data[i]["ImprestTypeDesc"];
            var id = data[i]["ImprestId"];
            if (imprestType == "Micro Value") {
                var url = '@Url.Action("GetPayerAccounts", "Imprest")';
                 $.ajax({
                     type: "POST",
                     url: url,
                     data: { id: id },
                     success: function (response) {
                         debugger
                         if (response.res == "Success") {
                             payerAccounts = response.data;
                             $("#confirmImprestModal #PayerBankAccount").empty();
                             $('<option value="" selected>------Select-------</option>').appendTo('#confirmImprestModal #PayerBankAccount');
                             $.each(payerAccounts, function (i, d) {
                                 $('<option value=' + d.Id + '>' + d.AccountNumber + '-' + d.Currency + '-' + d.AccountName + '</option>').appendTo('#confirmImprestModal #PayerBankAccount');
                             });

                             $("#confirmImprestModal #id").val(id);
                             $("#confirmImprestModal").modal('show');
                         }
                         else {
                             swal(response.res);
                         }

                     }
                 });

            }
            else {
                confirmDialog(i);
            }
        }

        function confirmForm() {
            debugger
            var url = '@Url.Action("ConfirmImprest", "Imprest")';
            var ImprestId = $("#confirmImprestModal #id").val();
            var PayerBankAccount = $("#confirmImprestModal #PayerBankAccount").val();
            if (PayerBankAccount == null || PayerBankAccount == "") {
                swal("please select payer bank account first");
                return false;
            }
            swal({
                title: 'Confirm this Imprest ?',
                text: "This process cannot be undone",
                buttons: [
                    'No',
                    'Yes'
                ],
            }).then(function (isConfirm) {
                debugger
                if (isConfirm) {
                    $.ajax({
                        type: "post",
                        url: url,
                        data: { "ImprestId": ImprestId, "PayerBankAccount": PayerBankAccount },
                        contenttype: "application/json; charset=utf-8",
                        datatype: "json",
                        success: function (response) {
                            if (response == "Success") {
                                swal("Confirmed Successfully!", { icon: "success" })
                                    .then((value) => {
                                        window.location.reload();
                                    });
                            }
                            else {
                                swal(response);
                            }

                        },
                        failure: function (error) {
                            swal(error);
                        }
                    });
                    $('#confirmImprestModal').modal('hide');
                }
                else {
                    swal("Cancelled", "No change was made");
                    $('#confirmImprestModal').modal('hide');
                }
            });


        }

        function confirmDialog(i) {
            if (i == 'x') i = globalPayeeId;
            swal({
                title: 'Confirm this Imprest ?',
                text: "This process cannot be undone",
                buttons: [
                  'No',
                  'Yes'
                ],
            }).then(function (isConfirm) {
                if (isConfirm) {
                    $("#saveLoader-" + i + "").toggle(true)
                    $("#drop-" + i + "").toggle(false)
                    confirmPendingImprest(data[i]["ImprestId"]);
                } else {
                    swal("Cancelled", "No change was made");
                }
            });

        }



        function confirmPendingImprest(ImprestId) {
            var url = '@Url.Action("ConfirmImprest", "Imprest")';
            $.ajax({
                type: "post",
                url: url,
                data: { "ImprestId": ImprestId },
                contenttype: "application/json; charset=utf-8",
                datatype: "json",
                success: function (response) {
                    if (response == "Success") {
                        swal("Confirmed Successfully!", { icon: "success" })
                            .then((value) => {
                                window.location.reload();
                            });
                    }
                    else {
                        swal(response);
                    }

                },
                failure: function (error) {
                    swal(error);
                }
            });
            $('#confirmModal').modal('hide');
        }


        function cancelDialog(i) {
            if (i == 'x') i = globalPayeeId;
            swal({
                title: 'Cancel this Imprest ?',
                text: "This process cannot be undone",
                buttons: [
                  'No',
                  'Yes'
                ],
            }).then(function (isConfirm) {
                if (isConfirm) {
                    $("#saveLoader-" + i + "").toggle(true)
                    $("#drop-" + i + "").toggle(false)
                    cancelImprest(data[i]["ImprestId"]);
                } else {
                    swal("Cancelled", "No change was made");
                }
            });

        }


        function cancelImprest(id) {
            var url = '@Url.Action("CancelImprest", "Imprest")';
            $.ajax({
                type: "post",
                url: url,
                data: { id, remarks: "Cancelled" },
                contenttype: "application/json; charset=utf-8",
                datatype: "json",
                success: function (response) {
                    if (response == "Success") {
                        swal("Cancelled Successfully!", { icon: "success" })
                            .then((value) => {
                                window.location.reload();
                            });
                    }
                    else {
                        swal(response);
                    }

                },
                failure: function (error) {
                    swal(error);
                }
            });
            $('#confirmModal').modal('hide');
        }


    function rejectDialog(i) {
           swal({
               text: 'Rejection Reason',
               content: "input",
               button: {
                   text: "SAVE",
                   closeModal: true,
               },
           }).then(remark => {
               if (!remark) {
                   swal("No reason was provided");
               } else {
                   $("#saveLoader-" + i + "").toggle(true)
                   $("#drop-" + i + "").toggle(false)
                   rejectImprest(data[i]["ImprestId"], remark);
               };
           });
           $('#confirmModal').modal('hide');
       }

        function rejectImprest(id, remarks) {
           var url = '@Url.Action("CancelImprest", "Imprest")';
           $.ajax({
               type: "post",
               url: url,
               data: { id, remarks },
               contenttype: "application/json; charset=utf-8",
               datatype: "json",
               success: function (response) {
                   if (response == "Success") {
                       swal("Rejected Successfully!", { icon: "success" })
                           .then((value) => {
                               window.location.reload();
                           });
                   }
                   else {
                       swal(response);
                   }

               },
               failure: function (error) {
                   swal(error);
               }
           });
           $('#confirmModal').modal('hide');
       }



        var imprestId = null;
        function attachSlip(ImprestId) {
            imprestId = ImprestId;
            $('#attachFileModal').modal('show');
        }

        $("#saveLoader").toggle(false);
        function uploadForm() {
            swal({
                text: "Save this form?",
                buttons: ["NO", "YES"],
            }).then((confirmed) => {
                if (confirmed) {
                    uploadFilesConfirmed();
                } else {
                    swal("Cancelled");
                }
            });
        }

        function uploadFilesConfirmed() {
            var formData = new FormData();
            formData.append('payeeId', payeeId);
            formData.append('fileName', $('input[type=file]')[0].files[0]);
            $("#form_submision").prop('disabled', true);
            $("#saveLoader").toggle(true);
            $.ajax({
                url: '@Url.Action("AttachVendorForm", "Payees")',
                data: formData,
                type: 'POST',
                contentType: false,
                processData: false,
                success: function (response) {
                    $("#form_submision").prop('disabled', false);
                    $("#saveLoader").toggle(false);
                    if (response == "Success") {
                        swal("Attached successfully!", { icon: 'success' })
                          .then((e) => {
                              $('#attachFileModal').modal('hide');
                              window.location.reload();
                          });
                    } else {
                        swal(response)
                         .then((e) => {
                             $('#attachFileModal').modal('hide');
                             window.location.reload();
                         });
                    }

                },
                failure: function (error) {
                    $("#form_submision").prop('disabled', false);
                    $("#saveLoader").toggle(false);
                    swal(error)
                     .then((e) => {
                         $('#attachFileModal').modal('hide');
                         window.location.reload();
                     });
                }
            });
        }


        function attach(i) {
            window.location.href =
                '@Url.Action("AttachmentEntry", "PaymentVoucherAttachments")/?groupId=' + data[i]["ImprestId"] + '&&sourceModule=' + "Imprest";
        }

        function viewAttachment(i) {
            window.location.href =
                '@Url.Action("AttachmentView", "PaymentVoucherAttachments")/?groupId=' + data[i]["ImprestId"] + '&&sourceModule=' + "Imprest";
        }
    </script>
}
