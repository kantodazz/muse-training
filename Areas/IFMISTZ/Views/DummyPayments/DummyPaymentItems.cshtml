@model IFMIS.Areas.IFMISTZ.Models.DummyPaymentItemsVM

<!-- MAIN CONTENT -->
<div id="content" style="margin: 5px; padding-top: 30px">

    <div class="row">
        <div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
            <h1 class="page-title txt-color-blueDark">

                <!-- PAGE HEADER -->
                <!--
                <i class="fa-fw fa fa-pencil-square-o"></i>
                Payments
                <span>
                    >
                    Bills
                </span>
                    -->
            </h1>
        </div>

        <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
            <!-- Button trigger modal -->
            <!--<a data-toggle="modal" href="#myModal" class="btn btn-success btn-lg pull-right header-btn hidden-mobile"><i class="fa fa-circle-arrow-up fa-lg"></i> Launch form modal</a>-->
        </div>
    </div>

    <!--
    <div class="alert alert-block alert-success">
        <a class="close" data-dismiss="alert" href="#">×</a>
        <h4 class="alert-heading"><i class="fa fa-check-square-o"></i> Check validation!</h4>
        <p>
            You may also check the form validation by clicking on the form action button. Please try and see the results below!
        </p>
    </div>
        -->
    <!-- widget grid -->
    <section id="widget-grid" class="">


        <!-- START ROW -->

        <div class="row">

            <!-- NEW COL START -->
            <article class="col-sm-12 col-md-12 col-lg-12">

                <!-- Widget ID (each widget will need unique ID)-->
                <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false" data-widget-custombutton="false" data-widget-colorbutton="false" data-widget-deletebutton="false" data-widget-togglebutton="false">
                    <!-- widget options:
                        usage: <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false">

                        data-widget-colorbutton="false"
                        data-widget-editbutton="false"
                        data-widget-togglebutton="false"
                        data-widget-deletebutton="false"
                        data-widget-fullscreenbutton="false"
                        data-widget-custombutton="false"
                        data-widget-collapsed="true"
                        data-widget-sortable="false"

                    -->
                    <header>
                        <span class="widget-icon"> <i class="fa fa-edit"></i> </span>
                        <h2> Dummy Payment Items </h2>

                    </header>

                    <!-- widget div-->
                    <div>

                        <!-- widget edit box -->
                        <div class="jarviswidget-editbox">
                            <!-- This area used as dropdown edit box -->

                        </div>
                        <!-- end widget edit box -->
                        <!-- widget content -->
                        <div class="widget-body">
                            <dl class="dl-horizontal">
                                <dt>
                                    @Html.DisplayNameFor(model => model.DummyPayment.ReferenceNo)
                                </dt>

                                <dd>
                                    @Html.DisplayFor(model => model.DummyPayment.ReferenceNo)
                                </dd>

                                <dt>
                                    @Html.DisplayNameFor(model => model.DummyPayment.OperationalAmount)
                                </dt>

                                <dd>
                                    @Html.DisplayFor(model => model.DummyPayment.OperationalAmount)
                                </dd>

                                <dt>
                                    @Html.DisplayNameFor(model => model.DummyPayment.OperationalCurrency)
                                </dt>

                                <dd>
                                    @Html.DisplayFor(model => model.DummyPayment.OperationalCurrency)
                                </dd>

                                <dt>
                                    @Html.DisplayNameFor(model => model.DummyPayment.ApplyDate)
                                </dt>

                                <dd>
                                    @Html.DisplayFor(model => model.DummyPayment.ApplyDate, "_ShortDateTime")
                                </dd>

                                <dt>
                                    @Html.DisplayNameFor(model => model.DummyPayment.ReceivingBankName)
                                </dt>

                                <dd>
                                    @Html.DisplayFor(model => model.DummyPayment.ReceivingBankName)
                                </dd>

                                <dt>
                                    @Html.DisplayNameFor(model => model.DummyPayment.ReceivingBankAccountNo)
                                </dt>

                                <dd>
                                    @Html.DisplayFor(model => model.DummyPayment.ReceivingBankAccountNo)
                                </dd>

                                <dt>
                                    @Html.DisplayNameFor(model => model.DummyPayment.ReceivingBankAccountName)
                                </dt>

                                <dd>
                                    @Html.DisplayFor(model => model.DummyPayment.ReceivingBankAccountName)
                                </dd>

                                <dt>
                                    @Html.DisplayNameFor(model => model.DummyPayment.DrGlAccount)
                                </dt>

                                <dd>
                                    @Html.DisplayFor(model => model.DummyPayment.DrGlAccount)
                                </dd>

                                <dt>
                                    @Html.DisplayNameFor(model => model.DummyPayment.DrGlAccountDesc)
                                </dt>

                                <dd>
                                    @Html.DisplayFor(model => model.DummyPayment.DrGlAccountDesc)
                                </dd>

                                <dt>
                                    @Html.DisplayNameFor(model => model.DummyPayment.FundingSourceCode)
                                </dt>

                                <dd>
                                    @Html.DisplayFor(model => model.DummyPayment.FundingSourceCode)
                                </dd>

                                <dt>
                                    @Html.DisplayNameFor(model => model.DummyPayment.FundingSourceDesc)
                                </dt>

                                <dd>
                                    @Html.DisplayFor(model => model.DummyPayment.FundingSourceDesc)
                                </dd>

                                <dt>
                                    @Html.DisplayNameFor(model => model.DummyPayment.CrGlAccount)
                                </dt>

                                <dd>
                                    @Html.DisplayFor(model => model.DummyPayment.CrGlAccount)
                                </dd>

                                <dt>
                                    @Html.DisplayNameFor(model => model.DummyPayment.CrGlAccountDesc)
                                </dt>

                                <dd>
                                    @Html.DisplayFor(model => model.DummyPayment.CrGlAccountDesc)
                                </dd>
                            </dl>

                            <hr />
                            <div class="row">
                                <div class="col-md-2"><b>Allocation Balance:</b></div>
                                <div class="col-md-2">@Html.DisplayFor(model => model.AllocationBalance, "_DecimalThousands")</div>
                            </div>
                            <div class="row">
                                <div class="col-md-2"><b>Expenditure Balance:</b></div>
                                <div class="col-md-2">@Html.DisplayFor(model => model.ExpenditureBalance, "_DecimalThousands")</div>
                            </div>
                            <hr />

                            <table class="table table-condensed table-stripped table-hover table-bordered">
                                <thead>
                                    <tr>
                                        <th colspan="5">
                                            GL Items
                                        </th>
                                    </tr>
                                    <tr>
                                        <th>#</th>
                                        <th>Gl Account</th>
                                        <th>Allocated Amount</th>
                                        <th>Expensed Amount</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        int i = 0;
                                    }
                                    @foreach (var item in Model.DummyPayment.DummyPaymentDetails.OrderByDescending(a => a.DummyPaymentDetailId))
                                    {
                                        i++;
                                        <tr>
                                            <td>@i</td>
                                            <td>@item.GlAccount</td>
                                            <td style="text-align: right">@Html.DisplayFor(model => item.ExpensedAmount, "_DecimalThousands")</td>
                                            <td>
                                                <a href="#">
                                                    <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                                                </a> |
                                                <a href="#" onclick="deleteDummyPaymentDetail(@item.DummyPaymentDetailId)">
                                                    <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                    <tr>
                                        <td colspan="2" style="text-align: center"><b>Total</b></td>
                                        <td style="text-align: right">@Html.DisplayFor(model => model.TotalAllocatedAmount, "_DecimalThousands")</td>
                                        <td style="text-align: right">@Html.DisplayFor(model => model.TotalExpensedAmount, "_DecimalThousands")</td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>

                            <hr />

                            <form action="@Url.Action("AddDummyPaymentDetail")" method="post" class="form-horizontal">
                                @Html.AntiForgeryToken()
                                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                                @Html.HiddenFor(model => model.DummyPaymentId)
                                @Html.HiddenFor(model => model.TotalAmount)
                                @Html.HiddenFor(model => model.TotalAllocatedAmount)
                                @Html.HiddenFor(model => model.TotalExpensedAmount)
                                @Html.HiddenFor(model => model.GlAccount)
                                @Html.HiddenFor(model => model.GlAccountDesc)

                                <div class="form-group">
                                    @Html.LabelFor(model => model.GlAccountCoaId, htmlAttributes: new { @class = "control-label col-md-2" })
                                    <div class="col-md-8">
                                        @Html.EditorFor(model => model.GlAccountCoaId, new { htmlAttributes = new { @class = "form-control" } })
                                        @Html.ValidationMessageFor(model => model.GlAccountCoaId, "", new { @class = "text-danger" })
                                    </div>
                                </div>

                                <div class="form-group">
                                    @Html.LabelFor(model => model.AllocatedAmount, htmlAttributes: new { @class = "control-label col-md-2" })
                                    <div class="col-md-3">
                                        @Html.EditorFor(model => model.AllocatedAmount, new { htmlAttributes = new { @class = "form-control" } })
                                    </div>
                                    <div class="col-md-5">
                                        @Html.ValidationMessageFor(model => model.AllocatedAmount, "", new { @class = "text-danger" })
                                    </div>
                                </div>

                                <div class="form-group">
                                    @Html.LabelFor(model => model.ExpensedAmount, htmlAttributes: new { @class = "control-label col-md-2" })
                                    <div class="col-md-3">
                                        @Html.EditorFor(model => model.ExpensedAmount, new { htmlAttributes = new { @class = "form-control", @readonly = true } })
                                    </div>
                                    <div class="col-md-5">
                                        @Html.ValidationMessageFor(model => model.ExpensedAmount, "", new { @class = "text-danger" })
                                    </div>
                                </div>

                                @{ 
                                    var confirmStatus = "disabled";
                                    var addGLStatus = "disabled";
                                    if (Model.AllocationBalance == 0 && Model.ExpenditureBalance == 0)
                                    {
                                        confirmStatus = "enabled";
                                    }
                                    if (!(Model.AllocationBalance == 0 && Model.ExpenditureBalance == 0))
                                    {
                                        addGLStatus = "enabled";
                                    }
                                }
                                <div class="form-actions">
                                    <div class="row">
                                        <div class="col-md-8 col-md-offset-2">
                                            <a href="@Url.Action("PendingDummyPayments", "DummyPayments")" class="btn btn-info" style="float: left">
                                                <i class="fa fa-arrow-left"></i>
                                                Back
                                            </a>
                                            <button class="btn btn-info" type="submit" style="float: left; margin-left: 5px" @addGLStatus>
                                                <i class="fa fa-plus"></i>
                                                Add GL Item
                                            </button>
                                            <button class="btn btn-info" type="button" style="float: left; margin-left: 5px" onclick="confirmDummyPayment(@Model.DummyPaymentId)" @confirmStatus>
                                                <i class="fa fa-thumbs-up"></i>
                                                Confirm Payment
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>

                        </div>
                        <!-- end widget content -->
                    </div>
                    <!-- end widget div -->

                </div>
                <!-- end widget -->

            </article>
            <!-- END COL -->

        </div>

        <!-- END ROW -->

    </section>
    <!-- end widget grid -->

</div>

<!--Start of delete confirmation modal section-->
<div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="lblmodal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header alert alert-danger" style="font:bold 16px Trebuchet MS, Lucida Sans Unicode, Lucida Grande, Lucida Sans, Arial, sans-serif">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>

                <h4 class="modal-title" id="lblmodal">Confirm Delete</h4>
            </div>
            <div class="modal-body" id="modal-body">
                <p class="success-message">Are you sure you want to delete this record ? </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-info delete-confirm">Yes</button>
                <button class="btn btn-info confirm-confirm">Yes</button>
                <button class="btn btn-default delete-cancel" data-dismiss="modal">No</button>
            </div>
        </div>
    </div>
</div>
<!--End of delete confirmation modal section-->

<!--Start of details modal section-->
<div class="modal fade" id="modal-details" tabindex="-1" role="dialog" aria-labelledby="lbl-modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header alert alert-info" style="font:bold 16px Trebuchet MS, Lucida Sans Unicode, Lucida Grande, Lucida Sans, Arial, sans-serif">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>

                <h4 class="modal-title" id="lbl-modal-details">Payment Details</h4>
            </div>
            <div class="modal-body" id="modal-details-body" style="padding: 0px">
            </div>
            <div class="modal-footer">
                <button class="btn btn-default delete-cancel" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!--End of details modal section-->

@section pagespecific {
    <script type="text/javascript">
        $(function myfunction() {
            $("#GlAccountCoaId").select2({
                minimumInputLength: 2,  // minimumInputLength for sending ajax request to server
                width: 'resolve',   // to adjust proper width of select2 wrapped elements
                placeholder: 'Search Gl Account',
                allowClear: false,
                initSelection: function (element, callback) {
                    var id = $(element).val();
                    if (id !== "") {
                        $.ajax('@Url.Action("GetSelectedBudgetCoa", "DummyPayments")', {
                            data: { id: id },
                            dataType: "json"
                        }).done(function (data) {
                            callback(data);
                        });
                    }
                },
                ajax: {
                    url: '@Url.Action("GetBudgetCoaStrings", "DummyPayments")', // Controller - Select2Demo and Action -AccessRemoteData
                    type: "POST",
                    dataType: 'json',
                    data: function (term) {
                        return {
                            id: '@Model.DummyPayment.FundingSourceCode',
                            term: term
                        };
                    },
                    results: function (data, page) {
                        return { results: data.coas }; // data.CountryList returning json data from Controlle
                    }
                }
            });

            $('#AllocatedAmount').autoNumeric('init');
            $('#ExpensedAmount').autoNumeric('init');
        });

        $('#GlAccountCoaId').on("change", function (e) {
            var glAccountCoaId = $("#GlAccountCoaId").val();
            var url = '@Url.Action("GetBudgetCoa")';
            $.ajax({
                type: "GET",
                url: url,
                data: { id: glAccountCoaId },
                success: function (data, status, jqXHR) {
                    if (data.success) {
                        $("#GlAccount").val(data.GlAccount);
                        $("#GlAccountDesc").val(data.GlAccountDesc);
                    } else {
                        alert('Error on accessing GL details');
                    }
                },
                error: function () {
                    alert("Error on accessing GL details");
                }
            })
            //alert(crGlAccountId);
        });

        $("#AllocatedAmount").keyup(function () {
            $("#ExpensedAmount").val($(this).val());
        });

        var deleteDummyPaymentDetail = function (id) {
            if ($('.modal-header').hasClass('alert-info')) {
                $('.modal-header').removeClass('alert-info').addClass('alert-danger');
            }
            $('.modal-header').html('').html('Confirm Delete');
            $('.success-message').html('').html('Are you sure you want to delete this record ?');
            $('.delete-confirm').css('display', 'inline');
            $("#modal").modal({
                backdrop: "static",
                keyboard: false
            });

            $(".delete-confirm").click(function () {
                if (id != "") {
                    var url = '@Url.Action("Delete", "DummyPaymentDetails")';
                    $.ajax({
                        url: url,
                        data: { id: id },
                        type: "POST",
                        success: function (response) {
                            if (response == "Success") {
                                //now re-using the boostrap modal popup to show info message.
                                //dynamically we will change background colour
                                if ($('.modal-header').hasClass('alert-danger')) {
                                    $('.modal-header').removeClass('alert-danger').addClass('alert-info');
                                    //hide ok button as it is not necessary
                                    $('.delete-confirm').css('display', 'none');
                                    $('.delete-cancel').html('Close').click(function () {
                                        location.reload();
                                    });
                                } else {
                                    //hide ok button as it is not necessary
                                    $('.delete-confirm').css('display', 'none');
                                    $('.delete-cancel').html('Close').click(function () {
                                        location.reload();
                                    });
                                }
                                $('.success-message').html('Record deleted successfully');
                            }
                            else {
                                //hide ok button as it is not necessary
                                $('.delete-confirm').css('display', 'none');
                                $('.delete-cancel').html('Close').click(function () {
                                    location.reload();
                                });
                                $('.success-message').html(response);
                            }
                        }, error: function (err) {
                            if (!$('.modal-header').hasClass('alert-danger')) {
                                $('.modal-header').removeClass('alert-info').addClass('alert-danger');
                                $('.delete-confirm').css('display', 'none');
                            }
                            $('.success-message').html(err.statusText);
                        }
                    });
                }
            });
        };

        var dummyPaymentDetails = function (id) {
            var url = '@Url.Action("DummyPaymentDetails", "DummyPayments")/' + id;

            if ($('.modal-header').hasClass('alert-danger')) {
                $('.modal-header').removeClass('alert-danger').addClass('alert-info');
            }

            $("#modal-details-body").load(url, function () {
                $("#modal-details").modal({
                    backdrop: "static",
                    keyboard: false
                });
            });
        };

        var confirmDummyPayment = function (id) {

            if ($('.modal-header').hasClass('alert-danger')) {
                $('.modal-header').removeClass('alert-danger').addClass('alert-info');
            }
            $('.modal-header').html('').html('Confirm Payment');
            $('.success-message').html('').html('Are you sure you want to confirm this payment ?');
            $('.delete-confirm').css('display', 'none');
            $('.confirm-confirm').css('display', 'inline');
            $("#modal").modal({
                backdrop: "static",
                keyboard: false
            });

            $(".confirm-confirm").click(function () {
                if (id != "") {
                    var url = '@Url.Action("ConfirmDummyPayment", "DummyPayments")';
                    $.ajax({
                        url: url,
                        data: { id: id },
                        type: "POST",
                        success: function (response) {
                            if (response == "Success") {
                                //now re-using the boostrap modal popup to show info message.
                                //hide ok button as it is not necessary
                                $('.confirm-confirm').css('display', 'none');
                                $('.delete-cancel').html('Close').click(function () {
                                    location.reload();
                                });
                                $('.success-message').html('Payment confirmed successfully');
                                window.location.href = '@Url.Action("ConfirmedDummyPayments", "DummyPayments")';
                            }
                            else {
                                //hide ok button as it is not necessary
                                $('.delete-confirm').css('display', 'none');
                                $('.confirm-confirm').css('display', 'none');
                                $('.delete-cancel').html('Close').click(function () {
                                    location.reload();
                                });
                                $('.success-message').html(response);
                            }
                        }, error: function (err) {
                            if (!$('.modal-header').hasClass('alert-danger')) {
                                $('.modal-header').removeClass('alert-info').addClass('alert-danger');
                                $('.delete-confirm').css('display', 'none');
                            }
                            $('.success-message').html(err.statusText);
                        }
                    });
                }
            });
        };
    </script>
}

