@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    .search-container {
        background-color: white;
        color: black;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 3px;
        padding-right: 10px;
        padding-left: 10px;
    }

    .info-box {
        padding: 8px;
        background-color: #ECF3F8;
        text-align: center;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .search-btn {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 5px;
        padding-right: 10px;
    }

    input[type=search] {
        padding: 4px;
        border: hidden;
        border-radius: 4px;
    }

    select {
        padding: 8px;
        border: 1px solid #ccc;
        resize: vertical;
        width: 200px;
    }

    input[type=text] {
        padding: 5px;
        border: 1px solid #ccc;
    }

    .name-input-container {
        display: inline-flex;
        flex: 1 1 300px;
        position: relative;
        overflow: hidden;
    }
</style>
<div id="content" style="margin: 5px; padding-top: 30px">

    <div class="row">

    </div>
    <section id="widget-grid" class="">
        <div class="row">
            <article class="col-sm-12 col-md-12 col-lg-12">
                <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false" data-widget-custombutton="false" data-widget-colorbutton="false" data-widget-deletebutton="false" data-widget-togglebutton="false">
                    <header>
                        <span class="widget-icon"> <i class="fa fa-edit"></i> </span>
                        <h2>Generate Batch</h2>

                    </header>
                    <div>
                        <div class="jarviswidget-editbox">
                        </div>
                        <div class="widget-body">
                            <div class="row">
                                <div class="col-md-2">
                                    <button class="btn btn-info" id="confirm" onclick="generateBatch()">
                                        Generate
                                    </button>
                                </div>
                                <div class="col-md-1">
                                    <select id="LoanApprovalAuthority">
                                        <option value="msg"> --- Select Approval Authority --- </option>
                                        @foreach (var ap in ViewBag.LoanApprovalLevels)
                                        {
                                            <option value="@ap.MaximumAmount">
                                                @ap.ApprovalLevelDesc
                                            </option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-2"></div>
                                <div class="col-md-4">
                                    <div id="infoPanel">
                                        <div class="info-box"><strong id="selectedItems">No Item(s) Selected</strong></div>
                                    </div>
                                </div>
                             @*   <div class="col-md-1"></div>*@
                                <div class="col-md-3">
                                    <div class="search-container" style="float:right">
                                        <i class="fa fa-search searchIcon"></i>
                                        <input type="search" name="search" placeholder="Search..." id="searchbox1" >
                                    </div>
                                </div>
                            </div>
                            <table id="dt_table" class="table table-striped table-bordered table-hover table-condensed" width="100%">
                                <thead>
                                    <tr style="background-color: #f5f5f5; color:black">
                                        <th>#</th>
                                        <th><input type="checkbox" onchange="checkAll()" id="checkall" /></th>
                                        <th>Application No</th>
                                        <th>Customer Name</th>
                                        <th>Applied Loan Amount</th>
                                        <th>Loan Purpose</th>
                                        <th>Repayment Source</th>
                                        <th>OverAll Status</th>
                                        <th>Created At</th>
                                    </tr>
                                </thead>

                            </table>
                        </div>
                    </div>
                </div>
            </article>
        </div>
    </section>
</div>

@section pagespecific{
    <script>

        var dt_table = $('#dt_table').dataTable({
            "language": {
                "zeroRecords": "No records found"
            }
        });
        $("#dt_table_wrapper .dt-toolbar").remove();
        var w_data = []
        function LoadData() {
            $("#loader").text("Loading...")
            var url = '@Url.Action("GetLoanApplications", "LoanAuthorization")';
            $.ajax({
                type: "GET",
                url: url,
                data: {
                    status1: 'Approved in Loan Appraisal',
                    status2: 'UnGenerated'
                },
                contenttype: "application/json; charset=utf-8",
                datatype: "json",
                success: function (response) {
                    w_data = response.data;
                    dt_table.fnClearTable();
                    for (var i = 0; i < w_data.length; i++) {
                        var Id = w_data[i].a.LoanApplicationId;
                        dt_table.fnAddData([i + 1,
                         '<input type="checkbox" id="row-' + Id + '" onchange="rowChecked(' + Id + ')"/>',
                         w_data[i].a.ApplicationNo,
                         w_data[i].a.LoanCustomer.CustomerName,
                         toLabel(w_data[i].a.AppliedLoanAmount||0),
                         w_data[i].a.LoanPurpose,
                         w_data[i].a.RepaymentSource,
                         w_data[i].a.OverAllStatus,
                         w_data[i].a.FCreatedAt
                        ]);
                    }
                },
                failure: function (error) {
                    swal(error);
                }
            });
        }

        LoadData();

        var checkedRows = [];

        function rowChecked(rowId) {
            console.log(rowId)
            if ($("#row-" + rowId).is(":checked")) {
                checkedRows.push(rowId);
            } else {
                remove(checkedRows, rowId);
            }
            toggleConfirmButton();

        }

        function checkAll() {
            checkedRows = [];
            if ($("#checkall").is(":checked")) {
                for (var i = 0; i < w_data.length; i++) {
                    var Id = w_data[i].a.LoanApplicationId
                    checkedRows.push(Id);
                    $("#row-" + Id).prop('checked', true);
                }
            } else {
                for (var i = 0; i < w_data.length; i++) {
                    var Id = w_data[i].a.LoanApplicationId
                    $("#row-" + Id).prop('checked', false);
                }
            }
            toggleConfirmButton();
        }

        $("#confirm").attr('disabled', true);

        var TotalAmount = 0;
        function toggleConfirmButton() {
             TotalAmount = 0;
            if (checkedRows.length > 0) {
                checkedRows.forEach(rowId=> {
                    var row = w_data.filter(v => v.a.LoanApplicationId == rowId)[0];
                    console.log(row)
                    TotalAmount = TotalAmount + toNumber(row.a.AppliedLoanAmount);
                });
                $("#confirm").attr('disabled', false);
                $("#selectedItems").text(checkedRows.length + " Item(s) Selected ~ Total: " + toLabel(TotalAmount));
            } else {
                $("#confirm").attr('disabled', true);
                $("#selectedItems").text("No Item(s) Selected");
            }
        }

        function remove(array, val) {
            var found = array.indexOf(val);
            while (found !== -1) {
                array.splice(found, 1);
                found = array.indexOf(val);
            }
        }

        function generateBatch() {
            swal({
                text: "Generate Batch for Selected Applications(s)?",
                buttons: ["NO", "YES"],
            }).then((willGenerate) => {
                if (willGenerate) {
                    postGeneratedBatch();
                    downloadURI("data:text/html,SAMPLE BATCH!", "GENERATED_BATCH.pdf");
                } else {
                    swal("Cancelled");
                }
            });
        }
        function downloadURI(uri, name) {
            var link = document.createElement("a");
            link.download = name;
            link.href = uri;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            delete link;
        }
        function postGeneratedBatch() {
                var url = '@Url.Action("GenerateBatch", "LoanAuthorization")';
                $.ajax({
                    type: "post",
                    url: url,
                    data: { Ids: checkedRows, AppliedAmount:TotalAmount },
                    contenttype: "application/json; charset=utf-8",
                    datatype: "json",
                    success: function (response) {
                        if (response == 'Success') {
                            swal("Generated successfully!",
                                { icon: "success" }
                                ).then((e) => {
                                window.location.reload();
                            });
                        } else {
                            swal(response);
                        }
                    },
                    failure: function (error) {
                        swal(error);
                    }
                });
        }

    </script>
}
