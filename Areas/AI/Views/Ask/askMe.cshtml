@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /*Chat Container */
    #chatContainer {
        width: 600%;
        max-width: 600px;
        height: 300px;
        background: linear-gradient(135deg, #E3F2FD, #D6EAF8);
        border-radius: 20px;
        box-shadow: 0px 8px 20px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        border: 1px solid #d1d9e6;
    }

    /* Chat Bubbles */
    .message {
        padding: 14px 20px;
        margin: 5px;
        border-radius: 20px;
        max-width: 75%;
        font-size: 15px;
        line-height: 1.6;
        word-wrap: break-word;
        position: relative;
        box-shadow: 2px 4px 8px rgba(0, 0, 0, 0.05);
    }

    /* User Messages */
    .userMessage {
        background: #007bff;
        color: white;
        align-self: flex-end;
        text-align: left;
        border-bottom-right-radius: 8px;
        transition: 0.3s;
    }

    /* Bot Messages */
    .botMessage {
        background: #FFFBCC;
        color: black;
        align-self: flex-start;
        text-align: left;
        border-bottom-left-radius: 8px;
        box-shadow: 2px 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Typing Indicator */
    .thinking {
        background: #ddd;
        color: black;
        font-style: italic;
        padding: 10px;
        border-radius: 15px;
    }

    /* Input Box & Buttons */
    #inputArea {
        display: flex;
        justify-content: center;
        width: 400%;
        max-width: 600px;
        margin-top: 10px;
    }

    #questionBox {
        flex: 1;
        padding: 12px;
        border: 2px solid #ccc;
        border-radius: 25px;
        outline: none;
        font-size: 15px;
        transition: 0.3s;
    }

        #questionBox:focus {
            border-color: #007bff;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
        }

    /* Buttons */
    #askButton, #voiceButton {
        padding: 12px 18px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        margin-left: 10px;
        font-size: 14px;
        transition: 0.3s;
    }

        #askButton:hover, #voiceButton:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }

    /*  Quick Question Buttons */
    #quickQuestions {
        margin-top: 10px;
    }

    .quickBtn {
        padding: 10px 15px;
        background: white;
        border: 2px solid #ccc;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        margin: 5px;
        display: inline-flex;
        align-items: center;
        transition: 0.3s;
    }

        .quickBtn:hover {
            background: #e9ecef;
            border-color: #007bff;
        }

    /*Typing Animation */
    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .loadingIcon {
        display: inline-block;
        animation: spin 1s linear infinite;
        font-size: 16px;
        margin-left: 5px;
    }

    /* Dramatic Heading */
    #chatHeading {
        font-size: 20px;
        font-weight: bold;
        color: white;
        text-align: center;
        margin-bottom: 10px;
        padding: 12px 0;
        background: linear-gradient(135deg, #007bff, #4a90e2);
        border-radius: 12px;
        width: 600%;
        max-width: 600px;
        box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.1);
        letter-spacing: 1px;
        text-transform: uppercase;
    }
</style>

<div id="content">
    <div class="row">
        <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3"></div>
    </div>

    <section id="widget-grid">
        <div class="row">
            <article class="col-sm-12 col-md-12 col-lg-12">
                <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false" data-widget-custombutton="false">
                    <header>
                        <span class="widget-icon"> <i class="fa fa-edit"></i> </span>
                        <h2> AI Assistant </h2>
                    </header>
                    <div>
                        <div class="widget-body col-md-offset-3">
                            <div id="chatHeading">Ask Anything About Muse</div>
                            <div id="chatContainer">
                                <div class="message botMessage">Hi, I am your AI assistant. How can I help you? 😊</div>
                            </div>

                            <div id="inputArea">
                                <input type="text" id="questionBox" placeholder="Type your question here..." onkeypress="handleKeyPress(event)">
                                <button id="askButton" onclick="askQuestion()">Ask</button>
                                <button id="voiceButton">🎤 Speak</button>
                            </div>

                            <div id="quickQuestions">
                                <button class="quickBtn" onclick="askPredefinedQuestion('How do I log in to the system?')">🔑 Login Help</button>
                                <button class="quickBtn" onclick="askPredefinedQuestion('How do I reset my password?')">🔄 Reset Password</button>
                            </div>

                            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

                            <script>
                                $(document).ready(function () {
                                    // ✅ Ensure the welcome message is always present
                                    if ($("#chatContainer").children().length === 0) {
                                        $("#chatContainer").append(`<div class="message botMessage">🤖 Hi, I am your AI assistant. How can I help you? 😊</div>`);
                                    }
                                });

                                function askQuestion() {
                                    let question = $("#questionBox").val();
                                    let chatContainer = $("#chatContainer");

                                    if (!question) {
                                        alert("Please enter your question!");
                                        return;
                                    }

                                    // Add user message to chat
                                    chatContainer.append(`<div class="message userMessage">${question}</div>`);

                                    // Clear input box
                                    $("#questionBox").val("");

                                    // Show animated "Thinking..." indicator with rotating 🔄 icon
                                    let loadingIndicator = $(`
                                                                        <div class="message botMessage thinking" id="loading">
                                                                            Thinking<span id="loadingDots">.</span>
                                                                            <span class="loadingIcon">🔄</span>
                                                                        </div>
                                                                    `);
                                    chatContainer.append(loadingIndicator);

                                    // Animate the "Thinking..." dots
                                    let dots = 1;
                                    let loadingAnimation = setInterval(() => {
                                        dots = (dots % 3) + 1; // Loop through 1 to 3 dots
                                        $("#loadingDots").text('.'.repeat(dots));
                                    }, 500);

                                    $.ajax({
                                        url: "http://10.1.87.43:5000/ask",
                                        type: "POST",
                                        contentType: "application/json",
                                        data: JSON.stringify({ question: question }),
                                        success: function (response) {
                                            clearInterval(loadingAnimation); // Stop the animation
                                            $("#loading").remove(); // Remove "Thinking..." message

                                            if (response.answer) {
                                                chatContainer.append(`<div class="message botMessage">${response.answer}</div>`);
                                            } else {
                                                chatContainer.append(`<div class="message botMessage"><strong>Error:</strong> No response received.</div>`);
                                            }
                                            chatContainer.scrollTop(chatContainer[0].scrollHeight); // Auto-scroll to latest message
                                        },
                                        error: function (xhr, status, error) {
                                            clearInterval(loadingAnimation); // ✅ Stop animation on error
                                            $("#loading").remove();
                                            console.error("Error Details:", xhr, status, error);
                                            chatContainer.append(`<div class="message botMessage"><strong>Error:</strong> ${xhr.responseText || "Unknown error"}</div>`);
                                        }
                                    });
                                }

                                function askPredefinedQuestion(question) {
                                    $("#questionBox").val(question);
                                    askQuestion();
                                }
                                // Enable Voice Recognition for "🎤 Speak" Button
                                document.getElementById("voiceButton").addEventListener("click", function () {
                                    let recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                                    recognition.lang = "en-US"; // Change to "sw-TZ" for Swahili if needed

                                    recognition.onstart = function () {
                                        $("#voiceButton").text("🎙️ Listening...");
                                    };

                                    recognition.onresult = function (event) {
                                        let transcript = event.results[0][0].transcript;
                                        $("#questionBox").val(transcript); // Insert recognized text into input field
                                        askQuestion(); // Automatically send the question
                                    };

                                    recognition.onerror = function (event) {
                                        console.error("Speech recognition error:", event.error);
                                        alert("Sorry, I couldn't understand. Try again!");
                                    };

                                    recognition.onend = function () {
                                        $("#voiceButton").text("🎤 Speak"); // Reset button text
                                    };

                                    recognition.start(); // Start listening
                                });
                                function handleKeyPress(event) {
                                    if (event.key === 'Enter') {
                                        askQuestion();
                                    }
                                }
                            </script>
                        </div>
                    </div>
                </div>
            </article>
        </div>
    </section>
</div>
