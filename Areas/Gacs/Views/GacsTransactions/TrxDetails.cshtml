@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@{
    ViewBag.Title = "Note Items";
}

<style>
    .search-btn {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 5px;
        padding-right: 10px;
        width: 40px;
    }

    .name-input-container {
        display: inline-flex;
        flex: 1 1 300px;
        position: relative;
        overflow: hidden;
    }

    .search-container {
        background-color: white;
        color: black;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 3px;
        padding-right: 10px;
        padding-left: 10px;
    }

    input[type=search] {
        padding: 4px;
        border: hidden;
    }


    td {
        padding: 5px;
    }
    
 .tooltip1 {
  position: relative;
  display: inline-block;
  cursor: pointer;
}

.tooltip1 .tooltiptext {
  visibility: hidden;
  padding: 8px;
  border: solid 1px #ccc;
  border-radius: 6px;
  padding: 5px 0;
  position: absolute;
  z-index: 1;
  top: -40px;
  left: 110%;
  box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
  transition: 0.3s;
  background-color: white;
}

.tooltip1 .tooltiptext::after {
  content: "";
  position: absolute;
  top: 50%;
  right: 100%;
  margin-top: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: transparent white transparent transparent;
}
.closetip{
    border: 0;
    outline: 0;
    color: #808080;
    left: 0;
    border-radius:100%;
}

.amount-input{
    border: 1px solid #ccc;
    outline: none;
    border-radius: 3px;
}

/*.tooltip1:target .tooltiptext {
  visibility: visible;
}*/

</style>
<div style="padding:1em;padding-top:4em">
    <section id="widget-grid">
        <div class="row">
            <article class="col-sm-12 col-md-12 col-lg-12">

                <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false" data-widget-custombutton="false" data-widget-colorbutton="false" data-widget-deletebutton="false" data-widget-togglebutton="false">

                    <header>
                        <span class="widget-icon"> <i class="fa fa-table"></i> </span>
                        <h2>@ViewBag.Title</h2>
                    </header>

                    <div>
                        <div class="widget-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div><strong>Financil Year:</strong> @ViewBag.Summary.FiscalYear</div>
                                    <div><strong>Note:</strong> @ViewBag.Summary.NoteId - @ViewBag.Summary.NoteDesc</div>
                                </div>
                                <div class="col-md-6">
                                    <div style="display:flex;justify-content:flex-end">
                                        <div style="margin-right:4px"><a class="btn btn-info" href="@Url.Action("TrxDetails", "gacstransactions")/?TrxSummaryID=@ViewBag.TrxSummaryID&&q=@ViewBag.q">@ViewBag.q</a></div>
                                        <div class="search-container" style="float:right">
                                            <i class="fa fa-search searchIcon"></i>
                                            <input type="search" name="search" placeholder="Search..." id="searchbox">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <table id="dt_table" class="table table-bordered table-condensed table-amount">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>GFS Description</th>
                                        <th>Actual Total</th>
                                        <th>Actual Up To1month</th>
                                        <th>Actual1 To3month</th>
                                        <th>Actual3 To12month</th>
                                        <th>Actual1 To3 Year</th>
                                        <th>Actual3 To5 Year</th>
                                        <th>Actual Above5 Year</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tfoot>
                                    <tr style="background-color:#FAF2CC">
                                        <th colspan="2"></th>
                                        <th id="ActualTotal"></th>
                                        <th id="ActualUpTo1month"></th>
                                        <th id="Actual1To3month"></th>
                                        <th id="Actual3To12month"></th>
                                        <th id="Actual1To3Year"></th>
                                        <th id="Actual3To5Year"></th>
                                        <th id="ActualAbove5Year"></th>
                                        <th></th>
                                    </tr>
                                </tfoot>
                            </table>
                            <hr />
                            <div>
                                <a class="btn btn-info" href='@Url.Action("DataEntry", "GacsTransactions")' style="margin-right:5px">
                                    <i class="glyphicon glyphicon-arrow-left"></i>Back
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </article>
        </div>
    </section>
</div>

@section pagespecific{

    <script>
        var dt_table = $('#dt_table').dataTable({
            "language": {
                "emptyTable": '<strong id="loader" style="color:green">No matching records found</strong>',
                "zeroRecords": "No matching records found"
            },
            paging: '@ViewBag.q' == 'DISPLAY ALL'
        });
        $("#searchbox").on("keyup search input paste cut", function () {
            dt_table.DataTable().search(this.value).draw();
        });
        $("#dt_table_wrapper .dt-toolbar").remove();

        var data = []
        function LoadData() {
            $("#loader").text("Loading...")
            $.ajax({
                type: "GET",
                url: '@Url.Action("GetGacsTrxDetails","GacsTransactions")',
                data: { TrxSummaryID: '@ViewBag.TrxSummaryID' },
                contenttype: "application/json; charset=utf-8",
                datatype: "json",
                success: function (response) {
                    data = response.data;
                    displayData()
                },
                failure: function (error) {
                    swal(error);
                }
            });
        }
        LoadData()

        function updateTrx(Id, label) {
            var amount = $(`#Amount_${Id}_${label}`).val()
            if (amount || amount == 0) {
                data = data.filter(a=> {
                    if (a.TrxID == Id) {
                        a[label] = amount
                        if (label != "ActualTotal") {
                            a.ActualTotal = a.ActualUpTo1month + a.Actual1To3month
                                + a.Actual3To12month + a.Actual1To3Year + a.Actual3To5Year + a.ActualAbove5Year;
                        }
                    }
                    return a
                })
                closeDialog(`${Id}_${label}`);
                displayData();
                updateBackend({ Id, label, amount });
            }
        }

        function updateBackend(params) {
            $.ajax({
                type: "POST",
                url: '@Url.Action("UpdateTransactions", "GacsTransactions")',
                data: params,
                contenttype: "application/json; charset=utf-8",
                datatype: "json",
                success: function (response) {
                    if (response == "Success") {
                        if (data.filter(a=>a.TrxID == params.Id)[0].ItemElimination == "YES") {
                            swal("Please add entity amount at elimination detail")
                        } 
                    } else {
                        swal(response).then(_=>window.location.reload())
                    }
                },
                failure: function (error) {
                    swal(error);
                }
            });
        }

        function showDialog(Id) {
            document.getElementById(Id).style.visibility = "visible"
        }

        function closeDialog(Id) {
            setTimeout(() => {
                document.getElementById(Id).style.visibility = "hidden"
            },1)
        }

        function actionTemplate(Id) {
       
            var other = '<li><a  href="@Url.Action("GacsCurrencyTrx", "GacsTransactions")/?TrxId=' + Id + '">Currency Detail</a></li>\
                            <li><a  href="@Url.Action("GacsContributorTrx", "GacsTransactions")/?TrxId=' + Id + '">Contributor Detail</a></li>\
                            <li><a  href="@Url.Action("GacsEliminationTrx", "GacsTransactions")/?TrxId=' + Id + '">Elimination Detail</a></li>'

             //['33', '1177', '36', '38', '1178', '1179', '1180', '1187', '45', '46',
             //   '47', '48', '50', '51', '52', '1191', '53', '54', '55', '56'
             //   , '1156', '57', '58', '59', '61', '62', '49', '63', '64', '65', '70',
             //   '71', '77', '78', '79', '72', '73', '74', '75', '76', '68', '69']

            if (['33', '1177', '36', '38', '1178', '1179', '1180', '1187','1191','53','54',
           ,'1156','57','58','59','61','62','49','63',
                '71','77','78','79','74','75','76',]
                .includes('@ViewBag.Summary.NoteId')) {
         
                other = ''
            }

            return '<div class="btn-group">\
                         <button type="button" class="btn btn-info btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\
                           <span class="caret"></span\
                            <span class="sr-only"></span>\
                         </button>\
                         <ul class="dropdown-menu">\
                            '+ other +'\
                            ' + actionFilter('@ViewBag.Summary.NoteCategory'.toLowerCase(), '@ViewBag.Summary.NoteNo',Id) + '\
                       </ul>\
                      </div>'
        }

        function actionFilter(desc, noteNo, Id) {
            var query = desc;
           
            if (['74', '47', '52', '95', '97', '115', '116'].includes(noteNo)) {
                query = noteNo
            }
            var action = {
                asset: '<li><a href="@Url.Action("GacsAssetMovementDetailTrx", "GacsTransactions")/?TrxId=' + Id + '&&NoteId=@ViewBag.Summary.NoteId">Asset Movement Detail</a></li>',
                '74': '<li><a href="@Url.Action("GacsAssetBiologicalTrx", "GacsTransactions")/?TrxId=' + Id + '">Biological Movement Detail</a></li>',
                liability: '<li><a href="@Url.Action("GacsNonCurrentLiabilityTrx", "GacsTransactions")/?TrxId=' + Id + '">Liability Movement Detail</a></li>',
                equity: '<li><a  href="@Url.Action("GacsEquityMovementTrx", "GacsTransactions")/?TrxId=' + Id + '">Equity Movement Detail</a></li>',
                '47': '<li><a href="@Url.Action("GacsImpairementTrx", "GacsTransactions")/?TrxId=' + Id + '">Depr/ Impair & Amortization Detail</a></li>',
                '52': '<li><a href="@Url.Action("GacsImpairementTrx", "GacsTransactions")/?TrxId=' + Id + '">Depr/ Impair & Amortization Detail</a></li>',
                '95': '<li><a href="@Url.Action("GacsImpairementTrx", "GacsTransactions")/?TrxId=' + Id + '">Depr/ Impair & Amortization Detail</a></li>',
                '97': '<li><a href="@Url.Action("GacsImpairementTrx", "GacsTransactions")/?TrxId=' + Id + '">Depr/ Impair & Amortization Detail</a></li>',
                '115': '<li><a href="@Url.Action("GacsImpairementTrx", "GacsTransactions")/?TrxId=' + Id + '">Depr/ Impair & Amortization Detail</a></li>',
                '116': '<li><a href="@Url.Action("GacsImpairementTrx", "GacsTransactions")/?TrxId=' + Id + '">Depr/ Impair & Amortization Detail</a></li>',
                '41': '<li><a href="@Url.Action("GacsImpairementTrx", "GacsTransactions")/?TrxId=' + Id + '">Depr/ Impair & Amortization Detail</a></li>',
                expenses: '<li><a href="@Url.Action("GacsImpairementTrx", "GacsTransactions")/?TrxId=' + Id + '">Depr/ Impair & Amortization Detail</a></li>',
            }
            if (!action[query]) {
                return ''
            }
            return action[query]
        }

        function displayData() {
            dt_table.fnClearTable();
            var ActualTotal = 0;
            var ActualUpTo1month = 0;
            var Actual1To3month = 0;
            var Actual3To12month = 0;
            var Actual1To3Year = 0;
            var Actual3To5Year = 0;
            var ActualAbove5Year = 0;
            for (var i = 0; i < data.length; i++) {
                var Id = data[i].TrxID
                var status = data[i].OverallStatus
                var aEntry = data[i].additionEntry
                ActualTotal += data[i].ActualTotal
                ActualUpTo1month += data[i].ActualUpTo1month
                Actual1To3month += data[i].Actual1To3month
                Actual3To12month += data[i].Actual3To12month
                Actual1To3Year += data[i].Actual1To3Year
                Actual3To5Year += data[i].Actual3To5Year
                ActualAbove5Year += data[i].ActualAbove5Year

                if(aEntry == "NO"){
                    dt_table.fnAddData([i + 1,
                       data[i].GFSCode + "-" + data[i]["GFSDescription"],
                       EditBox(toLabel(data[i]["ActualTotal"]), Id, "ActualTotal", status),
                       toLabel(data[i]["ActualUpTo1month"]),
                       toLabel(data[i]["Actual1To3month"]),
                       toLabel(data[i]["Actual3To12month"]),
                       toLabel(data[i]["Actual1To3Year"]),
                       toLabel(data[i]["Actual3To5Year"]),
                       toLabel(data[i]["ActualAbove5Year"]),
                       actionTemplate(Id),
                    ]);
                } else if (aEntry == "YES") {
                dt_table.fnAddData([i + 1,
                  data[i].GFSCode + "-" + data[i]["GFSDescription"],
                  toLabel(data[i]["ActualTotal"]),
                  EditBox(toLabel(data[i]["ActualUpTo1month"]), Id, "ActualUpTo1month", status),
                  EditBox(toLabel(data[i]["Actual1To3month"]), Id, "Actual1To3month", status),
                  EditBox(toLabel(data[i]["Actual3To12month"]), Id, "Actual3To12month", status),
                  EditBox(toLabel(data[i]["Actual1To3Year"]), Id, "Actual1To3Year", status),
                  EditBox(toLabel(data[i]["Actual3To5Year"]), Id, "Actual3To5Year", status),
                  EditBox(toLabel(data[i]["ActualAbove5Year"]), Id, "ActualAbove5Year", status),
                  actionTemplate(Id),
               ]);
              } else {
                    dt_table.fnAddData([i + 1,
                       data[i].GFSCode + "-" + data[i]["GFSDescription"],
                       toLabel(data[i]["ActualTotal"]),
                       toLabel(data[i]["ActualUpTo1month"]),
                       toLabel(data[i]["Actual1To3month"]),
                       toLabel(data[i]["Actual3To12month"]),
                       toLabel(data[i]["Actual1To3Year"]),
                       toLabel(data[i]["Actual3To5Year"]),
                       toLabel(data[i]["ActualAbove5Year"]),
                       actionTemplate(Id),
                    ]);
                }
            }

            $("#ActualTotal").text(toLabel(ActualTotal))
            $("#ActualUpTo1month").text(toLabel(ActualUpTo1month))
            $("#Actual1To3month").text(toLabel(Actual1To3month))
            $("#Actual3To12month").text(toLabel(Actual3To12month))
            $("#Actual1To3Year").text(toLabel(Actual1To3Year))
            $("#Actual3To5Year").text(toLabel(Actual3To5Year))
            $("#ActualAbove5Year").text(toLabel(ActualAbove5Year))
        }

        function EditBox(amount, Id, label, status) {
            //console.log(status)
            //if (![null, 'Pending'].includes(status)) {
            //    return amount
            //}
            return `<a class="tooltip1" type="button" onclick="showDialog('${Id}_${label}')">${amount}
                    <div class ="tooltiptext" id="${Id}_${label}">
                      <div style="display:flex;flex-direction:row-reverse;padding-right:8px">
                          <button class ="closetip" onclick="closeDialog('${Id}_${label}')">x</button>
                      </div>
                      <div style="padding:8px">
                         <amount-input id='Amount_${Id}_${label}' class ="amount-input"/>
                      </div>
                      <div style="display:flex;flex-direction:row-reverse;padding-right:8px">
                          <button onclick="updateTrx(${Id},'${label}')" style="background-color:#82D4FA;border-radius:2px;outline:none;color:white">SAVE</button>
                      </div>
                    </div>
                   </a>`
        }
    </script>
}
