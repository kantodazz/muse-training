@{
    ViewBag.Title = "Payment Batch Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
<style>
    textarea {
        resize: none;
        width: 100%;
        background-color: white !important;
    }
</style>
<div id="content" style="margin: 5px;">
    <div class="row"></div>
    <!-- widget grid -->
    <section id="widget-grid" class="">
        <div class="row">
            <!-- NEW COL START -->
            <article class="col-sm-12 col-md-12 col-lg-12">

                <!-- Widget ID (each widget will need unique ID)-->
                <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false" data-widget-custombutton="false" data-widget-colorbutton="false" data-widget-deletebutton="false" data-widget-togglebutton="false">
                    <header>
                        <span class="widget-icon"> <i class="fa fa-edit"></i> </span>
                        <h2> @ViewBag.Title</h2>
                    </header>

                    <div>
                        <div class="widget-body " style="padding-top:10px;width:100%">
                            @*--------------------BEGINNING OF STEP ONE-------------------------*@
                            <div class="form-horizontal">
                                <div class="row setup-content" id="step-1">
                                    <div class="col-xs-12">
                                        <div class="col-md-12">
                                            <div class="form-horizontal">
                                                <h5>Batch Number:<b>@ViewBag.PaymentBatch.BatchNo</b></h5>
                                                <table style="height:50px">
                                                    <tr style="font-size:14px"><td>Sub Budget Class:</td><td>@ViewBag.PaymentBatch.SubBudgetClass</td></tr>
                                                    <tr style="font-size:14px">
                                                        <td>Number of Transactions:</td>
                                                        <td>
                                                            <span>@ViewBag.PaymentBatch.NoTrx</span>
                                                        </td>
                                                    </tr>
                                                    <tr style="font-size:14px">
                                                        <td>Total Amount:</td>
                                                        <td>
                                                            @if (ViewBag.PaymentBatch.TotalAmount != 0 && ViewBag.PaymentBatch.TotalAmount != null)
                                                            {
                                                                <span>TZS:@string.Format("{0:#,0.00}", ViewBag.PaymentBatch.TotalAmount)</span>
                                                            }
                                                            else
                                                            {
                                                                <span>TZS:@ViewBag.PaymentBatch.TotalAmount</span>
                                                            }
                                                        </td>
                                                    </tr>

                                                    <tr style="font-size:14px">
                                                        <td>Payment Description:</td>
                                                        <td>
                                                            @if (ViewBag.PaymentBatch.BatchDesc != null)
                                                            {
                                                                <span>@ViewBag.PaymentBatch.BatchDesc</span>
                                                            }
                                                        </td>
                                                    </tr>
                                                    <tr style="font-size:14px">
                                                        <td>Rejection Reasons:</td>
                                                        <td>
                                                            <div class="col-md-12">
                                                                @{
                                                                    int m = 0;
                                                                }
                                                                @if (ViewBag.RejectionReasonList != null)
                                                                {
                                                                    foreach (var item in ViewBag.RejectionReasonList)
                                                                    {
                                                                        m++;
                                                                        <span>@m.  @item.Remarks by @item.CreatedBy on  @item.CreatedAt</span><br />
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    <span>NILL</span>
                                                                }
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </table>
                                                <hr />
                                                <br />
                                                
                                                <div class="col-md-12">
                                                    <table class="table  table-bordered table-hover table-condensed" id="dataTableList" width="100%">
                                                        <thead>
                                                            <tr>
                                                                <th style="text-align:right;width:4%">Serial Number</th>
                                                                <th style="text-align:left;">Beneficiary Code</th>
                                                                <th style="text-align:left;">Beneficiary Name</th>
                                                                <th>Account Number</th>
                                                                <th>Bank Name</th>
                                                                <th>Bank BIC</th>
                                                                <th>Amount (TZS)</th>
                                                                <th>Description</th>
                                                                <th>Banking Status</th>
                                                            </tr>
                                                        </thead>
                                                        @{
                                                            int n = 0;
                                                        }
                                                        <tbody>
                                                            @if (ViewBag.BeneficiaryDetailsList != null)
                                                            {
                                                                foreach (var item in ViewBag.BeneficiaryDetailsList)
                                                                {
                                                                    n++;
                                                                    <tr>
                                                                        <td> @n </td>
                                                                        <td> @item.BeneficiaryCode </td>
                                                                        <td> @item.BeneficiaryName </td>
                                                                        <td> @item.AccountNo </td>
                                                                        <td> @item.BankName </td>
                                                                        <td> @item.BankBIC </td>
                                                                        <td>
                                                                            @if (item.Amount != 0 && item.Amount != null)
                                                                            {
                                                                                <span>@string.Format("{0:#,0.00}", item.Amount)</span>
                                                                            }
                                                                            else
                                                                            {
                                                                                <span>@item.Amount</span>
                                                                            }
                                                                        </td>
                                                                        <td> @item.PaymentDescription </td>
                                                                        <td> @item.OverallStatus </td>
                                                                    </tr>
                                                                }
                                                            }
                                                        </tbody>
                                                    </table>
                                                    <a onclick="history.back()" style="margin-right:5px" type="submit" class="btn btn-info pull-left"><i class="glyphicon glyphicon-arrow-left"></i> Back  </a><br /><br />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            @*--------------------END OF STEP ONE--------------------*@
                        </div>
                    </div>
                </div>
            </article>
        </div>
    </section>

</div>

@section pagespecific {
    <!-- PAGE RELATED PLUGIN(S) -->
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script>
        $(document).ready(function () {
            var titleforExports = "Payments";
            if ('@ViewBag.PaymentBatch' != null) {
                 titleforExports = '@ViewBag.PaymentBatch.BatchDesc';
            }

            $('#dataTableList').DataTable({
                dom: 'lBfrtip',
                buttons: [
                    {
                        extend: 'excelHtml5',
                        text: '<i class="fa fa-file-excel-o"></i> Excel',
                        titleAttr: 'Export Beneficieries to Excel',
                        title: titleforExports,
                        exportOptions: {
                            columns: ':not(:last-child)',
                        }
                    },
                    {
                        extend: 'csvHtml5',
                        text: '<i class="fa fa-file-text-o"></i> CSV',
                        titleAttr: 'Export Beneficieries to CSV',
                        title: titleforExports,
                        exportOptions: {
                            columns: ':not(:last-child)',
                        }
                    },
                    {
                        extend: 'pdfHtml5',
                        orientation: 'landscape',
                        pageSize: 'A4',
                        text: '<i class="fa fa-file-pdf-o"></i> PDF',
                        titleAttr: 'Export Beneficieries to PDF',
                        title: titleforExports,
                        exportOptions: {
                            columns: ':not(:last-child)'
                        },
                    },
                ]
            });
        });
    </script>
    <script type="text/javascript">
        $(".saveLoader").toggle(false);

        $("#BankID").select2();
        $('#BatchDesc').on("keyup", function () {
            var count = $('#BatchDesc').val().split('');
            var numChars = 80 - parseInt(count.length);
            $('#BatchDescCount').text(parseInt(numChars));
        });
        /*BEGINNING UPDATING BENEFICIARY INFORMATION*/
        var beneficiaryId = null;
        function updateBeneficiaryForm(BeneficiaryID, BeneficiaryCode, BeneficiaryName, AccountNo,BankName, Amount) {
            beneficiaryId = BeneficiaryID;
            $('#BenCode').text(BeneficiaryCode);
            $('#BenName').text(BeneficiaryName);
            $('#AccNo').text(AccountNo);
            $('#BankName').text(BankName);
            document.getElementById("_Amount").value = Amount.toLocaleString();;
            $('#AddBeneficiaryModel').modal('show');
        }

        var url = null;
         var urlList = null;
         $("#saveLoader").toggle(false);
         function UpdateBeneficiary() {

             swal({
                 title: "Update Beneficiary Amount",
                 text: "Are you sure you want to Update Beneficiary Amount? ",
                 buttons: [
                   'Yes',
                   'No'
                 ],
                 closeOnClickOutside: false,
             }).then(function (isConfirm) {
                 if (isConfirm) {
                     swal("Cancelled", "No change was made");
                 } else {
                     updateData();
                 }
             });
         }

        var updateData = function () {
        var Amount = $("#_Amount").val();

        if (Amount == "" || parseInt(Amount) <= 0 || Amount == null) {
            swal("Please Enter Valid Amount", { icon: "warning" });
            return false;
        }

        var data = new FormData();
        data.append("BeneficiaryID", beneficiaryId);
        data.append("Amount", Amount);
        data.append("__RequestVerificationToken", $('[name=__RequestVerificationToken]').val());

        url = '@Url.Action("UpdateBeneficiary", "EFTPayments")';
        urlList = '@Url.Action("PaymentbatchDetails", "EFTPayments")/?paymentBatchId=' + @ViewBag.PaymentBatchId

        $("#saveLoader").toggle(true);
        $("#btnAddBen").prop('disabled', true);
        $.ajax({
            url: url,
            type: "POST",
            processData: false,
            contentType: false,
            data: data,
            success: function (response) {
                if (response.data == "Success") {
                    $("#btnAddBen").prop('disabled', false);
                    swal("Updated Successfully!", { icon: "success" }).then((e) => {
                        $("#saveLoader").toggle(false);
                        window.location.href = urlList;
                    });

                }
                else {
                    $("#btnAddBen").prop('disabled', false);
                    swal(response.data, { icon: "warning" }).then((e) => {
                        $("#saveLoader").toggle(false);
                        window.location.reload();
                    });
                };
            },
            error: function (err) {
                swal(err.statusText)
                $("#saveLoader").toggle(false);
            }
        });

        };
       /*ENDING UPDATING BENEFICIARY INFORMATION*/
        /*BEGINNING CANCELING BENEFICIARY INFORMATION*/
       var beneficiaryNo = null;
       function cancelBeneficiary(BeneficiaryID,BeneficiaryCode,BeneficiaryName,Amount) {
           beneficiaryNo = BeneficiaryCode;
      swal({
          title: 'Cancel Beneficiary',
          text: 'Are you sure you want to Cancel Beneficiary: ' + BeneficiaryCode + " " + BeneficiaryName + " with Amount: " + Amount.toLocaleString(),
          buttons: [
            'No',
            'Yes'
          ],
      }).then(function (isConfirm) {
          if (isConfirm) {
             var formData = new FormData()
              formData.append('__RequestVerificationToken', $('[name=__RequestVerificationToken]').val());
              formData.append('BeneficiaryID', BeneficiaryID);
              formData.append('OverallStatus', '@IFMIS.Libraries.Constants.CANCELLED');
              postFormBenData(formData);
          } else {
              swal("Cancelled", "No change was made");
          }
      });
    }

    function postFormBenData(formData) {
        var successMessage = "Batch Number: " + beneficiaryNo +' @IFMIS.Libraries.Constants.CANCELLED '+"Successfully";
        var failureMessage = "An error occurred during Verification of Batch Number:  " + beneficiaryNo;

        $(".loadingImg").show();
        $(".saveLoader").toggle(true);
        var url = '@Url.Action("ChangeBeneficiaryStatus", "EFTPayments")';
        var urlList = '@Url.Action("PaymentbatchDetails", "EFTPayments")/?paymentBatchId=' + @ViewBag.PaymentBatchId
        $.ajax({
            url: url,
            data: formData,
            type: 'POST',
            contentType: false,
            processData: false,
            success: function (response) {
                $(".saveLoader").toggle(true);
                if (response.data == "Success") {
                    swal(successMessage, { icon: "success" })
                        .then((m) => {
                            window.location.replace(urlList);
                        });
                } else {
                    $(".saveLoader").toggle(false);
                    swal(failureMessage + ": " + response, { icon: "warning" });
                }
            },
            failure: function (error) {
                $(".saveLoader").toggle(false);
                swal(failureMessage, { icon: "warning" });
            }
        });
    }
        /*ENDING CANCELING BENEFICIARY INFORMATION*/
        /*BEGINNING CODE TO ADD SINGLE BENEFICIARY*/
        function AddSingleBeneficiary() {
            $('#AddSingleBenModel').modal('show');
        }
        /*ENDING CODE TO ADD SINGLE BENEFICIARY*/

        /*BEGINNING SAVING BENEFICIARY*/
        function saveSingleBeneficiary() {
            $(".saveLoader").toggle(true);
            $("#btnSingleBeneficiary").prop('disabled', true);
            var BenDepartmentID = $("#BenDepartmentID").val();
            var FirstName = $("#FirstName").val();
            var MiddleName = $("#MiddleName").val();
            var LastName = $("#LastName").val();
            var BenCode = $("#BeneficiaryCode").val();
            var AccountNo = $("#AccountNo").val();
            var Amount = $("#_BenAmount").val();
            var BankID = $("#BankID").val();
            var BatchDesc = $("#BatchDesc").val();

            if (BenDepartmentID == '') {
                swal("Department is Required", { icon: "warning" });
                $(".saveLoader").toggle(false);
                $("#btnSingleBeneficiary").prop('disabled', false);
                return false;
            }

            if (FirstName == '') {
                swal("First Name is Required", { icon: "warning" });
                $(".saveLoader").toggle(false);
                $("#btnSingleBeneficiary").prop('disabled', false);
                return false;
            }

            if (MiddleName == '') {
                swal("Middle Name is Required", { icon: "warning" });
                $(".saveLoader").toggle(false);
                $("#btnSingleBeneficiary").prop('disabled', false);
                return false;
            }

            if (LastName == '') {
                swal("Last Name is Required", { icon: "warning" });
                $(".saveLoader").toggle(false);
                $("#btnSingleBeneficiary").prop('disabled', false);
                return false;
            }

            if (BenCode == '') {
                swal("Beneficiary Code is Required", { icon: "warning" });
                $(".saveLoader").toggle(false);
                $("#btnSingleBeneficiary").prop('disabled', false);
                return false;
            }

            if (BenName == '') {
                swal("Beneficiary Name is Required", { icon: "warning" });
                $(".saveLoader").toggle(false);
                $("#btnSingleBeneficiary").prop('disabled', false);
                return false;
            }

            if (AccountNo == '' ) {
                swal("Account Number is Required", { icon: "warning" });
                $(".saveLoader").toggle(false);
                $("#btnSingleBeneficiary").prop('disabled', false);
                return false;
            }

            if (Amount == '' || Amount <= 0 || Amount == null) {
                swal("Amount is Required", { icon: "warning" });
                $(".saveLoader").toggle(false);
                $("#btnSingleBeneficiary").prop('disabled', false);
                return false;
            }
             if (BankID == '' || BankID == 'Select Bank Name') {
                swal("Bank Name is Required", { icon: "warning" });
                $(".saveLoader").toggle(false);
                $("#btnSingleBeneficiary").prop('disabled', false);
                return false;
            }

            if (BatchDesc == '' ) {
                swal("Description is Required", { icon: "warning" });
                $(".saveLoader").toggle(false);
                $("#btnSingleBeneficiary").prop('disabled', false);
                return false;
            }

                var formData = new FormData();
                formData.append('__RequestVerificationToken', $('[name=__RequestVerificationToken]').val());
                formData.append('PaymentBatchId', '@ViewBag.PaymentBatchId');
                formData.append('BeneficiaryCode', BenCode);
                formData.append('BenDepartmentID', BenDepartmentID);
                formData.append('FirstName', FirstName);
                formData.append('MiddleName', MiddleName);
                formData.append('LastName', LastName);
                formData.append('AccountNo', AccountNo);
                formData.append('Amount', Amount);
                formData.append('BankID', BankID);
                formData.append('PaymentDescription', BatchDesc);

                var url = '@Url.Action("SaveSingleBeneficiary", "EFTPayments")';
                $.ajax({
                    type: "POST",
                    url: url,
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (response) {
                        switch (response) {
                            case "Success":
                               swal("Beneficiary Saved Successfully", { icon: "success" })
                                .then((value) => {
                                 var url = '@Url.Action("PaymentBatchesList", "EFTPayments")';
                                  window.location.replace(url);
                                });

                                $(".saveLoader").toggle(false);
                                $("#btnSingleBeneficiary").prop('disabled', false);
                                break;
                        }
                    },
                    failure: function (response) {
                        swal(response.d, { icon: "warning" });
                        $(".saveLoader").toggle(false);
                        $("#btnSingleBeneficiary").prop('disabled', false);
                    }
                });

        }
       /*ENDING SAVING BENEFICIARY*/
    </script>
}
