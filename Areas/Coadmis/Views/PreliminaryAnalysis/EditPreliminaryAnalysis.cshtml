@model IFMIS.Areas.Coadmis.Models.QuestionnaireAnswerDetailVM
@{
    ViewBag.Title = "Edit Preliminary Analysis";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style type="text/css">
    .loadingImg {
        display: none;
    }
    .stepwizard-step p {
        margin-top: 10px;
    }

    .stepwizard-row {
        display: table-row;
    }

    textarea {
        resize: none;
        width: 100%;
    }
    .stepwizard {
        display: table;
        width: 100%;
        position: relative;
    }

    .stepwizard-step button[disabled] {
        opacity: 1 !important;
        filter: alpha(opacity=100) !important;
    }

    .stepwizard-row:before {
        top: 14px;
        bottom: 0;
        position: absolute;
        content: " ";
        width: 100%;
        height: 1px;
        background-color: #ccc;
        z-order: 0;
    }

    .stepwizard-step {
        display: table-cell;
        text-align: center;
        position: relative;
    }


    .search-btn {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 5px;
        padding-right: 10px;
    }

    .search-container {
        display: inline-flex;
        flex: 1 1 300px;
        position: relative;
        border: 1px solid #ccc;
        border-radius: 5px;
        overflow: hidden;
        padding-left: 10px;
    }

    .name-input-container {
        display: inline-flex;
        flex: 1 1 300px;
        position: relative;
        overflow: hidden;
    }

    .search-icon {
        padding: 0.5rem;
    }

    .search-button {
        background: #538AC5;
        border: 0;
        color: white;
        padding: 8px;
        border-radius: 0;
    }

    input[type=number] {
        padding: 8px;
        border: 1px solid #ccc;
        width: 205px;
    }

    input[type=text] {
        padding: 5px;
        border: 1px solid #ccc;
    }

    input[type=search] {
        padding: 4px;
        border: hidden;
        border-radius: 4px;
    }

    textarea {
        border: 1px solid #ccc;
    }

    select {
        padding: 8px;
        border: 1px solid #ccc;
        resize: vertical;
        width: 230px;
    }

    .action-btn {
        width: 100px;
        color: white;
    }

    .form-label {
        text-align: right;
    }

    td {
        padding: 5px;
    }

    .info-box {
        padding: 10px;
        background-color: #ECF3F8;
        text-align: center;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    #itemUL li {
        margin-left: -40px;
        border-bottom: 1px solid silver;
        height: 26px;
        padding-left: 5px;
        padding-top: 8px;
        cursor: pointer;
    }

    .redStar {
        color: red;
        font-size: 15px;
    }
</style>
<div id="content" style="margin: 5px;">
    <div class="row"></div>
    <!-- widget grid -->
    <section id="widget-grid" class="">
        <div class="row">
            <!-- NEW COL START -->
            <article class="col-sm-12 col-md-12 col-lg-12">

                <!-- Widget ID (each widget will need unique ID)-->
                <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false" data-widget-custombutton="false" data-widget-colorbutton="false" data-widget-deletebutton="false" data-widget-togglebutton="false">

                    <header>
                        <span class="widget-icon"> <i class="fa fa-edit"></i> </span>
                        <h2> @ViewBag.Title</h2>
                    </header>

                    <div>
                        <div class="widget-body " style="padding-top:10px;width:100%">
                            <!----WIZARD HEADING -->
                            <div class="stepwizard">
                                <div class="stepwizard-row setup-panel">
                                    <div class="stepwizard-step">
                                        <a href="#step-1" type="button" class="btn btn-primary btn-circle">1</a>
                                        <p><strong>Client Information</strong></p>
                                    </div>

                                    <div class="stepwizard-step">
                                        <a href="#step-2" type="button" class="btn btn-default btn-circle">2</a>
                                        <p><strong>Organisation Independent Questionnaire</strong></p>
                                    </div>

                                    <div class="stepwizard-step">
                                        <a href="#step-3" type="button" class="btn btn-default btn-circle">3</a>
                                        <p><strong>Safe Guard</strong></p>
                                    </div>
                                    <div class="stepwizard-step">
                                        <a href="#step-4" type="button" class="btn btn-default btn-circle">4</a>
                                        <p><strong>General Preliminary Engagement</strong></p>
                                    </div>
                                </div>
                            </div>
                            <br />
                            <br />
                            @*--------------------BEGINNING OF STEP ONE-------------------------*@
                            <div class="form-horizontal">
                                <div class="row setup-content" id="step-1">
                                    <div class="col-xs-12">
                                        <div class="col-md-12">
                                            @Html.AntiForgeryToken()
                                            <div class="form-horizontal">
                                                <div class="col-xs-12">
                                                    @if (ViewBag.PreliminaryAnalysisId != 0)
                                                    {
                                                        <input type="hidden" name="ClientType" id="ClientType" value="@ViewBag.ClientType" />
                                                        <div class="col-md-12">
                                                            <div class="form-group">
                                                                <label class="control-label col-md-2">Choose Client<span class="redStar">*</span></label>
                                                                <div class="col-md-8">
                                                                    <select id="ClientInformationId" disabled class="form-control select2">
                                                                        @if (ViewBag.ClientInformationList != null)
                                                                        {
                                                                            foreach (var clientInfo in ViewBag.ClientInformationList)
                                                                            {
                                                                                if (ViewBag.ClientInformationId == clientInfo.ClientInformationId)
                                                                                {
                                                                                    <option value='@clientInfo.ClientInformationId' selected>@clientInfo.ClientName</option>
                                                                                }
                                                                                else
                                                                                {
                                                                                    <option value='@clientInfo.ClientInformationId'>
                                                                                        @clientInfo.ClientName   @ViewBag.ClientInformationId -  @clientInfo.ClientInformationId
                                                                                    </option>
                                                                                }
                                                                            }
                                                                        }
                                                                    </select>
                                                                </div>
                                                            </div>

                                                            <div class="form-group">
                                                                <label class="control-label col-md-2">Financial Year</label>
                                                                <div class="col-md-3">
                                                                    @Html.TextBoxFor(model => model.FinancialYearId, new { @Class = "form-control select2", style = "width:100%;", @readonly = "readonly" })
                                                                </div>

                                                                <label class="control-label col-md-2">Status<span class="redStar">*</span></label>
                                                                <div class="col-md-3">
                                                                    @Html.DropDownList("Status", new List<SelectListItem>{
                                                                      new SelectListItem{ Text="--Select ---", Value = "" },
                                                                      new SelectListItem{ Text="Active", Value = "Active" },
                                                                      new SelectListItem{ Text="Inactive", Value = "Inactive" },
                                                                       }, new { @class = "form-control", @required = "required" })
                                                                    @Html.ValidationMessageFor(model => model.Status, "", new { @class = "text-danger" })
                                                                </div>
                                                            </div>

                                                            <div class="form-group ProfessionalClearanceDiv">
                                                                <label class="control-label col-md-2">Professional Clearance</label>
                                                                <div class="col-md-3">
                                                                    <input type="file" name="ProfessionalClearance" id="ProfessionalClearance" accept="application/pdf" class="form-control" />
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <div class="col-md-2"></div>
                                                                <div class="col-md-6">
                                                                    <a href="@Url.Action("PreliminaryAnalysisList", "PreliminaryAnalysis")" style="margin-right:5px" type="submit" class="btn btn-info pull-left"><i class="glyphicon glyphicon-arrow-left"></i> Back  </a>
                                                                    <button type="submit" class="btn btn-info" onclick="updatePreliminaryAnalysisForm()" id="savePreliminaryAnalysisBtn">
                                                                        <i class="fa fa-save"></i>Save
                                                                        <img src="~/Content/img/loading.gif" class="loadingImg" />
                                                                    </button>
                                                                    <button class="btn btn-info nextBtn" type="button">Next &nbsp;<span class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span></button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <input type="hidden" name="ClientType" id="ClientType" />
                                                        <div class="col-md-12">
                                                            <div class="form-group">
                                                                <label class="control-label col-md-2">Choose Client <span class="redStar">*</span></label>
                                                                <div class="col-md-8">
                                                                    <select id="ClientInformationId" class="form-control select2">
                                                                        @if (ViewBag.ClientInformationList != null)
                                                                        {
                                                                            <option value="">Select Client</option>
                                                                            foreach (var clientInfo in ViewBag.ClientInformationList)
                                                                            {
                                                                                <option value='@clientInfo.ClientInformationId'>@clientInfo.ClientName</option>
                                                                            }
                                                                        }
                                                                    </select>
                                                                </div>
                                                            </div>

                                                            <div class="form-group">
                                                                <label class="control-label col-md-2">Financial Year</label>
                                                                <div class="col-md-3">
                                                                    @Html.TextBoxFor(model => model.FinancialYearId, new { @Class = "form-control select2", style = "width:100%;", @readonly = "readonly" })
                                                                </div>

                                                                <label class="control-label col-md-2">Status<span class="redStar">*</span></label>
                                                                <div class="col-md-3">
                                                                    @Html.DropDownList("Status", new List<SelectListItem>{
                                                                      new SelectListItem{ Text="--Select ---", Value = "" },
                                                                      new SelectListItem{ Text="Active", Value = "Active" },
                                                                      new SelectListItem{ Text="Inactive", Value = "Inactive" },
                                                                       }, new { @class = "form-control", @required = "required" })
                                                                    @Html.ValidationMessageFor(model => model.Status, "", new { @class = "text-danger" })
                                                                </div>
                                                            </div>

                                                            <div class="form-group ProfessionalClearanceDiv">
                                                                <label class="control-label col-md-2">Professional Clearance</label>
                                                                <div class="col-md-3">
                                                                    <input type="file" name="ProfessionalClearance" id="ProfessionalClearance" accept="application/pdf" class="form-control" />
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <div class="col-md-2"></div>
                                                                <div class="col-md-6">
                                                                    <a href="@Url.Action("PreliminaryAnalysisList", "PreliminaryAnalysis")" style="margin-right:5px" type="submit" class="btn btn-info pull-left"><i class="glyphicon glyphicon-arrow-left"></i> Back  </a>
                                                                    <button type="submit" class="btn btn-info" onclick="savePreliminaryAnalysisForm()" id="savePreliminaryAnalysisBtn">
                                                                        <i class="fa fa-save"></i>Save
                                                                        <img src="~/Content/img/loading.gif" class="loadingImg" />
                                                                    </button>
                                                                    <button class="btn btn-info nextBtn" type="button">Next &nbsp;<span class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span></button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            @*--------------------END OF STEP ONE--------------------*@
                            @*--------------------BEGINNING OF STEP TWO---------------*@
                            <div class="row setup-content" id="step-2">
                                <div class="form-horizontal">
                                    <div class="col-xs-12">
                                        <div class="col-md-12">
                                            @if (ViewBag.PreliminaryAnalysisId != 0)
                                            {
                                                if (Model.GetIndependentQuestionnaire == null)
                                                {
                                                    <div class="row">
                                                        <div class="col-lg-3 col-sm-3 col-xs-3"></div>
                                                        <div class="col-lg-6 col-sm-6 col-xs-6">

                                                            <div class="alert alert-block alert-info">
                                                                <a class="close" data-dismiss="alert" href="#">×</a>
                                                                <center><span>Organisation Independent Questionnaire Settings not Found,Please Contact System Support</span></center>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-3 col-sm-3 col-xs-3"></div>
                                                    </div>
                                                }
                                                if (Model.GetIndependentQuestionnaire != null && ViewBag.IsIndependentQuestionnaireFullAnswered == false)
                                                {
                                                    /*BEGIN ADDING QUESTIONNAIRE ANSWERS*/
                                                    using (Html.BeginForm("SaveQuestionnaire", "PreliminaryAnalysis", FormMethod.Post, new { enctype = "multipart/form-data", id = "Form1", onsubmit = "return validateFormOnCreate(this,'Form1');" }))
                                                    {
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="ModuleId" id="ModuleId" value="@ViewBag.PreliminaryAnalysisId" />
                                                        <input type="hidden" name="Category" id="Category" value="@IFMIS.Areas.Coadmis.Libraries.Constants.CATEGORY_INDEPENDENT_QUESTIONNAIRE" />
                                                        <div class="col-md-12">
                                                            <div class="col-md-6" style="padding-top:20px">
                                                                <dl class="dl-horizontal">
                                                                    <dt><strong>Client Name:</strong></dt>
                                                                    <dd>@ViewBag.OrgClientName</dd>
                                                                    <dt><strong>File No.:</strong></dt>
                                                                    <dd>@ViewBag.OrgFileNo</dd>
                                                                    <dt> <strong>Working Paper Ref:</strong></dt>
                                                                    <dd> @ViewBag.OrgWorkPaper</dd>
                                                                </dl>
                                                            </div>
                                                            <div class="col-md-6" style="padding-top:20px">
                                                                <dl class="dl-horizontal">
                                                                    <dt>Questionnaire Title</dt>
                                                                    <dd>Organisation Independent Questionnair</dd>
                                                                    <dt><strong>Prepared By:</strong></dt>
                                                                    <dd>@ViewBag.OrgPreparedBy</dd>
                                                                    <dt><strong>Prepared At:</strong></dt>
                                                                    <dd>@ViewBag.OrgPreparedAt</dd>
                                                                </dl>
                                                            </div>
                                                        </div>
                                                        <table id="dataTableList" class="table table-striped table-bordered table-hover" width="100%">
                                                            <thead><tr></tr></thead>
                                                            <tbody>
                                                                @{ int n = 0; }
                                                                <tr>
                                                                    <td colspan="3" style="">@ViewBag.OrgQuestionnaireDescription</td>
                                                                </tr>
                                                                @foreach (var group in Model.GetIndependentQuestionnaire.GroupBy(a => a.QuestionnairTitleName))
                                                                {
                                                                    n++;
                                                                    <tr data-level='1' style="background:#f5f5f5; color:#000000">
                                                                        <td colspan="13">
                                                                            <strong>
                                                                                <span class="sign"></span>
                                                                                @n. @group.Key
                                                                            </strong>
                                                                        </td>
                                                                    </tr>

                                                                    foreach (var item in group.GroupBy(a => a.QuestionnairSubTitleName))
                                                                    {
                                                                        int y = 0;

                                                                        int num = 0;
                                                                        if (item.Key != null)
                                                                        {
                                                                            <tr data-level='1' style="background:#f5f5f5; color:#000000;">
                                                                                <td colspan="13">
                                                                                    <strong>
                                                                                        <span class="sign"></span>
                                                                                        <i>@item.Key</i>
                                                                                    </strong>
                                                                                </td>
                                                                            </tr>

                                                                            foreach (var itemQn in item.GroupBy(a => a.Question))
                                                                            {
                                                                                num++;
                                                                                <tr>
                                                                                    <td>@itemQn.Key </td>
                                                                                    @foreach (var itemx in itemQn.GroupBy(a => a.Lebal))
                                                                                    {

                                                                                        foreach (var data in itemx)
                                                                                        {
                                                                                            y++;

                                                                                            if (itemx.Key == "Radio Button")
                                                                                            {
                                                                                                <td>
                                                                                                    <input type="checkbox" class="answers" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@data.Value" name="Answers[]" id="Answers-@num" onclick="AllowSingleSelection(this);" onchange="getValueFromCheckbox(this)"/>@data.Value
                                                                                                </td>
                                                                                            }

                                                                                            else if (itemx.Key == "Text")
                                                                                            {
                                                                                                <td colspan="2">
                                                                                                    <label>@data.Value</label>
                                                                                                    <input type="hidden" id="QuestionIdForTextAreas-@y" name="QuestionIdForTextAreas[]" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()" />
                                                                                                    <textarea class="form-control answers" required id="Answers-@y" rows="4" cols="150" name="Answers[]"></textarea>
                                                                                                </td>
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                <td>
                                                                                                    <input type="checkbox" class="answers" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@data.Value" name="Answers[]" id="Answers-@y" onchange="getValueFromCheckbox(this)" />
                                                                                                    <label>@data.Value</label>
                                                                                                </td>
                                                                                            }
                                                                                        }
                                                                                    }

                                                                                </tr>
                                                                            }
                                                                        }
                                                                        else
                                                                        {

                                                                            foreach (var itemQn in group.GroupBy(a => a.Question))
                                                                            {
                                                                                num++;
                                                                                <tr>
                                                                                    <td>@itemQn.Key </td>
                                                                                    @foreach (var itemx in itemQn.GroupBy(a => a.Lebal))
                                                                                    {

                                                                                        foreach (var data in itemx)
                                                                                        {
                                                                                            y++;

                                                                                            if (itemx.Key == "Radio Button")
                                                                                            {
                                                                                                <td>
                                                                                                    <input type="checkbox" class="answers" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@data.Value" name="Answers[]" id="Answers-@num" onclick="AllowSingleSelection(this);" onchange="getValueFromCheckbox(this)" />@data.Value
                                                                                                </td>
                                                                                            }

                                                                                            else if (itemx.Key == "Text")
                                                                                            {
                                                                                                <td colspan="2">
                                                                                                    <label>@data.Value</label>
                                                                                                    <input type="hidden" id="QuestionIdForTextAreas-@y" name="QuestionIdForTextAreas[]" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()" />
                                                                                                    <textarea class="form-control answers"  required id="Answers-@y" rows="4" cols="150" name="Answers[]"></textarea>
                                                                                                </td>
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                <td>
                                                                                                    <input type="checkbox" class="answers" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@data.Value" name="Answers[]" id="Answers-@y" onchange="getValueFromCheckbox(this)"/>
                                                                                                    <label>@data.Value</label>
                                                                                                </td>
                                                                                            }
                                                                                        }
                                                                                    }

                                                                                </tr>
                                                                            }
                                                                        }
                                                                    }

                                                                }

                                                            </tbody>
                                                        </table>

                                                        <div class="form-group">
                                                            <div class="col-md-1"></div>
                                                            <a href="@Url.Action("PreliminaryAnalysisList", "PreliminaryAnalysis")" style="margin-right:5px" type="submit" class="btn btn-info pull-left"><i class="glyphicon glyphicon-arrow-left"></i> Back  </a>
                                                            <button class="btn btn-info prevBtn" type="button">Previous &nbsp;<span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span></button>
                                                            <button type="submit" name="submit" class="btn btn-info" id="saveAnswerForm">
                                                                <i class="fa fa-save"></i> Save
                                                                <img src="~/Content/img/loading.gif" class="loadingImg" />
                                                            </button>
                                                            <button class="btn btn-info nextBtn" type="button">Next &nbsp;<span class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span></button>
                                                        </div>
                                                    }
                                                    /*END ADDING QUESTIONNAIRE ANSWERS*/
                                                }//END IF STATEMENT

                                                /*BEGIN EDITING QUESTIONNAIRE ANSWERS*/
                                                if (ViewBag.IsIndependentQuestionnaireFullAnswered)
                                                {
                                                    using (Html.BeginForm("UpdateQuestionnaire", "PreliminaryAnalysis", FormMethod.Post, new { enctype = "multipart/form-data", onsubmit = "return validateForm(this);" }))
                                                    {
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="ModuleId" id="ModuleId" value="@ViewBag.PreliminaryAnalysisId" />
                                                        <input type="hidden" name="Category" id="Category" value="@IFMIS.Areas.Coadmis.Libraries.Constants.CATEGORY_INDEPENDENT_QUESTIONNAIRE" />
                                                        <div class="col-md-12">
                                                            <div class="col-md-6" style="padding-top:20px">
                                                                <dl class="dl-horizontal">
                                                                    <dt><strong>Client Name:</strong></dt>
                                                                    <dd>@ViewBag.OrgClientName</dd>
                                                                    <dt><strong>File No.:</strong></dt>
                                                                    <dd>@ViewBag.OrgFileNo</dd>
                                                                    <dt> <strong>Working Paper Ref:</strong></dt>
                                                                    <dd> @ViewBag.OrgWorkPaper</dd>
                                                                </dl>
                                                            </div>
                                                            <div class="col-md-6" style="padding-top:20px">
                                                                <dl class="dl-horizontal">
                                                                    <dt>Questionnaire Title</dt>
                                                                    <dd>Organisation Independent Questionnair</dd>
                                                                    <dt><strong>Prepared By:</strong></dt>
                                                                    <dd>@ViewBag.OrgPreparedBy</dd>
                                                                    <dt><strong>Prepared At:</strong></dt>
                                                                    <dd>@ViewBag.OrgPreparedAt</dd>
                                                                </dl>
                                                            </div>
                                                        </div>
                                                        <table id="dataTableList" class="table table-striped table-bordered table-hover" width="100%">
                                                            <thead><tr></tr></thead>
                                                            <tbody>
                                                                @{ int n = 0;}
                                                                <tr>
                                                                    <td colspan="3" style="">@ViewBag.OrgQuestionnaireDescription</td>
                                                                </tr>
                                                                @if (Model.GetIndependentQuestionnaire != null)
                                                                {
                                                                    foreach (var group in Model.GetIndependentQuestionnaire.GroupBy(a => a.QuestionnairTitleName))
                                                                    {
                                                                        n++;
                                                                        List<int> questionList = new List<int>();
                                                                        if (ViewBag.GetIndependentQuestionnaireAnswers != null)
                                                                        {
                                                                            for (var mn = 0; mn < ViewBag.GetIndependentQuestionnaireAnswers.Count; mn++)
                                                                            {
                                                                                if (ViewBag.GetIndependentQuestionnaireAnswers[mn].QuestionId == group.Select(a => a.QuestionId).FirstOrDefault())
                                                                                {
                                                                                    questionList.Add((int)group.Select(a => a.QuestionId).FirstOrDefault());
                                                                                }
                                                                            }
                                                                        }

                                                                        if (questionList.Contains((int)group.Select(a => a.QuestionId).FirstOrDefault()))
                                                                        {
                                                                            <tr data-level='1' style="background:#f5f5f5; color:#000000">
                                                                                <td colspan="13">
                                                                                    <strong>
                                                                                        <span class="sign"></span>
                                                                                        @n. @group.Key
                                                                                    </strong>
                                                                                </td>
                                                                            </tr>
                                                                        }
                                                                        foreach (var item in group.GroupBy(a => a.QuestionnairSubTitleName))
                                                                        {
                                                                            int y = 0;

                                                                            int num = 0;
                                                                            if (item.Key != null)
                                                                            {

                                                                                if (questionList.Contains((int)item.Select(a => a.QuestionId).FirstOrDefault()))
                                                                                {
                                                                                    <tr data-level='1' style="background:#f5f5f5; color:#000000;">
                                                                                        <td colspan="13">
                                                                                            <strong>
                                                                                                <span class="sign"></span>
                                                                                                <i>@item.Key</i>
                                                                                            </strong>
                                                                                        </td>
                                                                                    </tr>
                                                                                }
                                                                                foreach (var itemQn in item.GroupBy(a => a.Question))
                                                                                {
                                                                                    num++;
                                                                                    <tr>
                                                                                        @if (questionList.Contains((int)item.Select(a => a.QuestionId).FirstOrDefault()))
                                                                                        {
                                                                                            <td>
                                                                                                @itemQn.Key
                                                                                            </td>
                                                                                        }
                                                                                        @foreach (var itemx in itemQn.GroupBy(a => a.Lebal))
                                                                                        {

                                                                                            foreach (var data in itemx)
                                                                                            {
                                                                                                y++;

                                                                                                if (ViewBag.GetIndependentQuestionnaireAnswers != null)
                                                                                                {
                                                                                                    for (var nm = 0; nm < ViewBag.GetIndependentQuestionnaireAnswers.Count; nm++)
                                                                                                    {
                                                                                                        if (ViewBag.GetIndependentQuestionnaireAnswers[nm].QuestionId == @itemQn.Select(a => a.QuestionId).FirstOrDefault())
                                                                                                        {

                                                                                                            if (itemx.Key == "Radio Button")
                                                                                                            {

                                                                                                                if (ViewBag.GetIndependentQuestionnaireAnswers[nm].Answer == data.Value)
                                                                                                                {
                                                                                                                    <td>
                                                                                                                        <input type="checkbox" class="answers" checked value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@ViewBag.GetIndependentQuestionnaireAnswers[nm].Answer-@ViewBag.GetIndependentQuestionnaireAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@num" onclick="AllowSingleSelection(this);" />@data.Value
                                                                                                                    </td>
                                                                                                                }
                                                                                                                else if (ViewBag.GetIndependentQuestionnaireAnswers[nm].Answer != data.Value)
                                                                                                                {
                                                                                                                    <td>
                                                                                                                        <input type="checkbox" class="answers" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@data.Value-@ViewBag.GetIndependentQuestionnaireAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@num" onclick="AllowSingleSelection(this);" />@data.Value
                                                                                                                    </td>
                                                                                                                }
                                                                                                            }
                                                                                                            else if (itemx.Key == "Text")
                                                                                                            {
                                                                                                                <td colspan="2">
                                                                                                                    <label>@data.Value</label>
                                                                                                                    <input type="hidden" id="QuestionIdForTxtAreas-@y" name="QuestionIdForTxtAreas[]" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@ViewBag.GetIndependentQuestionnaireAnswers[nm].QuestionnaireAnswerDetailId" />
                                                                                                                    <textarea class="form-control answers" required id="Answers-@y" rows="4" cols="150" name="Answers[]">@ViewBag.GetIndependentQuestionnaireAnswers[nm].Answer</textarea>
                                                                                                                </td>
                                                                                                            }
                                                                                                            else
                                                                                                            {

                                                                                                                if (ViewBag.GetIndependentQuestionnaireAnswers[nm].Answer.Contains(","))
                                                                                                                {
                                                                                                                    string[] answerArray = ViewBag.GetIndependentQuestionnaireAnswers[nm].Answer.Split(',');

                                                                                                                    <td>
                                                                                                                        @for (var z = 0; z < answerArray.Count(); z++)
                                                                                                                        {
                                                                                                                            if (answerArray[z] == data.Value)
                                                                                                                            {
                                                                                                                                <input type="checkbox" class="answers" checked value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@answerArray[z]-@ViewBag.GetIndependentQuestionnaireAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                                <label>@data.Value</label>
                                                                                                                            }
                                                                                                                        }
                                                                                                                        @if (!answerArray.Contains(data.Value))
                                                                                                                        {
                                                                                                                            <input type="checkbox" class="answers" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@data.Value-@ViewBag.GetIndependentQuestionnaireAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                            <label>@data.Value</label>
                                                                                                                        }

                                                                                                                    </td>
                                                                                                                }
                                                                                                                else
                                                                                                                {
                                                                                                                    if (ViewBag.GetIndependentQuestionnaireAnswers[nm].Answer == data.Value)
                                                                                                                    {
                                                                                                                        <td>
                                                                                                                            <input type="checkbox" class="answers" checked value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@ViewBag.GetIndependentQuestionnaireAnswers[nm].Answer-@ViewBag.GetIndependentQuestionnaireAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                            <label>@data.Value</label>
                                                                                                                        </td>
                                                                                                                    }
                                                                                                                    else if (ViewBag.GetIndependentQuestionnaireAnswers[nm].Answer != data.Value)
                                                                                                                    {
                                                                                                                        <td>
                                                                                                                            <input type="checkbox" class="answers" value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@data.Value-@ViewBag.GetIndependentQuestionnaireAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                            <label>@data.Value</label>
                                                                                                                        </td>
                                                                                                                    }
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }

                                                                                            }
                                                                                        }

                                                                                    </tr>
                                                                                }
                                                                            }
                                                                            else
                                                                            {

                                                                                foreach (var itemQn in group.GroupBy(a => a.Question))
                                                                                {
                                                                                    num++;
                                                                                    <tr>
                                                                                        @{
                                                                                            if (ViewBag.GetIndependentQuestionnaireAnswers != null)
                                                                                            {
                                                                                                for (var mn = 0; mn < ViewBag.GetIndependentQuestionnaireAnswers.Count; mn++)
                                                                                                {
                                                                                                    if (ViewBag.GetIndependentQuestionnaireAnswers[mn].QuestionId == itemQn.Select(a => a.QuestionId).FirstOrDefault())
                                                                                                    {
                                                                                                        questionList.Add((int)itemQn.Select(a => a.QuestionId).FirstOrDefault());
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }

                                                                                        @if (questionList.Contains((int)itemQn.Select(a => a.QuestionId).FirstOrDefault()))
                                                                                        {
                                                                                            <td>
                                                                                                @itemQn.Key
                                                                                            </td>
                                                                                        }

                                                                                        @foreach (var itemx in itemQn.GroupBy(a => a.Lebal))
                                                                                        {

                                                                                            foreach (var data in itemx)
                                                                                            {
                                                                                                y++;

                                                                                                //BEGIN CHECKING IF ANSWERS IS NOT NULL
                                                                                                if (ViewBag.GetIndependentQuestionnaireAnswers != null)
                                                                                                {
                                                                                                    for (var nm = 0; nm < ViewBag.GetIndependentQuestionnaireAnswers.Count; nm++)
                                                                                                    {
                                                                                                        if (ViewBag.GetIndependentQuestionnaireAnswers[nm].QuestionId == @itemQn.Select(a => a.QuestionId).FirstOrDefault())
                                                                                                        {

                                                                                                            if (itemx.Key == "Radio Button")
                                                                                                            {

                                                                                                                if (ViewBag.GetIndependentQuestionnaireAnswers[nm].Answer == data.Value)
                                                                                                                {
                                                                                                                    <td>
                                                                                                                        <input type="checkbox" class="answers" checked value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@ViewBag.GetIndependentQuestionnaireAnswers[nm].Answer-@ViewBag.GetIndependentQuestionnaireAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@num" onclick="AllowSingleSelection(this);" />@data.Value
                                                                                                                    </td>
                                                                                                                }
                                                                                                                else if (ViewBag.GetIndependentQuestionnaireAnswers[nm].Answer != data.Value)
                                                                                                                {
                                                                                                                    <td>
                                                                                                                        <input type="checkbox" class="answers" value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@data.Value-@ViewBag.GetIndependentQuestionnaireAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@num" onclick="AllowSingleSelection(this);" />@data.Value
                                                                                                                    </td>
                                                                                                                }
                                                                                                            }
                                                                                                            else if (itemx.Key == "Text")
                                                                                                            {
                                                                                                                <td colspan="2">
                                                                                                                    <label>@data.Value</label>
                                                                                                                    <input type="hidden" id="QuestionIdForTxtAreas-@y" name="QuestionIdForTxtAreas[]" value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@ViewBag.GetIndependentQuestionnaireAnswers[nm].QuestionnaireAnswerDetailId" />
                                                                                                                    <textarea class="form-control answers" required id="Answers-@y" rows="4" cols="150" name="Answers[]">@ViewBag.GetIndependentQuestionnaireAnswers[nm].Answer</textarea>
                                                                                                                </td>
                                                                                                            }
                                                                                                            else
                                                                                                            {

                                                                                                                if (ViewBag.GetIndependentQuestionnaireAnswers[nm].Answer.Contains(","))
                                                                                                                {
                                                                                                                    string[] answerArray = ViewBag.GetIndependentQuestionnaireAnswers[nm].Answer.Split(',');

                                                                                                                    <td>
                                                                                                                        @for (var z = 0; z < answerArray.Count(); z++)
                                                                                                                        {
                                                                                                                            if (answerArray[z] == data.Value)
                                                                                                                            {
                                                                                                                                <input type="checkbox" class="answers" checked value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@answerArray[z]-@ViewBag.GetIndependentQuestionnaireAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                                <label>@data.Value</label>
                                                                                                                            }
                                                                                                                        }
                                                                                                                        @if (!answerArray.Contains(data.Value))
                                                                                                                        {
                                                                                                                            <input type="checkbox" class="answers" value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@data.Value-@ViewBag.GetIndependentQuestionnaireAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                            <label>@data.Value</label>
                                                                                                                        }

                                                                                                                    </td>
                                                                                                                }
                                                                                                                else
                                                                                                                {
                                                                                                                    if (ViewBag.GetIndependentQuestionnaireAnswers[nm].Answer == data.Value)
                                                                                                                    {
                                                                                                                        <td>
                                                                                                                            <input type="checkbox" class="answers" checked value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@ViewBag.GetIndependentQuestionnaireAnswers[nm].Answer-@ViewBag.GetIndependentQuestionnaireAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                            <label>@data.Value</label>
                                                                                                                        </td>
                                                                                                                    }
                                                                                                                    else if (ViewBag.GetIndependentQuestionnaireAnswers[nm].Answer != data.Value)
                                                                                                                    {
                                                                                                                        <td>
                                                                                                                            <input type="checkbox" class="answers" value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@data.Value-@ViewBag.GetIndependentQuestionnaireAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                            <label>@data.Value</label>
                                                                                                                        </td>
                                                                                                                    }
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                                //END CHECKING IF ANSWERS IS NOT NULL
                                                                                            }
                                                                                        }

                                                                                    </tr>
                                                                                }
                                                                            }
                                                                        }

                                                                    }
                                                                }

                                                            </tbody>
                                                        </table>
                                                        <div class="form-group">
                                                            <div class="col-md-1"></div>
                                                            <a href="@Url.Action("PreliminaryAnalysisList", "PreliminaryAnalysis")" style="margin-right:5px" type="submit" class="btn btn-info pull-left"><i class="glyphicon glyphicon-arrow-left"></i> Back  </a>
                                                            <button class="btn btn-info prevBtn" type="button">Previous &nbsp;<span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span></button>
                                                            <button type="submit" name="submit" class="btn btn-info" id="saveAnswerForm">
                                                                <i class="fa fa-save"></i> Save
                                                                <img src="~/Content/img/loading.gif" class="loadingImg" />
                                                            </button>
                                                            <button class="btn btn-info nextBtn" type="button">Next &nbsp;<span class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span></button>
                                                        </div>
                                                    }
                                                }
                                                /*END EDITING QUESTIONNAIRE ANSWERS*/

                                            }
                                            else
                                            {
                                                <div class="row">
                                                    <div class="col-lg-3 col-sm-3 col-xs-3"></div>
                                                    <div class="col-lg-6 col-sm-6 col-xs-6">

                                                        <div class="alert alert-block alert-info">
                                                            <a class="close" data-dismiss="alert" href="#">×</a>
                                                            <center><span>Organisation Independent Questionnaire will display after Client Information added</span></center>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3 col-sm-3 col-xs-3"></div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>

                            </div>
                            @*---------------------BEGINNING OF STEP THREE--------------------------*@
                            <div class="row setup-content" id="step-3">
                                <div class="form-horizontal">
                                    <div class="col-xs-12">
                                        <div class="col-md-12">
                                            @if (ViewBag.PreliminaryAnalysisId != 0)
                                            {
                                                if (Model.GetSafeGuard == null)
                                                {
                                                    <div class="row">
                                                        <div class="col-lg-3 col-sm-3 col-xs-3"></div>
                                                        <div class="col-lg-6 col-sm-6 col-xs-6">

                                                            <div class="alert alert-block alert-info">
                                                                <a class="close" data-dismiss="alert" href="#">×</a>
                                                                <center><span>Safe Guard Settings not Found,Please Contact System Support</span></center>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-3 col-sm-3 col-xs-3"></div>
                                                    </div>
                                                }
                                                if (Model.GetSafeGuard != null && ViewBag.IsSafeGuardFullAnswered == false)
                                                {
                                                    /*BEGIN ADDING QUESTIONNAIRE ANSWERS*/
                                                    using (Html.BeginForm("SaveQuestionnaire", "PreliminaryAnalysis", FormMethod.Post, new { enctype = "multipart/form-data", id = "Form2", onsubmit = "return validateFormOnCreate(this,'Form2');" }))
                                                    {
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="ModuleId" id="ModuleId" value="@ViewBag.PreliminaryAnalysisId" />
                                                        <input type="hidden" name="Category" id="Category" value="@IFMIS.Areas.Coadmis.Libraries.Constants.CATEGORY_SAFE_GUARD_QUESTIONNAIRE" />
                                                          <div class="col-md-12">
                                                            <div class="col-md-6" style="padding-top:20px">
                                                                <dl class="dl-horizontal">
                                                                    <dt><strong>Client Name:</strong></dt>
                                                                    <dd>@ViewBag.SfClientName</dd>
                                                                    <dt><strong>File No.:</strong></dt>
                                                                    <dd>@ViewBag.SfFileNo</dd>
                                                                    <dt> <strong>Working Paper Ref:</strong></dt>
                                                                    <dd> @ViewBag.SfWorkPaper</dd>
                                                                </dl>
                                                            </div>
                                                            <div class="col-md-6" style="padding-top:20px">
                                                                <dl class="dl-horizontal">
                                                                    <dt>Questionnaire Title</dt>
                                                                    <dd>Safe Guard</dd>
                                                                    <dt><strong>Prepared By:</strong></dt>
                                                                    <dd>@ViewBag.SfPreparedBy</dd>
                                                                    <dt><strong>Prepared At:</strong></dt>
                                                                    <dd>@ViewBag.SfPreparedAt</dd>
                                                                </dl>
                                                            </div>
                                                        </div>
                                                        <table id="dataTableList" class="table table-striped table-bordered table-hover" width="100%">
                                                            <thead><tr></tr></thead>
                                                            <tbody>
                                                                @{ int n = 0; }
                                                               <tr>
                                                                    <td colspan="3" style="">@ViewBag.SfQuestionnaireDescription</td>
                                                                </tr>
                                                                @foreach (var group in Model.GetSafeGuard.GroupBy(a => a.QuestionnairTitleName))
                                                                {
                                                                    n++;
                                                                    <tr data-level='1' style="background:#f5f5f5; color:#000000">
                                                                        <td colspan="13">
                                                                            <strong>
                                                                                <span class="sign"></span>
                                                                                @n. @group.Key
                                                                            </strong>
                                                                        </td>
                                                                    </tr>

                                                                    foreach (var item in group.GroupBy(a => a.QuestionnairSubTitleName))
                                                                    {
                                                                        int y = 0;

                                                                        int num = 0;
                                                                        if (item.Key != null)
                                                                        {
                                                                            <tr data-level='1' style="background:#f5f5f5; color:#000000;">
                                                                                <td colspan="13">
                                                                                    <strong>
                                                                                        <span class="sign"></span>
                                                                                        <i>@item.Key</i>
                                                                                    </strong>
                                                                                </td>
                                                                            </tr>

                                                                            foreach (var itemQn in item.GroupBy(a => a.Question))
                                                                            {
                                                                                num++;
                                                                                <tr>
                                                                                    <td>@itemQn.Key </td>
                                                                                    @foreach (var itemx in itemQn.GroupBy(a => a.Lebal))
                                                                                    {

                                                                                        foreach (var data in itemx)
                                                                                        {
                                                                                            y++;

                                                                                            if (itemx.Key == "Radio Button")
                                                                                            {
                                                                                                <td>
                                                                                                    <input type="checkbox" class="answers" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@data.Value" name="Answers[]" id="Answers-@num" onclick="AllowSingleSelection(this);" onchange="getValueFromCheckbox(this)"/>@data.Value
                                                                                                </td>
                                                                                            }

                                                                                            else if (itemx.Key == "Text")
                                                                                            {
                                                                                                <td colspan="2">
                                                                                                    <label>@data.Value</label>
                                                                                                    <input type="hidden" id="QuestionIdForTextAreas-@y" name="QuestionIdForTextAreas[]" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()" />
                                                                                                    <textarea class="form-control answers" required id="Answers-@y" rows="4" cols="150" name="Answers[]"></textarea>
                                                                                                </td>
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                <td>
                                                                                                    <input type="checkbox" class="answers" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@data.Value" name="Answers[]" id="Answers-@y" onchange="getValueFromCheckbox(this)"/>
                                                                                                    <label>@data.Value</label>
                                                                                                </td>
                                                                                            }
                                                                                        }
                                                                                    }

                                                                                </tr>
                                                                            }
                                                                        }
                                                                        else
                                                                        {

                                                                            foreach (var itemQn in group.GroupBy(a => a.Question))
                                                                            {
                                                                                num++;
                                                                                <tr>
                                                                                    <td>@itemQn.Key </td>
                                                                                    @foreach (var itemx in itemQn.GroupBy(a => a.Lebal))
                                                                                    {

                                                                                        foreach (var data in itemx)
                                                                                        {
                                                                                            y++;

                                                                                            if (itemx.Key == "Radio Button")
                                                                                            {
                                                                                                <td>
                                                                                                    <input type="checkbox" class="answers" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@data.Value" name="Answers[]" id="Answers-@num" onclick="AllowSingleSelection(this);" onchange="getValueFromCheckbox(this)"/>@data.Value
                                                                                                </td>
                                                                                            }

                                                                                            else if (itemx.Key == "Text")
                                                                                            {
                                                                                                <td colspan="2">
                                                                                                    <label>@data.Value</label>
                                                                                                    <input type="hidden" id="QuestionIdForTextAreas-@y" name="QuestionIdForTextAreas[]" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()" />
                                                                                                    <textarea class="form-control answers" required id="Answers-@y" rows="4" cols="150" name="Answers[]"></textarea>
                                                                                                </td>
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                <td>
                                                                                                    <input type="checkbox" class="answers" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@data.Value" name="Answers[]" id="Answers-@y" onchange="getValueFromCheckbox(this)" />
                                                                                                    <label>@data.Value</label>
                                                                                                </td>
                                                                                            }
                                                                                        }
                                                                                    }

                                                                                </tr>
                                                                            }
                                                                        }
                                                                    }

                                                                }

                                                            </tbody>
                                                        </table>

                                                        <div class="form-group">
                                                            <div class="col-md-1"></div>
                                                            <a href="@Url.Action("PreliminaryAnalysisList", "PreliminaryAnalysis")" style="margin-right:5px" type="submit" class="btn btn-info pull-left"><i class="glyphicon glyphicon-arrow-left"></i> Back  </a>
                                                            <button class="btn btn-info prevBtn" type="button">Previous &nbsp;<span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span></button>
                                                            <button type="submit" name="submit" class="btn btn-info" id="saveAnswerFormx">
                                                                <i class="fa fa-save"></i> Save
                                                                <img src="~/Content/img/loading.gif" class="loadingImg" />
                                                            </button>
                                                            <button class="btn btn-info nextBtn" type="button">Next &nbsp;<span class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span></button>
                                                        </div>
                                                    }
                                                    /*END ADDING QUESTIONNAIRE ANSWERS*/
                                                }//END IF STATEMENT

                                                /*BEGIN EDITING QUESTIONNAIRE ANSWERS*/
                                                if (ViewBag.IsSafeGuardFullAnswered)
                                                {
                                                    using (Html.BeginForm("UpdateQuestionnaire", "PreliminaryAnalysis", FormMethod.Post, new { enctype = "multipart/form-data", onsubmit = "return validateForm(this);" }))
                                                    {
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="ModuleId" id="ModuleId" value="@ViewBag.PreliminaryAnalysisId" />
                                                        <input type="hidden" name="Category" id="Category" value="@IFMIS.Areas.Coadmis.Libraries.Constants.CATEGORY_SAFE_GUARD_QUESTIONNAIRE" />
                                                         <div class="col-md-12">
                                                            <div class="col-md-6" style="padding-top:20px">
                                                                <dl class="dl-horizontal">
                                                                    <dt><strong>Client Name:</strong></dt>
                                                                    <dd>@ViewBag.SfClientName</dd>
                                                                    <dt><strong>File No.:</strong></dt>
                                                                    <dd>@ViewBag.SfFileNo</dd>
                                                                    <dt> <strong>Working Paper Ref:</strong></dt>
                                                                    <dd> @ViewBag.SfWorkPaper</dd>
                                                                </dl>
                                                            </div>
                                                            <div class="col-md-6" style="padding-top:20px">
                                                                <dl class="dl-horizontal">
                                                                    <dt>Questionnaire Title</dt>
                                                                    <dd>Safe Guard</dd>
                                                                    <dt><strong>Prepared By:</strong></dt>
                                                                    <dd>@ViewBag.SfPreparedBy</dd>
                                                                    <dt><strong>Prepared At:</strong></dt>
                                                                    <dd>@ViewBag.SfPreparedAt</dd>
                                                                </dl>
                                                            </div>
                                                        </div>
                                                        <table id="dataTableList" class="table table-striped table-bordered table-hover" width="100%">
                                                            <thead><tr></tr></thead>
                                                            <tbody>
                                                                @{ int n = 0; }
								<tr>
                                                                    <td colspan="3" style="">@ViewBag.SfQuestionnaireDescription</td>
                                                                </tr>
                                                                @if (Model.GetSafeGuard != null)
                                                                {
                                                                    foreach (var group in Model.GetSafeGuard.GroupBy(a => a.QuestionnairTitleName))
                                                                    {
                                                                        n++;
                                                                        List<int> questionList = new List<int>();
                                                                        if (ViewBag.GetSafeGuardAnswers != null)
                                                                        {
                                                                            for (var mn = 0; mn < ViewBag.GetSafeGuardAnswers.Count; mn++)
                                                                            {
                                                                                if (ViewBag.GetSafeGuardAnswers[mn].QuestionId == group.Select(a => a.QuestionId).FirstOrDefault())
                                                                                {
                                                                                    questionList.Add((int)group.Select(a => a.QuestionId).FirstOrDefault());
                                                                                }
                                                                            }
                                                                        }

                                                                        if (questionList.Contains((int)group.Select(a => a.QuestionId).FirstOrDefault()))
                                                                        {
                                                                            <tr data-level='1' style="background:#f5f5f5; color:#000000">
                                                                                <td colspan="13">
                                                                                    <strong>
                                                                                        <span class="sign"></span>
                                                                                        @n. @group.Key
                                                                                    </strong>
                                                                                </td>
                                                                            </tr>
                                                                        }
                                                                        foreach (var item in group.GroupBy(a => a.QuestionnairSubTitleName))
                                                                        {
                                                                            int y = 0;

                                                                            int num = 0;
                                                                            if (item.Key != null)
                                                                            {

                                                                                if (questionList.Contains((int)item.Select(a => a.QuestionId).FirstOrDefault()))
                                                                                {
                                                                                    <tr data-level='1' style="background:#f5f5f5; color:#000000;">
                                                                                        <td colspan="13">
                                                                                            <strong>
                                                                                                <span class="sign"></span>
                                                                                                <i>@item.Key</i>
                                                                                            </strong>
                                                                                        </td>
                                                                                    </tr>
                                                                                }
                                                                                foreach (var itemQn in item.GroupBy(a => a.Question))
                                                                                {
                                                                                    num++;
                                                                                    <tr>
                                                                                        @if (questionList.Contains((int)item.Select(a => a.QuestionId).FirstOrDefault()))
                                                                                        {
                                                                                            <td>
                                                                                                @itemQn.Key
                                                                                            </td>
                                                                                        }
                                                                                        @foreach (var itemx in itemQn.GroupBy(a => a.Lebal))
                                                                                        {

                                                                                            foreach (var data in itemx)
                                                                                            {
                                                                                                y++;

                                                                                                if (ViewBag.GetSafeGuardAnswers != null)
                                                                                                {
                                                                                                    for (var nm = 0; nm < ViewBag.GetSafeGuardAnswers.Count; nm++)
                                                                                                    {
                                                                                                        if (ViewBag.GetSafeGuardAnswers[nm].QuestionId == @itemQn.Select(a => a.QuestionId).FirstOrDefault())
                                                                                                        {

                                                                                                            if (itemx.Key == "Radio Button")
                                                                                                            {

                                                                                                                if (ViewBag.GetSafeGuardAnswers[nm].Answer == data.Value)
                                                                                                                {
                                                                                                                    <td>
                                                                                                                        <input type="checkbox" class="answers" checked value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@ViewBag.GetSafeGuardAnswers[nm].Answer-@ViewBag.GetSafeGuardAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@num" onclick="AllowSingleSelection(this);" />@data.Value
                                                                                                                    </td>
                                                                                                                }
                                                                                                                else if (ViewBag.GetSafeGuardAnswers[nm].Answer != data.Value)
                                                                                                                {
                                                                                                                    <td>
                                                                                                                        <input type="checkbox" class="answers" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@data.Value-@ViewBag.GetSafeGuardAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@num" onclick="AllowSingleSelection(this);" />@data.Value
                                                                                                                    </td>
                                                                                                                }
                                                                                                            }
                                                                                                            else if (itemx.Key == "Text")
                                                                                                            {
                                                                                                                <td colspan="2">
                                                                                                                    <label>@data.Value</label>
                                                                                                                    <input type="hidden" id="QuestionIdForTxtAreas-@y" name="QuestionIdForTxtAreas[]" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@ViewBag.GetSafeGuardAnswers[nm].QuestionnaireAnswerDetailId" />
                                                                                                                    <textarea class="form-control answers" required id="Answers-@y" rows="4" cols="150" name="Answers[]">@ViewBag.GetSafeGuardAnswers[nm].Answer</textarea>
                                                                                                                </td>
                                                                                                            }
                                                                                                            else
                                                                                                            {

                                                                                                                if (ViewBag.GetSafeGuardAnswers[nm].Answer.Contains(","))
                                                                                                                {
                                                                                                                    string[] answerArray = ViewBag.GetSafeGuardAnswers[nm].Answer.Split(',');

                                                                                                                    <td>
                                                                                                                        @for (var z = 0; z < answerArray.Count(); z++)
                                                                                                                        {
                                                                                                                            if (answerArray[z] == data.Value)
                                                                                                                            {
                                                                                                                                <input type="checkbox" class="answers" checked value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@answerArray[z]-@ViewBag.GetSafeGuardAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                                <label>@data.Value</label>
                                                                                                                            }
                                                                                                                        }
                                                                                                                        @if (!answerArray.Contains(data.Value))
                                                                                                                        {
                                                                                                                            <input type="checkbox" class="answers" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@data.Value-@ViewBag.GetSafeGuardAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                            <label>@data.Value</label>
                                                                                                                        }

                                                                                                                    </td>
                                                                                                                }
                                                                                                                else
                                                                                                                {
                                                                                                                    if (ViewBag.GetSafeGuardAnswers[nm].Answer == data.Value)
                                                                                                                    {
                                                                                                                        <td>
                                                                                                                            <input type="checkbox" class="answers" checked value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@ViewBag.GetSafeGuardAnswers[nm].Answer-@ViewBag.GetSafeGuardAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                            <label>@data.Value</label>
                                                                                                                        </td>
                                                                                                                    }
                                                                                                                    else if (ViewBag.GetSafeGuardAnswers[nm].Answer != data.Value)
                                                                                                                    {
                                                                                                                        <td>
                                                                                                                            <input type="checkbox" class="answers" value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@data.Value-@ViewBag.GetSafeGuardAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                            <label>@data.Value</label>
                                                                                                                        </td>
                                                                                                                    }
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }

                                                                                            }
                                                                                        }

                                                                                    </tr>
                                                                                }
                                                                            }
                                                                            else
                                                                            {

                                                                                foreach (var itemQn in group.GroupBy(a => a.Question))
                                                                                {
                                                                                    num++;
                                                                                    <tr>
                                                                                        @{
                                                                                            if (ViewBag.GetSafeGuardAnswers != null)
                                                                                            {
                                                                                                for (var mn = 0; mn < ViewBag.GetSafeGuardAnswers.Count; mn++)
                                                                                                {
                                                                                                    if (ViewBag.GetSafeGuardAnswers[mn].QuestionId == itemQn.Select(a => a.QuestionId).FirstOrDefault())
                                                                                                    {
                                                                                                        questionList.Add((int)itemQn.Select(a => a.QuestionId).FirstOrDefault());
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }

                                                                                        @if (questionList.Contains((int)itemQn.Select(a => a.QuestionId).FirstOrDefault()))
                                                                                        {
                                                                                            <td>
                                                                                                @itemQn.Key
                                                                                            </td>
                                                                                        }

                                                                                        @foreach (var itemx in itemQn.GroupBy(a => a.Lebal))
                                                                                        {

                                                                                            foreach (var data in itemx)
                                                                                            {
                                                                                                y++;

                                                                                                //BEGIN CHECKING IF ANSWERS IS NOT NULL
                                                                                                if (ViewBag.GetSafeGuardAnswers != null)
                                                                                                {
                                                                                                    for (var nm = 0; nm < ViewBag.GetSafeGuardAnswers.Count; nm++)
                                                                                                    {
                                                                                                        if (ViewBag.GetSafeGuardAnswers[nm].QuestionId == @itemQn.Select(a => a.QuestionId).FirstOrDefault())
                                                                                                        {

                                                                                                            if (itemx.Key == "Radio Button")
                                                                                                            {

                                                                                                                if (ViewBag.GetSafeGuardAnswers[nm].Answer == data.Value)
                                                                                                                {
                                                                                                                    <td>
                                                                                                                        <input type="checkbox" class="answers" checked value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@ViewBag.GetSafeGuardAnswers[nm].Answer-@ViewBag.GetSafeGuardAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@num" onclick="AllowSingleSelection(this);" />@data.Value
                                                                                                                    </td>
                                                                                                                }
                                                                                                                else if (ViewBag.GetSafeGuardAnswers[nm].Answer != data.Value)
                                                                                                                {
                                                                                                                    <td>
                                                                                                                        <input type="checkbox" class="answers" value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@data.Value-@ViewBag.GetSafeGuardAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@num" onclick="AllowSingleSelection(this);" />@data.Value
                                                                                                                    </td>
                                                                                                                }
                                                                                                            }
                                                                                                            else if (itemx.Key == "Text")
                                                                                                            {
                                                                                                                <td colspan="2">
                                                                                                                    <label>@data.Value</label>
                                                                                                                    <input type="hidden" id="QuestionIdForTxtAreas-@y" name="QuestionIdForTxtAreas[]" value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@ViewBag.GetSafeGuardAnswers[nm].QuestionnaireAnswerDetailId" />
                                                                                                                    <textarea class="form-control answers" required id="Answers-@y" rows="4" cols="150" name="Answers[]">@ViewBag.GetSafeGuardAnswers[nm].Answer</textarea>
                                                                                                                </td>
                                                                                                            }
                                                                                                            else
                                                                                                            {

                                                                                                                if (ViewBag.GetSafeGuardAnswers[nm].Answer.Contains(","))
                                                                                                                {
                                                                                                                    string[] answerArray = ViewBag.GetSafeGuardAnswers[nm].Answer.Split(',');

                                                                                                                    <td>
                                                                                                                        @for (var z = 0; z < answerArray.Count(); z++)
                                                                                                                        {
                                                                                                                            if (answerArray[z] == data.Value)
                                                                                                                            {
                                                                                                                                <input type="checkbox" class="answers" checked value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@answerArray[z]-@ViewBag.GetSafeGuardAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                                <label>@data.Value</label>
                                                                                                                            }
                                                                                                                        }
                                                                                                                        @if (!answerArray.Contains(data.Value))
                                                                                                                        {
                                                                                                                            <input type="checkbox" class="answers" value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@data.Value-@ViewBag.GetSafeGuardAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                            <label>@data.Value</label>
                                                                                                                        }

                                                                                                                    </td>
                                                                                                                }
                                                                                                                else
                                                                                                                {
                                                                                                                    if (ViewBag.GetSafeGuardAnswers[nm].Answer == data.Value)
                                                                                                                    {
                                                                                                                        <td>
                                                                                                                            <input type="checkbox" class="answers" checked value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@ViewBag.GetSafeGuardAnswers[nm].Answer-@ViewBag.GetSafeGuardAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                            <label>@data.Value</label>
                                                                                                                        </td>
                                                                                                                    }
                                                                                                                    else if (ViewBag.GetSafeGuardAnswers[nm].Answer != data.Value)
                                                                                                                    {
                                                                                                                        <td>
                                                                                                                            <input type="checkbox" class="answers" value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@data.Value-@ViewBag.GetSafeGuardAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                            <label>@data.Value</label>
                                                                                                                        </td>
                                                                                                                    }
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                                //END CHECKING IF ANSWERS IS NOT NULL
                                                                                            }
                                                                                        }

                                                                                    </tr>
                                                                                }
                                                                            }
                                                                        }

                                                                    }
                                                                }

                                                            </tbody>
                                                        </table>
                                                        <div class="form-group">
                                                            <div class="col-md-1"></div>
                                                            <a href="@Url.Action("PreliminaryAnalysisList", "PreliminaryAnalysis")" style="margin-right:5px" type="submit" class="btn btn-info pull-left"><i class="glyphicon glyphicon-arrow-left"></i> Back  </a>
                                                            <button class="btn btn-info prevBtn" type="button">Previous &nbsp;<span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span></button>
                                                            <button type="submit" name="submit" class="btn btn-info" id="saveAnswerForm">
                                                                <i class="fa fa-save"></i> Save
                                                                <img src="~/Content/img/loading.gif" class="loadingImg" />
                                                            </button>
                                                            <button class="btn btn-info nextBtn" type="button">Next &nbsp;<span class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span></button>
                                                        </div>
                                                    }
                                                }
                                                /*END EDITING QUESTIONNAIRE ANSWERS*/

                                            }
                                            else
                                            {
                                                <div class="row">
                                                    <div class="col-lg-3 col-sm-3 col-xs-3"></div>
                                                    <div class="col-lg-6 col-sm-6 col-xs-6">

                                                        <div class="alert alert-block alert-info">
                                                            <a class="close" data-dismiss="alert" href="#">×</a>
                                                            <center><span>Safe Guard will display after Independent Questionnaire added</span></center>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3 col-sm-3 col-xs-3"></div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                            @*------------------------------END OF STEP THREE-----------------------------*@
                            @*------------------------------BEGINNING OF STEP FOUR------------------------*@
                            <div class="row setup-content" id="step-4">
                                <div class="form-horizontal">
                                    <div class="col-xs-12">
                                        <div class="col-md-12">
                                            @if (ViewBag.PreliminaryAnalysisId != 0)
                                            {
                                                if (Model.GetEngagementActivities == null)
                                                {
                                                    <div class="row">
                                                        <div class="col-lg-3 col-sm-3 col-xs-3"></div>
                                                        <div class="col-lg-6 col-sm-6 col-xs-6">

                                                            <div class="alert alert-block alert-info">
                                                                <a class="close" data-dismiss="alert" href="#">×</a>
                                                                <center><span>General Preliminary Engagement Settings not Found,Please Contact System Support</span></center>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-3 col-sm-3 col-xs-3"></div>
                                                    </div>
                                                }
                                                if (Model.GetEngagementActivities != null && ViewBag.IsEngagementActivitiesFullAnswered == false)
                                                {
                                                    /*BEGIN ADDING QUESTIONNAIRE ANSWERS*/
                                                    using (Html.BeginForm("SaveQuestionnaire", "PreliminaryAnalysis", FormMethod.Post, new { enctype = "multipart/form-data", id = "Form3", onsubmit = "return validateFormOnCreate(this,'Form3');" }))
                                                    {
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="ModuleId" id="ModuleId" value="@ViewBag.PreliminaryAnalysisId" />
                                                        <input type="hidden" name="Category" id="Category" value="@IFMIS.Areas.Coadmis.Libraries.Constants.CATEGORY_ENGAGEMENT_ACTIVITIES_QUESTIONNAIRE" />
                                                        <div class="col-md-12">
                                                            <div class="col-md-6" style="padding-top:20px">
                                                                <dl class="dl-horizontal">
                                                                    <dt><strong>Client Name:</strong></dt>
                                                                    <dd>@ViewBag.EnClientName</dd>
                                                                    <dt><strong>File No.:</strong></dt>
                                                                    <dd>@ViewBag.EnFileNo</dd>
                                                                    <dt> <strong>Working Paper Ref:</strong></dt>
                                                                    <dd> @ViewBag.EnWorkPaper</dd>
                                                                </dl>
                                                            </div>
                                                            <div class="col-md-6" style="padding-top:20px">
                                                                <dl class="dl-horizontal">
                                                                    <dt>Questionnaire Title</dt>
                                                                    <dd>General Preliminary Engagement</dd>
                                                                    <dt><strong>Prepared By:</strong></dt>
                                                                    <dd>@ViewBag.EnPreparedBy</dd>
                                                                    <dt><strong>Prepared At:</strong></dt>
                                                                    <dd>@ViewBag.EnPreparedAt</dd>
                                                                </dl>
                                                            </div>
                                                        </div>
                                                        <table id="dataTableList" class="table table-striped table-bordered table-hover" width="100%">
                                                            <thead><tr></tr></thead>
                                                            <tbody>
                                                                @{ int n = 0; }
 								 <tr>
                                                                    <td colspan="3" style="">@ViewBag.EnQuestionnaireDescription</td>
                                                                </tr>
                                                                @if (Model.GetEngagementActivities != null)
                                                                {
                                                                    foreach (var group in Model.GetEngagementActivities.GroupBy(a => a.QuestionnairTitleName))
                                                                    {
                                                                        n++;
                                                                        <tr data-level='1' style="background:#f5f5f5; color:#000000">
                                                                            <td colspan="13">
                                                                                <strong>
                                                                                    <span class="sign"></span>
                                                                                    @n. @group.Key
                                                                                </strong>
                                                                            </td>
                                                                        </tr>

                                                                        foreach (var item in group.GroupBy(a => a.QuestionnairSubTitleName))
                                                                        {
                                                                            int y = 0;

                                                                            int num = 0;
                                                                            if (item.Key != null)
                                                                            {
                                                                                <tr data-level='1' style="background:#f5f5f5; color:#000000;">
                                                                                    <td colspan="13">
                                                                                        <strong>
                                                                                            <span class="sign"></span>
                                                                                            <i>@item.Key</i>
                                                                                        </strong>
                                                                                    </td>
                                                                                </tr>

                                                                                foreach (var itemQn in item.GroupBy(a => a.Question))
                                                                                {
                                                                                    num++;
                                                                                    <tr>
                                                                                        <td>@itemQn.Key </td>
                                                                                        @foreach (var itemx in itemQn.GroupBy(a => a.Lebal))
                                                                                        {

                                                                                            foreach (var data in itemx)
                                                                                            {
                                                                                                y++;

                                                                                                if (itemx.Key == "Radio Button")
                                                                                                {
                                                                                                    <td>
                                                                                                        <input type="checkbox" class="answers" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@data.Value" name="Answers[]" id="Answers-@num" onclick="AllowSingleSelection(this);" onchange="getValueFromCheckbox(this)"/>@data.Value
                                                                                                    </td>
                                                                                                }

                                                                                                else if (itemx.Key == "Text")
                                                                                                {
                                                                                                    <td colspan="2">
                                                                                                        <label>@data.Value</label>
                                                                                                        <input type="hidden" id="QuestionIdForTextAreas-@y" name="QuestionIdForTextAreas[]" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()" />
                                                                                                        <textarea class="form-control answers" required id="Answers-@y" rows="4" cols="150" name="Answers[]"></textarea>
                                                                                                    </td>
                                                                                                }
                                                                                                else
                                                                                                {
                                                                                                    <td>
                                                                                                        <input type="checkbox" class="answers" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@data.Value" name="Answers[]" id="Answers-@y" onchange="getValueFromCheckbox(this)"/>
                                                                                                        <label>@data.Value</label>
                                                                                                    </td>
                                                                                                }
                                                                                            }
                                                                                        }

                                                                                    </tr>
                                                                                }
                                                                            }
                                                                            else
                                                                            {

                                                                                foreach (var itemQn in group.GroupBy(a => a.Question))
                                                                                {
                                                                                    num++;
                                                                                    <tr>
                                                                                        <td>@itemQn.Key </td>
                                                                                        @foreach (var itemx in itemQn.GroupBy(a => a.Lebal))
                                                                                        {

                                                                                            foreach (var data in itemx)
                                                                                            {
                                                                                                y++;

                                                                                                if (itemx.Key == "Radio Button")
                                                                                                {
                                                                                                    <td>
                                                                                                        <input type="checkbox" class="answers" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@data.Value" name="Answers[]" id="Answers-@num" onclick="AllowSingleSelection(this);" onchange="getValueFromCheckbox(this)"/>@data.Value
                                                                                                    </td>
                                                                                                }

                                                                                                else if (itemx.Key == "Text")
                                                                                                {
                                                                                                    <td colspan="2">
                                                                                                        <label>@data.Value</label>
                                                                                                        <input type="hidden" id="QuestionIdForTextAreas-@y" name="QuestionIdForTextAreas[]" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()" />
                                                                                                        <textarea class="form-control answers" required id="Answers-@y" rows="4" cols="150" name="Answers[]"></textarea>
                                                                                                    </td>
                                                                                                }
                                                                                                else
                                                                                                {
                                                                                                    <td>
                                                                                                        <input type="checkbox" class="answers" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@data.Value" name="Answers[]" id="Answers-@y" onchange="getValueFromCheckbox(this)" />
                                                                                                        <label>@data.Value</label>
                                                                                                    </td>
                                                                                                }
                                                                                            }
                                                                                        }

                                                                                    </tr>
                                                                                }
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                            </tbody>
                                                        </table>

                                                        <div class="form-group">
                                                            <div class="col-md-1"></div>
                                                            <a href="@Url.Action("PreliminaryAnalysisList", "PreliminaryAnalysis")" style="margin-right:5px" type="submit" class="btn btn-info pull-left"><i class="glyphicon glyphicon-arrow-left"></i> Back  </a>
                                                            <button class="btn btn-info prevBtn" type="button">Previous &nbsp;<span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span></button>
                                                            <button type="submit" name="submit" class="btn btn-info" id="saveAnswerForm">
                                                                <i class="fa fa-save"></i> Save
                                                                <img src="~/Content/img/loading.gif" class="loadingImg" />
                                                            </button>
                                                            <button class="btn btn-info nextBtn" type="button">Next &nbsp;<span class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span></button>
                                                        </div>
                                                    }
                                                    /*END ADDING QUESTIONNAIRE ANSWERS*/
                                                }//END IF STATEMENT

                                                /*BEGIN EDITING QUESTIONNAIRE ANSWERS*/
                                                if (ViewBag.IsEngagementActivitiesFullAnswered)
                                                {
                                                    using (Html.BeginForm("UpdateQuestionnaire", "PreliminaryAnalysis", FormMethod.Post, new { enctype = "multipart/form-data", onsubmit = "return validateForm(this);" }))
                                                    {
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="ModuleId" id="ModuleId" value="@ViewBag.PreliminaryAnalysisId" />
                                                        <input type="hidden" name="Category" id="Category" value="@IFMIS.Areas.Coadmis.Libraries.Constants.CATEGORY_ENGAGEMENT_ACTIVITIES_QUESTIONNAIRE" />
							<div class="col-md-12">
                                                            <div class="col-md-6" style="padding-top:20px">
                                                                <dl class="dl-horizontal">
                                                                    <dt><strong>Client Name:</strong></dt>
                                                                    <dd>@ViewBag.EnClientName</dd>
                                                                    <dt><strong>File No.:</strong></dt>
                                                                    <dd>@ViewBag.EnFileNo</dd>
                                                                    <dt> <strong>Working Paper Ref:</strong></dt>
                                                                    <dd> @ViewBag.EnWorkPaper</dd>
                                                                </dl>
                                                            </div>
                                                            <div class="col-md-6" style="padding-top:20px">
                                                                <dl class="dl-horizontal">
                                                                    <dt>Questionnaire Title</dt>
                                                                    <dd>General Preliminary Engagement</dd>
                                                                    <dt><strong>Prepared By:</strong></dt>
                                                                    <dd>@ViewBag.EnPreparedBy</dd>
                                                                    <dt><strong>Prepared At:</strong></dt>
                                                                    <dd>@ViewBag.EnPreparedAt</dd>
                                                                </dl>
                                                            </div>
                                                        </div>
                                                        <table id="dataTableList" class="table table-striped table-bordered table-hover" width="100%">
                                                            <thead><tr></tr></thead>
                                                            <tbody>
                                                                @{ int n = 0; }
								<tr>
                                                                    <td colspan="3" style="">@ViewBag.EnQuestionnaireDescription</td>
                                                                </tr>
                                                                @if (Model.GetEngagementActivities != null)
                                                                {
                                                                    foreach (var group in Model.GetEngagementActivities.GroupBy(a => a.QuestionnairTitleName))
                                                                    {
                                                                        n++;
                                                                        List<int> questionList = new List<int>();
                                                                        if (ViewBag.GetEngagementActivitiesAnswers != null)
                                                                        {
                                                                            for (var mn = 0; mn < ViewBag.GetEngagementActivitiesAnswers.Count; mn++)
                                                                            {
                                                                                if (ViewBag.GetEngagementActivitiesAnswers[mn].QuestionId == group.Select(a => a.QuestionId).FirstOrDefault())
                                                                                {
                                                                                    questionList.Add((int)group.Select(a => a.QuestionId).FirstOrDefault());
                                                                                }
                                                                            }
                                                                        }

                                                                        if (questionList.Contains((int)group.Select(a => a.QuestionId).FirstOrDefault()))
                                                                        {
                                                                            <tr data-level='1' style="background:#f5f5f5; color:#000000">
                                                                                <td colspan="13">
                                                                                    <strong>
                                                                                        <span class="sign"></span>
                                                                                        @n. @group.Key
                                                                                    </strong>
                                                                                </td>
                                                                            </tr>
                                                                        }
                                                                        foreach (var item in group.GroupBy(a => a.QuestionnairSubTitleName))
                                                                        {
                                                                            int y = 0;

                                                                            int num = 0;
                                                                            if (item.Key != null)
                                                                            {

                                                                                if (questionList.Contains((int)item.Select(a => a.QuestionId).FirstOrDefault()))
                                                                                {
                                                                                    <tr data-level='1' style="background:#f5f5f5; color:#000000;">
                                                                                        <td colspan="13">
                                                                                            <strong>
                                                                                                <span class="sign"></span>
                                                                                                <i>@item.Key</i>
                                                                                            </strong>
                                                                                        </td>
                                                                                    </tr>
                                                                                }
                                                                                foreach (var itemQn in item.GroupBy(a => a.Question))
                                                                                {
                                                                                    num++;
                                                                                    <tr>
                                                                                        @if (questionList.Contains((int)item.Select(a => a.QuestionId).FirstOrDefault()))
                                                                                        {
                                                                                            <td>
                                                                                                @itemQn.Key
                                                                                            </td>
                                                                                        }
                                                                                        @foreach (var itemx in itemQn.GroupBy(a => a.Lebal))
                                                                                        {

                                                                                            foreach (var data in itemx)
                                                                                            {
                                                                                                y++;

                                                                                                if (ViewBag.GetEngagementActivitiesAnswers != null)
                                                                                                {
                                                                                                    for (var nm = 0; nm < ViewBag.GetEngagementActivitiesAnswers.Count; nm++)
                                                                                                    {
                                                                                                        if (ViewBag.GetEngagementActivitiesAnswers[nm].QuestionId == @itemQn.Select(a => a.QuestionId).FirstOrDefault())
                                                                                                        {

                                                                                                            if (itemx.Key == "Radio Button")
                                                                                                            {

                                                                                                                if (ViewBag.GetEngagementActivitiesAnswers[nm].Answer == data.Value)
                                                                                                                {
                                                                                                                    <td>
                                                                                                                        <input type="checkbox" class="answers" checked value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@ViewBag.GetEngagementActivitiesAnswers[nm].Answer-@ViewBag.GetEngagementActivitiesAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@num" onclick="AllowSingleSelection(this);" />@data.Value
                                                                                                                    </td>
                                                                                                                }
                                                                                                                else if (ViewBag.GetEngagementActivitiesAnswers[nm].Answer != data.Value)
                                                                                                                {
                                                                                                                    <td>
                                                                                                                        <input type="checkbox" class="answers" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@data.Value-@ViewBag.GetEngagementActivitiesAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@num" onclick="AllowSingleSelection(this);" />@data.Value
                                                                                                                    </td>
                                                                                                                }
                                                                                                            }
                                                                                                            else if (itemx.Key == "Text")
                                                                                                            {
                                                                                                                <td colspan="2">
                                                                                                                    <label>@data.Value</label>
                                                                                                                    <input type="hidden" id="QuestionIdForTxtAreas-@y" name="QuestionIdForTxtAreas[]" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@ViewBag.GetEngagementActivitiesAnswers[nm].QuestionnaireAnswerDetailId" />
                                                                                                                    <textarea class="form-control answers" required id="Answers-@y" rows="4" cols="150" name="Answers[]">@ViewBag.GetEngagementActivitiesAnswers[nm].Answer</textarea>
                                                                                                                </td>
                                                                                                            }
                                                                                                            else
                                                                                                            {

                                                                                                                if (ViewBag.GetEngagementActivitiesAnswers[nm].Answer.Contains(","))
                                                                                                                {
                                                                                                                    string[] answerArray = ViewBag.GetEngagementActivitiesAnswers[nm].Answer.Split(',');

                                                                                                                    <td>
                                                                                                                        @for (var z = 0; z < answerArray.Count(); z++)
                                                                                                                        {
                                                                                                                            if (answerArray[z] == data.Value)
                                                                                                                            {
                                                                                                                                <input type="checkbox" class="answers" checked value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@answerArray[z]-@ViewBag.GetEngagementActivitiesAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                                <label>@data.Value</label>
                                                                                                                            }
                                                                                                                        }
                                                                                                                        @if (!answerArray.Contains(data.Value))
                                                                                                                        {
                                                                                                                            <input type="checkbox" class="answers" value="@itemQn.Select(a=>a.QuestionId).FirstOrDefault()_@data.Value-@ViewBag.GetEngagementActivitiesAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                            <label>@data.Value</label>
                                                                                                                        }

                                                                                                                    </td>
                                                                                                                }
                                                                                                                else
                                                                                                                {
                                                                                                                    if (ViewBag.GetEngagementActivitiesAnswers[nm].Answer == data.Value)
                                                                                                                    {
                                                                                                                        <td>
                                                                                                                            <input type="checkbox" class="answers" checked value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@ViewBag.GetEngagementActivitiesAnswers[nm].Answer-@ViewBag.GetEngagementActivitiesAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                            <label>@data.Value</label>
                                                                                                                        </td>
                                                                                                                    }
                                                                                                                    else if (ViewBag.GetEngagementActivitiesAnswers[nm].Answer != data.Value)
                                                                                                                    {
                                                                                                                        <td>
                                                                                                                            <input type="checkbox" class="answers" value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@data.Value-@ViewBag.GetEngagementActivitiesAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                            <label>@data.Value</label>
                                                                                                                        </td>
                                                                                                                    }
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }

                                                                                            }
                                                                                        }

                                                                                    </tr>
                                                                                }
                                                                            }
                                                                            else
                                                                            {

                                                                                foreach (var itemQn in group.GroupBy(a => a.Question))
                                                                                {
                                                                                    num++;
                                                                                    <tr>
                                                                                        @{
                                                                                            if (ViewBag.GetEngagementActivitiesAnswers != null)
                                                                                            {
                                                                                                for (var mn = 0; mn < ViewBag.GetEngagementActivitiesAnswers.Count; mn++)
                                                                                                {
                                                                                                    if (ViewBag.GetEngagementActivitiesAnswers[mn].QuestionId == itemQn.Select(a => a.QuestionId).FirstOrDefault())
                                                                                                    {
                                                                                                        questionList.Add((int)itemQn.Select(a => a.QuestionId).FirstOrDefault());
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }

                                                                                        @if (questionList.Contains((int)itemQn.Select(a => a.QuestionId).FirstOrDefault()))
                                                                                        {
                                                                                            <td>
                                                                                                @itemQn.Key
                                                                                            </td>
                                                                                        }

                                                                                        @foreach (var itemx in itemQn.GroupBy(a => a.Lebal))
                                                                                        {

                                                                                            foreach (var data in itemx)
                                                                                            {
                                                                                                y++;

                                                                                                //BEGIN CHECKING IF ANSWERS IS NOT NULL
                                                                                                if (ViewBag.GetEngagementActivitiesAnswers != null)
                                                                                                {
                                                                                                    for (var nm = 0; nm < ViewBag.GetEngagementActivitiesAnswers.Count; nm++)
                                                                                                    {
                                                                                                        if (ViewBag.GetEngagementActivitiesAnswers[nm].QuestionId == @itemQn.Select(a => a.QuestionId).FirstOrDefault())
                                                                                                        {

                                                                                                            if (itemx.Key == "Radio Button")
                                                                                                            {

                                                                                                                if (ViewBag.GetEngagementActivitiesAnswers[nm].Answer == data.Value)
                                                                                                                {
                                                                                                                    <td>
                                                                                                                        <input type="checkbox" class="answers" checked value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@ViewBag.GetEngagementActivitiesAnswers[nm].Answer-@ViewBag.GetEngagementActivitiesAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@num" onclick="AllowSingleSelection(this);" />@data.Value
                                                                                                                    </td>
                                                                                                                }
                                                                                                                else if (ViewBag.GetEngagementActivitiesAnswers[nm].Answer != data.Value)
                                                                                                                {
                                                                                                                    <td>
                                                                                                                        <input type="checkbox" class="answers" value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@data.Value-@ViewBag.GetEngagementActivitiesAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@num" onclick="AllowSingleSelection(this);" />@data.Value
                                                                                                                    </td>
                                                                                                                }
                                                                                                            }
                                                                                                            else if (itemx.Key == "Text")
                                                                                                            {
                                                                                                                <td colspan="2">
                                                                                                                    <label>@data.Value</label>
                                                                                                                    <input type="hidden" id="QuestionIdForTxtAreas-@y" name="QuestionIdForTxtAreas[]" value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@ViewBag.GetEngagementActivitiesAnswers[nm].QuestionnaireAnswerDetailId" />
                                                                                                                    <textarea class="form-control answers" required id="Answers-@y" rows="4" cols="150" name="Answers[]">@ViewBag.GetEngagementActivitiesAnswers[nm].Answer</textarea>
                                                                                                                </td>
                                                                                                            }
                                                                                                            else
                                                                                                            {

                                                                                                                if (ViewBag.GetEngagementActivitiesAnswers[nm].Answer.Contains(","))
                                                                                                                {
                                                                                                                    string[] answerArray = ViewBag.GetEngagementActivitiesAnswers[nm].Answer.Split(',');

                                                                                                                    <td>
                                                                                                                        @for (var z = 0; z < answerArray.Count(); z++)
                                                                                                                        {
                                                                                                                            if (answerArray[z] == data.Value)
                                                                                                                            {
                                                                                                                                <input type="checkbox" class="answers" checked value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@answerArray[z]-@ViewBag.GetEngagementActivitiesAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                                <label>@data.Value</label>
                                                                                                                            }
                                                                                                                        }
                                                                                                                        @if (!answerArray.Contains(data.Value))
                                                                                                                        {
                                                                                                                            <input type="checkbox" class="answers" value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@data.Value-@ViewBag.GetEngagementActivitiesAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                            <label>@data.Value</label>
                                                                                                                        }

                                                                                                                    </td>
                                                                                                                }
                                                                                                                else
                                                                                                                {
                                                                                                                    if (ViewBag.GetEngagementActivitiesAnswers[nm].Answer == data.Value)
                                                                                                                    {
                                                                                                                        <td>
                                                                                                                            <input type="checkbox" class="answers" checked value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@ViewBag.GetEngagementActivitiesAnswers[nm].Answer-@ViewBag.GetEngagementActivitiesAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                            <label>@data.Value</label>
                                                                                                                        </td>
                                                                                                                    }
                                                                                                                    else if (ViewBag.GetEngagementActivitiesAnswers[nm].Answer != data.Value)
                                                                                                                    {
                                                                                                                        <td>
                                                                                                                            <input type="checkbox" class="answers" value="@itemQn.Select(a => a.QuestionId).FirstOrDefault()_@data.Value-@ViewBag.GetEngagementActivitiesAnswers[nm].QuestionnaireAnswerDetailId" name="Answers[]" id="Answers-@y" />
                                                                                                                            <label>@data.Value</label>
                                                                                                                        </td>
                                                                                                                    }
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                                //END CHECKING IF ANSWERS IS NOT NULL
                                                                                            }
                                                                                        }

                                                                                    </tr>
                                                                                }
                                                                            }
                                                                        }

                                                                    }
                                                                }

                                                            </tbody>
                                                        </table>
                                                        <div class="form-group">
                                                            <div class="col-md-1"></div>
                                                            <a href="@Url.Action("PreliminaryAnalysisList", "PreliminaryAnalysis")" style="margin-right:5px" type="submit" class="btn btn-info pull-left"><i class="glyphicon glyphicon-arrow-left"></i> Back  </a>
                                                            <button class="btn btn-info prevBtn" type="button">Previous &nbsp;<span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span></button>
                                                            <button type="submit" name="submit" class="btn btn-info" id="saveAnswerForm">
                                                                <i class="fa fa-save"></i> Save
                                                                <img src="~/Content/mg/loading.gif" class="loadingImg" />

                                                            </button>
                                                            <button class="btn btn-info nextBtn" type="button">Next &nbsp;<span class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span></button>
                                                        </div>
                                                    }
                                                }
                                                /*END EDITING QUESTIONNAIRE ANSWERS*/

                                            }
                                            else
                                            {
                                                <div class="row">
                                                    <div class="col-lg-3 col-sm-3 col-xs-3"></div>
                                                    <div class="col-lg-6 col-sm-6 col-xs-6">

                                                        <div class="alert alert-block alert-info">
                                                            <a class="close" data-dismiss="alert" href="#">×</a>
                                                            <center><span>General Preliminary Engagement Questionnaire will display after Safe Guard Questionnaire added</span></center>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3 col-sm-3 col-xs-3"></div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                            @*------------------------------------END OF STEP FOUR---------------------------------------*@
                        </div>
                    </div>
                </div>
            </article>

        </div>
    </section>

</div>

@section pagespecific {
    <!-- PAGE RELATED PLUGIN(S) -->
    <script type="text/javascript">

 

        function AllowSingleSelection(checkboxObject) {
            var getQuestion = checkboxObject.value;
            var question = getQuestion.substring(0, getQuestion.indexOf('_'));
            //Get the parent control of checkbox which is the checkbox list
            var checkboxObjectList = checkboxObject.parentNode.parentNode.parentNode;
            //Get the checkbox controls in checkboxlist
            var checkboxControls = checkboxObjectList.getElementsByTagName("input");
            //Loop through each check box controls
            for (var i = 0; i < checkboxControls.length; i++) {
                //Check the current checkbox is not the one user selected
                if (checkboxControls[i] != checkboxObject && checkboxObject.checked &&
                    question == checkboxControls[i].value.substring(0, checkboxControls[i].value.indexOf('_'))) {
                    //Uncheck all other checkboxes
                    checkboxControls[i].checked = false;
                }
            }
        }

        var financialYearId = null;
        var financialYearName = null;
        document.getElementById("FinancialYearId").style.backgroundColor = 'white';
         $("#ClientInformationId").change(function () {
            var clientInformationId = $(this).val();
            $.ajax({
                url: '@Url.Action("GetFinancialYearByClientInformationId", "AuditableAreaAssignment")/?clientInformationId=' + clientInformationId,
                type: "GET",
                dataType: "json",
                success: function (response) {
                    if (response.accountingFinancialYearId != undefined && response.accountingFinancialYearId != 0) {
                        financialYearId = response.accountingFinancialYearId;
                        financialYearName = response.financialYearName;
                        document.getElementById("FinancialYearId").value = response.financialYearName;
                    }
                }
            });
        });

        //SHOW LOADER ICON
        $(document).ajaxStart(function () {
            $(".loadingImg").show();

        });
        //HIDE LOADER ICON
        $(document).ajaxStop(function () {
            $(".loadingImg").hide();
        });

        $(document).ready(function () {
            $(".ProfessionalClearanceDiv").show();
            if (@ViewBag.ClientInformationId != 0) {
                 $.ajax({
                url: '@Url.Action("GetClientTypeFromClientInformation", "PreliminaryAnalysis")/?clientInformationId=' + @ViewBag.ClientInformationId,
                type: "GET",
                dataType: "json",
                  success: function (response) {
                      if (response == '@IFMIS.Areas.Coadmis.Libraries.Constants.COOPERATIVE') {
                             $(".ProfessionalClearanceDiv").hide();
                         } else {
                             $(".ProfessionalClearanceDiv").show();
                         }
                  }
                 })
            }

             $.ajax({
                url: '@Url.Action("GetFinancialYearByClientInformationId", "AuditableAreaAssignment")/?clientInformationId=' + '@ViewBag.ClientInformationId',
                type: "GET",
                dataType: "json",
                 success: function (response) {
                     if (response.accountingFinancialYearId != undefined && response.accountingFinancialYearId != 0) {
                         financialYearId = response.accountingFinancialYearId;
                         financialYearName = response.financialYearName;
                         document.getElementById("FinancialYearId").value = response.financialYearName;
                     }
                }
             });
        });

        //MANAGE STEP WIZARD
        var navListItems = $('div.setup-panel div a'),
            allWells = $('.setup-content'),
            allNextBtn = $('.nextBtn');
            allPrevBtn = $('.prevBtn');

        allWells.hide();

        navListItems.click(function (e) {
            e.preventDefault();
            var $target = $($(this).attr('href')),
                $item = $(this);

            if (!$item.hasClass('disabled')) {
                navListItems.removeClass('btn-primary').addClass('btn-default');
                $item.addClass('btn-primary');
                allWells.hide();
                $target.show();
                $target.find('input:eq(0)').focus();
            }
        });

        allPrevBtn.click(function () {
            var curStep = $(this).closest(".setup-content"),
                curStepBtn = curStep.attr("id"),
                prevStepWizard = $('div.setup-panel div a[href="#' + curStepBtn + '"]').parent().prev().children("a");
            prevStepWizard.removeAttr('disabled').trigger('click');
        });

        allNextBtn.click(function () {
            var curStep = $(this).closest(".setup-content"),
                curStepBtn = curStep.attr("id"),
                nextStepWizard = $('div.setup-panel div a[href="#' + curStepBtn + '"]').parent().next().children("a"),
                curInputs = curStep.find("input[type='text'],input[type='url']"),
                isValid = true;

            $(".form-group").removeClass("has-error");
            for (var i = 0; i < curInputs.length; i++) {
                if (!curInputs[i].validity.valid) {
                    isValid = false;
                    $(curInputs[i]).closest(".form-group").addClass("has-error");
                }
            }

            if (isValid)
                nextStepWizard.removeAttr('disabled').trigger('click');
        });

        $('div.setup-panel div a.btn-primary').trigger('click');
            //END MANAGE STEP WIZARD

        $("#ClientInformationId").change(function () {
            var clientInformationId = $(this).val();
            $.ajax({
                url: '@Url.Action("GetEngagementFromClientInformation", "PreliminaryAnalysis")/?clientInformationId=' + clientInformationId,
                type: "GET",
                dataType: "json",
                success: function (data) {
                    if (parseInt(data) == 0) {
                        //THE CLIENT IS NEW TO COASCO
                        document.getElementById("ClientType").value = "@IFMIS.Areas.Coadmis.Libraries.Constants.NON_COOPERATIVE";
                        $(".ProfessionalClearanceDiv").show();
                    }
                    else {
                        //THE CLIENT IS ALREADY PRESENT COASCO
                        getClientTypeFromClientInformation(clientInformationId);
                        document.getElementById("ClientType").value = "@IFMIS.Areas.Coadmis.Libraries.Constants.COOPERATIVE";
                        $(".ProfessionalClearanceDiv").hide();
                    }
                }
            })
        });

        function getClientTypeFromClientInformation(clientInformationId) {
              $.ajax({
                url: '@Url.Action("GetClientTypeFromClientInformation", "PreliminaryAnalysis")/?clientInformationId=' + clientInformationId,
                type: "GET",
                dataType: "json",
                  success: function (response) {
                      if (response == '@IFMIS.Areas.Coadmis.Libraries.Constants.COOPERATIVE') {
                          document.getElementById("ClientType").value = "@IFMIS.Areas.Coadmis.Libraries.Constants.COOPERATIVE";
                          $(".ProfessionalClearanceDiv").hide();
                      } else {
                          document.getElementById("ClientType").value = "@IFMIS.Areas.Coadmis.Libraries.Constants.NON_COOPERATIVE";
                          $(".ProfessionalClearanceDiv").show();
                      }
                }
            })
        }
        /*BEGINNING SAVING PRELIMINARY ANALYSIS FORM*/
        function savePreliminaryAnalysisForm() {
            var errorMessage = [];
            var clientInformationId = $("#ClientInformationId").val();
            var status = $("#Status").val();
            var clientType = document.getElementById("ClientType").value;
            if (clientInformationId == '' || financialYearId == '' || financialYearId == undefined || financialYearId == 0 || status == ''){
                if (clientInformationId == '') {
                    errorMessage.push("Client");
                }
                if (financialYearId == '' || financialYearId == undefined || financialYearId == 0) {
                    errorMessage.push("Financial Year (Contact Administrator to add Accounting Financial Year)");
                }

                if (status == '') {
                    errorMessage.push("Status");
                }

              swal("Please fill the correct values for fields: " + errorMessage);
              $(".loadingImg").toggle(false);
              $("#savePreliminaryAnalysisBtn").prop('disabled', false);
                return false;
            }
            else {
            if (clientType == "@IFMIS.Areas.Coadmis.Libraries.Constants.NON_COOPERATIVE" && '@ViewBag.Engagement.ToString().ToUpper()' == 'FALSE') {
                   var professionalClearance = document.getElementById("ProfessionalClearance").value;
                if (professionalClearance != '') {
                    var professionalClearance = document.querySelector("#ProfessionalClearance");
                    if (/\.(pdf)$/i.test(professionalClearance.files[0].name) === false) {
                        swal("Please Upload Professional Clearance Attachment (Only PDF is Required)");
                        $(".loadingImg").toggle(false);
                        $("#savePreliminaryAnalysisBtn").prop('disabled', false);
                        return false;
                    }
                }
            }
            var formData = new FormData()
            formData.append('__RequestVerificationToken', $('[name=__RequestVerificationToken]').val());
            formData.append('ClientInformationId', clientInformationId);
            formData.append('FinancialYearId', financialYearId);
            formData.append('Status', status);
            if (clientType == "@IFMIS.Areas.Coadmis.Libraries.Constants.NON_COOPERATIVE" && '@ViewBag.Engagement.ToString().ToUpper()' == 'FALSE') {
            formData.append('ProfessionalClearance', $('#ProfessionalClearance')[0].files[0]);
            }
            postFormData(formData);
            }
        }

    function postFormData(formData) {
        url = '@Url.Action("SavePreliminaryAnalysis", "PreliminaryAnalysis")';

        $("#savePreliminaryAnalysisBtn").prop('disabled', true);
        $(".loadingImg").toggle(true);
        $.ajax({
            url: url,
            data: formData,
            type: 'POST',
            contentType: false,
            processData: false,
            success: function (resultData) {
                $("#savePreliminaryAnalysisBtn").prop('disabled', true);
                $(".loadingImg").toggle(true);

                if (resultData.response == "Success") {
                    swal("Saved Successfully!", { icon: "success" })
                        .then((m) => {
                            window.location.href ='@Request.Url.ToString()'+"?id="+resultData.id;
                        });
                } else {
                    $("#savePreliminaryAnalysisBtn").prop('disabled', false);
                    $(".loadingImg").toggle(false);
                    swal(resultData.response)
                }
            },
            failure: function (response) {
                $("#savePreliminaryAnalysisBtn").prop('disabled', false);
                $(".loadingImg").toggle(false);
                swal("An error occured during saving Preliminary Analysis First Stage, Please Contact System Support: ",response)
            }
        });
    }
    /*ENDING SAVING PRELIMINARY ANALYSIS FORM*/

   /*BEGINNING UPDATING PRELIMINARY ANALYSIS FORM*/
        function updatePreliminaryAnalysisForm() {
            var errorMessage = [];
            var clientInformationId = $("#ClientInformationId").val();
            var status = $("#Status").val();
            var clientType = document.getElementById("ClientType").value;

             if (clientInformationId == '' || financialYearId == '' || financialYearId == undefined || financialYearId == 0 || status == ''){
                if (clientInformationId == '') {
                    errorMessage.push("Client");
                }
                if (financialYearId == '' || financialYearId == undefined || financialYearId == 0) {
                    errorMessage.push("Financial Year (Contact Administrator to add Accounting Financial Year)");
                }

                if (status == '') {
                    errorMessage.push("Status");
                }

              swal("Please fill the correct values for fields: " + errorMessage);
              $(".loadingImg").toggle(false);
              $("#savePreliminaryAnalysisBtn").prop('disabled', false);
                return false;
            }
            else {
            if (clientType == "@IFMIS.Areas.Coadmis.Libraries.Constants.NON_COOPERATIVE" && '@ViewBag.Engagement.ToString().ToUpper()' == 'FALSE') {
                var professionalClearance = document.getElementById("ProfessionalClearance").value;
                if (professionalClearance != '') {

                    var professionalClearance = document.querySelector("#ProfessionalClearance");
                    if (/\.(pdf)$/i.test(professionalClearance.files[0].name) === false) {
                        swal("Please Upload Professional Clearance Attachment (Only PDF is Required)");
                        $(".loadingImg").toggle(false);
                        $("#savePreliminaryAnalysisBtn").prop('disabled', false);
                        return false;
                    }
                }
            }
            var formData = new FormData()
            formData.append('__RequestVerificationToken', $('[name=__RequestVerificationToken]').val());
            formData.append('ClientInformationId', clientInformationId);
            formData.append('FinancialYearId', financialYearId);
            formData.append('Status', status);
            formData.append('PreliminaryAnalysisId', '@ViewBag.PreliminaryAnalysisId');
            if (clientType == "@IFMIS.Areas.Coadmis.Libraries.Constants.NON_COOPERATIVE" && '@ViewBag.Engagement.ToString().ToUpper()' == 'FALSE')  {
            formData.append('ProfessionalClearance', $('#ProfessionalClearance')[0].files[0]);
            }
            updateFormData(formData);
            }
        }

    function updateFormData(formData) {
        url = '@Url.Action("UpdatePreliminaryAnalysis", "PreliminaryAnalysis")';

        $("#savePreliminaryAnalysisBtn").prop('disabled', true);
        $(".loadingImg").toggle(true);
        $.ajax({
            url: url,
            data: formData,
            type: 'POST',
            contentType: false,
            processData: false,
            success: function (resultData) {
                $("#savePreliminaryAnalysisBtn").prop('disabled', true);
                $(".loadingImg").toggle(true);

                if (resultData.response == "Success") {
                    swal("Saved Successfully!", { icon: "success" })
                        .then((m) => {
                           window.location.href ='@Request.Url.ToString()';
                        });
                } else {
                    $("#savePreliminaryAnalysisBtn").prop('disabled', false);
                    $(".loadingImg").toggle(false);
                    swal(resultData.response)
                }
            },
            failure: function (response) {
                $("#savePreliminaryAnalysisBtn").prop('disabled', false);
                $(".loadingImg").toggle(false);
                swal("An error occured during updating Preliminary Analysis First Stage, Please Contact System Support: ",response)
            }
        });
    }

   /*ENDING UPDATING PRELIMINARY ANALYSIS FORM*/
   var answerSet = new Set();
        var getAnswer = null;
        var answer = null;
        function getValueFromCheckbox(checkboxData) {
            answer = checkboxData.value;
            getAnswer = answer.substring(0, answer.indexOf('_'));
            answerSet.add(getAnswer);
        }
        const checkIfSetsAreEqual = (xs, ys) =>
            xs.size === ys.size &&
            [...xs].every((x) => ys.has(x));

        function validateForm(formObj) {
            $(".loadingImg").show();
            formObj.submit.disabled = true;
            formObj.submit.value = 'Please Wait...';
            successMessage = true;
            $("#saveAnswerForm").prop('disabled', true);
        }
        function validateFormOnCreate(formObj, category) {
            $(".loadingImg").show();
            formObj.submit.disabled = true;
            formObj.submit.value = 'Please Wait...';
            successMessage = true;
            var inputs = null;
            var isCheckBoxQuestion = false;
            var errorMessage = null;
            switch (category) {
                case "Form1":
                    inputs = document.querySelectorAll('#Form1 .answers');
                    errorMessage = "Please Answer all Organisation Independent Questionnaire";
                    break;

                case "Form2":
                    inputs = document.querySelectorAll('#Form2 .answers');
                    errorMessage = "Please Answer all Safe Guard Questionnaire";
                    break;

                case "Form3":
                    inputs = document.querySelectorAll('#Form3 .answers');
                    errorMessage = "Please Answer all General Preliminary Engagement Questionnaire";
                    break;
            }
            var questionSet = new Set();
            var getQuestion = null;
            var question = null;
            for (var i = 0; i < inputs.length; i++) {
                if (inputs[i].tagName == "INPUT" && inputs[i].tagName != "TEXTAREA") {
                    isCheckBoxQuestion = true;
                    question = inputs[i].value;
                    getQuestion = question.substring(0, question.indexOf('_'));
                    questionSet.add(getQuestion);
                }
            }

            if (isCheckBoxQuestion) {
                if (checkIfSetsAreEqual(questionSet, answerSet)) {
                    $("#saveAnswerForm").prop('disabled', true);
                    return true;
                } else {
                    swal(errorMessage, { icon: "warning" }).then((value) => {
                        $("#saveAnswerForm").prop('disabled', false);
                        formObj.submit.disabled = false;
                        $(".loadingImg").toggle(false);
                    });
                    return false;
                }
            } else {
                $("#saveAnswerForm").prop('disabled', true);
                return true;
            }
        }
	
        var response = '@TempData["Response"]';
        switch (response) {
            case "IndependentQuestionnaireSuccess":
                 $("#saveAnswerForm").prop('disabled', false);
                swal("Organisation Independent Questionnaire saved successfully", { icon: "success" })
                    .then((value) => {
                    var url = '@Url.Action("CreatePreliminaryAnalysis", "PreliminaryAnalysis")';
                    var new_url = url + "?id=" + '@ViewBag.PreliminaryAnalysisId';
                    window.location.replace(new_url);
                });
                break;
            case "IndependentQuestionnaireError":
                 $("#saveAnswerForm").prop('disabled', false);
                swal("An error occur during saving Organisation Independent Questionnaire, Please Contact System Support", { icon: "warning" })
                .then((value) => {
                    var url = '@Url.Action("CreatePreliminaryAnalysis", "PreliminaryAnalysis")';
                    var new_url = url + "?id=" + '@ViewBag.PreliminaryAnalysisId';
                    window.location.replace(new_url);
                });
                break;

            case "IndependentQuestionnaireValidationError":
                 $("#saveAnswerForm").prop('disabled', false);
                 swal("Please Answer all Organisation Independent Questionnaire", { icon: "warning" })
                .then((value) => {
                    var url = '@Url.Action("CreatePreliminaryAnalysis", "PreliminaryAnalysis")';
                    var new_url = url + "?id=" + '@ViewBag.PreliminaryAnalysisId';
                    window.location.replace(new_url);
                });
                break;
            case "SafeGuardQuestionnaireSuccess":
                 $("#saveAnswerForm").prop('disabled', false);
                 swal("Safe Guard Questionnaire saved successfully", { icon: "success" })
                     .then((value) => {
                    var url = '@Url.Action("CreatePreliminaryAnalysis", "PreliminaryAnalysis")';
                    var new_url = url + "?id=" + '@ViewBag.PreliminaryAnalysisId';
                    window.location.replace(new_url);
                });
                break;
            case "SafeGuardQuestionnaireError":
                 $("#saveAnswerForm").prop('disabled', false);
                 swal("An error occur during saving Safe Guard Questionnaire, Please Contact System Support", { icon: "warning" })
                .then((value) => {
                    var url = '@Url.Action("CreatePreliminaryAnalysis", "PreliminaryAnalysis")';
                    var new_url = url + "?id=" + '@ViewBag.PreliminaryAnalysisId';
                    window.location.replace(new_url);
                });
                break;

             case "SafeGuardValidationError":
                 $("#saveAnswerForm").prop('disabled', false);
                 swal("Please Answer all Safe Guard Questionnaire", { icon: "warning" })
                     .then((value) => {
                    var url = '@Url.Action("CreatePreliminaryAnalysis", "PreliminaryAnalysis")';
                    var new_url = url + "?id=" + '@ViewBag.PreliminaryAnalysisId';
                    window.location.replace(new_url);
                });
                break;

            case "EngagementQuestionnaireSuccess":
                 $("#saveAnswerForm").prop('disabled', false);
                swal("General Preliminary Engagement Questionnaire saved successfully", { icon: "success" })
                .then((value) => {
                    var url = '@Url.Action("PreliminaryAnalysisList", "PreliminaryAnalysis")';
                    @*var new_url = url + "?id=" + '@ViewBag.PreliminaryAnalysisId';*@
                    window.location.replace(url);
                });
                break;
            case "EngagementQuestionnaireError":
                 $("#saveAnswerForm").prop('disabled', false);
                swal("An error occur during saving General Preliminary Engagement Questionnaire, Please Contact System Support", { icon: "warning" })
                .then((value) => {
                    var url = '@Url.Action("CreatePreliminaryAnalysis", "PreliminaryAnalysis")';
                    var new_url = url + "?id=" + '@ViewBag.PreliminaryAnalysisId';
                    window.location.replace(new_url);
                });
                break;

           case "EngagementActivitiesValidationError":
                 $("#saveAnswerForm").prop('disabled', false);
                swal("Please Answer all General Preliminary Engagement Questionnaire", { icon: "warning" })
                .then((value) => {
                    var url = '@Url.Action("CreatePreliminaryAnalysis", "PreliminaryAnalysis")';
                    var new_url = url + "?id=" + '@ViewBag.PreliminaryAnalysisId';
                    window.location.replace(new_url);
                });
                break;

            case "Error":
                 $("#saveAnswerForm").prop('disabled', false);
                swal("An error occur, Please Contact System Support", { iscon: "warning" })
                .then((value) => {
                    var url = '@Url.Action("CreatePreliminaryAnalysis", "PreliminaryAnalysis")';
                    var new_url = url + "?id=" + '@ViewBag.PreliminaryAnalysisId';
                    window.location.replace(new_url);
                });
                break;

        }
    </script>
}




