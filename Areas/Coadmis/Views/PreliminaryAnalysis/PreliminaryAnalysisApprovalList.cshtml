@{
    ViewBag.Title = "Preliminary Analysis Reviewed List";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style type="text/css">
    .loadingImg {
        display: none;
    }
    textarea {
        resize: none;
        width: 100%;
    }
    .redStar {
        color: red;
        font-size: 15px;
    }
</style>
<div id="content" style="margin: 5px;">
    <div class="row"></div>
    <!-- widget grid -->
    <section id="widget-grid" class="">
        <div class="row">
            <!-- NEW COL START -->
            <article class="col-sm-12 col-md-12 col-lg-12">

                <!-- Widget ID (each widget will need unique ID)-->
                <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false" data-widget-custombutton="false" data-widget-colorbutton="false" data-widget-deletebutton="false" data-widget-togglebutton="false">

                    <header>
                        <span class="widget-icon"> <i class="fa fa-edit"></i> </span>
                        <h2> @ViewBag.Title</h2>
                    </header>

                    <div>
                        <div class="row">
                            <div class="col-md-6">

                            </div>
                            <div class="col-md-6"></div>
                        </div>
                        <div class="widget-body " style="padding-top:10px;width:100%">
                            @Html.AntiForgeryToken()
                            <table class="table  table-bordered table-hover table-condensed" id="dataTableList">
                                <thead>
                                    <tr>
                                        <th style="text-align:right;width:4%">#</th>
                                        <th style="text-align:left;">Client Name</th>
                                        <th style="text-align:left;">Financial Year</th>
                                        <th>Is Questionnaire Full Answered</th>
                                        <th style="text-align:right;">Agreed Fee (VAT Inclusive)</th>
                                        <th>Status</th>
                                        <th style="text-align:center">Action</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>

                        </div>

                    </div>
                </div>
            </article>

        </div>
    </section>
    <div class="modal fade" id="PreliminaryAnalysisModel">
        <div class="modal-dialog">
            <div class="modal-content ">

                <div class="modal-header alert alert-info">
                    <a href="#" class="close" data-dismiss="modal">&times;</a>
                    <h3 class="modal-title">Approve Preliminary Analysis</h3>
                </div>
                @Html.AntiForgeryToken()
            <div class="modal-body">

                <div class="form-horizontal">
                    <div class="form-group">
                        <div class="col-md-3"> Remarks <span class="redStar">*</span>(<span style="font-weight:bold;" id="remarksCount">250</span>) </div>
                        <div class="col-md-8">
                            <textarea class="form-control" id="remarks" name="remarks" maxlength="250" rows="6"></textarea>
                        </div>
                    </div>
                </div>


                <div class="form-horizontal">
                    <div class="form-group">
                        <div class="col-md-3"> Attachment (<span style="font-weight:bold;">PDF Only</span>) </div>
                        <div class="col-md-8">
                            <input type="file" class="form-control" name="attachment" id="attachment" accept=".pdf" />
                        </div>
                    </div>
                </div>

            </div>
                <div class="modal-footer">
                    <div class="form-group">
                        <div class="col-md-3"></div>
                        <div class="col-md-4">
                            <input type="submit" value="Approve" class="btn btn-info" onclick="preliminaryAnalysisForm()" id="btnPreliminaryAnalysis" />
                            <input type="submit" value="Decline" class="btn btn-info" onclick="preliminaryAnalysisDeclineForm()" id="btnPreliminaryAnalysisDecline" />
                            <img src="~/Content/img/loading.gif" class="saveLoader" />
                        </div>
                        <div class="col-md-5"></div>
                    </div>

                </div>
            </div>

        </div>

    </div>
</div>

@section pagespecific {
    <!-- PAGE RELATED PLUGIN(S) -->
    <script type="text/javascript">
        $(document).ajaxStart(function () {
            $(".loadingImg").show();

        });
        //HIDE LOADER ICON
        $(document).ajaxStop(function () {
            $(".loadingImg").hide();
        });

        $(document).ready(function () {
            $(".saveLoader").toggle(false);
            BindDataTable();
        });

        $('#remarks').on("keyup", function () {
            var count = $('#remarks').val().split('');
            var numChars = 250 - parseInt(count.length);
            $('#remarksCount').text(parseInt(numChars));
        });

        var BindDataTable = function (response) {

            $("#dataTableList").DataTable({
                "bServerSide": true,
                "sAjaxSource": '@Url.Action("GetPreliminaryAnalysisApprovalList", "PreliminaryAnalysis")',
                "iDisplayLength": 10,
                "aLengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
                "fnServerData": function (sSource, aoData, fnCallback) {
                    $.ajax({
                        type: "Get",
                        data: aoData,
                        url: sSource,
                        success: fnCallback
                    })
                },
                "aoColumns": [
                    {
                        render: function (data, type, row, meta) {
                            return meta.row + meta.settings._iDisplayStart + 1;
                        }
                    },
                    { "mData": "ClientName"},
                    { "mData": "FinancialYearName" },
                    {
                        "mData": "IsQuestionnaireFullAnswered",
                        "render": function (IsQuestionnaireFullAnswered) {
                            var getAnswer = null;
                            if (IsQuestionnaireFullAnswered) {
                                getAnswer = "YES";
                            } else {
                                getAnswer = "NO";
                            }
                            return getAnswer;
                        }
                    },
                    {
                        "mData": "AgreedAmount",
                        "render": function (AgreedAmount, type, full, meta) {
                            var amount = null;
                            if (AgreedAmount == null) {
                                amount = "<p align='right'>0</p>";
                            }
                            else {
                                amount = "<p align='right'>" + AgreedAmount.toLocaleString() + "</p>";
                            }
                            return amount;
                        }
                    },
                    { "mData": "OverallStatus" },
                    {
                        "mData": "PreliminaryAnalysisId",
                        "render": function (PreliminaryAnalysisId, type, full, meta) {
                               return '<div class="btn-group" id="drop">\
                                <button type="button" class="btn btn-info btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\
                                <span class="caret"></span\
                                <span class="sr-only"></span>\
                                </button>\
                                <ul class="dropdown-menu dropdown-menu-right">\
                                    <li><a class="dropdown-item" href="@Url.Action("PreliminaryAnalysisDetails", "PreliminaryAnalysis")/?id=' + PreliminaryAnalysisId + '">Details</a></li>\
                                    <li><a href="#" onclick="approvePreliminaryAnalysisForm('+ PreliminaryAnalysisId+')">Approve</a></li>\
                                </ul>\
                            </div>\ ';
                        }
                    },
                ]
            });
        }

    var preliminaryAnalysisId = null;
    function approvePreliminaryAnalysisForm(id) {
        preliminaryAnalysisId = id;
        $('#PreliminaryAnalysisModel').modal('show');
    }

  function preliminaryAnalysisForm() {
      var remarks = $("#remarks").val();
      var attachment = $("#attachment").val();
  successMessage = "Preliminary Analysis Approved Successfully";
  failureMessage = "Error in Approving Preliminary Analysis";

  if (remarks == '') {
      swal("Please Add Remarks");
       $(".loadingImg").hide();
       $("#btnPreliminaryAnalysis").prop('disabled', false);
       $(".saveLoader").toggle(false);
        return false;
    }

    if (attachment != '') {
        $("#conceptNoteStatus").prop('disabled', false);
        $(".loadingImg").hide();
        $("#btnPreliminaryAnalysis").prop('disabled', false);
        $(".saveLoader").toggle(false);
        var file = document.querySelector("#attachment");
        if (/\.(pdf)$/i.test(file.files[0].name) === false) {
            swal("Please Upload Attachment (PDF Format)");
            return false;
        }
    }

    var formData = new FormData()
    formData.append('__RequestVerificationToken', $('[name=__RequestVerificationToken]').val());
    formData.append('id', preliminaryAnalysisId);
    formData.append('remarks', remarks);
    if (attachment != '') {
        formData.append('attachment', $("#attachment")[0].files[0]);
    }
    swal({
        text: "Approve Preliminary Analysis?",
        buttons: [
          'No',
          'Yes'
        ],
    }).then(function (isConfirm) {
        if (isConfirm) {
            postApproveFormData(formData);
        } else {
            swal("Cancelled", "No change was made");
            $("#btnPreliminaryAnalysis").prop('disabled', false);
        }
    });
        }

  function postApproveFormData(formData) {
        $(".loadingImg").show();
        $("#btnPreliminaryAnalysis").prop('disabled', true);
        $(".saveLoader").toggle(true);
        var url = '@Url.Action("ApprovePreliminaryAnalysis", "PreliminaryAnalysis")';
        $.ajax({
            url: url,
            data: formData,
            type: 'POST',
            contentType: false,
            processData: false,
            success: function (response) {
                $('#PreliminaryAnalysisModel').modal('hide');
                $("#btnPreliminaryAnalysis").prop('disabled', true);
                $(".saveLoader").toggle(true);
                if (response == "Success") {
                    swal(successMessage, { icon: "success" })
                        .then((m) => {
                            window.location.reload();
                        });
                } else {
                    $("#btnPreliminaryAnalysis").prop('disabled', false);
                    $(".saveLoader").toggle(false);
                    swal(failureMessage + ": " + response, { icon: "warning" });
                }
            },
            failure: function (error) {
                $("#btnPreliminaryAnalysis").prop('disabled', false);
                $(".saveLoader").toggle(false);
                swal(failureMessage, { icon: "warning" });
            }
        });
    }

      function preliminaryAnalysisDeclineForm() {
  var remarks = $("#remarks").val();
  successMessage = "Preliminary Analysis Declined Successfully";
  failureMessage = "Error in Declining Preliminary Analysis";

  if (remarks == '') {
      swal("Please Add Remarks");
       $(".loadingImg").hide();
       $("#btnPreliminaryAnalysisDecline").prop('disabled', false);
       $(".saveLoader").toggle(false);
        return false;
    }

    var formData = new FormData()
    formData.append('__RequestVerificationToken', $('[name=__RequestVerificationToken]').val());
    formData.append('id', preliminaryAnalysisId);
    formData.append('remarks', remarks);
    formData.append('currentStatus', 'Declined');
    swal({
        text: "Decline Preliminary Analysis?",
        buttons: [
          'No',
          'Yes'
        ],
    }).then(function (isConfirm) {
        if (isConfirm) {
            postDeclineFormData(formData);
        } else {
            swal("Cancelled", "No change was made");
            $("#btnPreliminaryAnalysisDecline").prop('disabled', false);
        }
    });
        }

  function postDeclineFormData(formData) {
        $(".loadingImg").show();
        $("#btnPreliminaryAnalysisDecline").prop('disabled', true);
        $(".saveLoader").toggle(true);
        var url = '@Url.Action("DeclinePreliminaryAnalysis", "PreliminaryAnalysis")';
        $.ajax({
            url: url,
            data: formData,
            type: 'POST',
            contentType: false,
            processData: false,
            success: function (response) {
                $('#PreliminaryAnalysisModel').modal('hide');
                $("#btnPreliminaryAnalysisDecline").prop('disabled', true);
                $(".saveLoader").toggle(true);
                if (response == "Success") {
                    swal(successMessage, { icon: "success" })
                        .then((m) => {
                            window.location.reload();
                        });
                } else {
                    $("#btnPreliminaryAnalysisDecline").prop('disabled', false);
                    $(".saveLoader").toggle(false);
                    swal(failureMessage + ": " + response, { icon: "warning" });
                }
            },
            failure: function (error) {
                $("#btnPreliminaryAnalysisDecline").prop('disabled', false);
                $(".saveLoader").toggle(false);
                swal(failureMessage, { icon: "warning" });
            }
        });
    }
    </script>
}




